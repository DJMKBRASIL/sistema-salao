<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão do Salão</title>
    
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF CDN for PDF generation (used by Fechamento Semanal) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut, 
            setPersistence, 
            browserLocalPersistence 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            deleteDoc, 
            collection, 
            query, 
            where, 
            getDocs, 
            addDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração do Firebase (usando as credenciais fornecidas ou placeholders)
        // ATENÇÃO CRÍTICA: Substitua "YOUR_API_KEY", "YOUR_AUTH_DOMAIN", etc., pelas suas credenciais reais do Firebase.
        // O login NÃO funcionará sem essas credenciais.
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY", 
            authDomain: "YOUR_AUTH_DOMAIN", 
            projectId: "YOUR_PROJECT_ID",   
            storageBucket: "YOUR_STORAGE_BUCKET", 
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID", 
            appId: "YOUR_APP_ID", 
        };

        // Verificação para alertar se as credenciais ainda são placeholders
        if (window.firebaseConfig.apiKey === "YOUR_API_KEY") {
            console.error("ERRO DE CONFIGURAÇÃO DO FIREBASE: As credenciais do Firebase ainda são placeholders. Por favor, substitua-as pelas suas credenciais reais do projeto Firebase para que o login funcione.");
            alert("ERRO: As credenciais do Firebase não estão configuradas. O login não funcionará. Por favor, verifique o código e insira suas credenciais.");
        }

        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Variáveis globais do Firebase
        window.app = null;
        window.db = null;
        window.auth = null;
        window.userId = 'Carregando...'; 
        window.fichasCollectionRef = null; // Referência para a coleção de fichas
        window.productsCollectionRef = null; // Referência para a coleção de produtos do estoque

        /**
         * Inicializa o Firebase e configura o listener de autenticação.
         */
        async function initializeFirebase() {
            try {
                window.app = initializeApp(window.firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);
                
                await setPersistence(window.auth, browserLocalPersistence);
                console.log("Firebase inicializado com sucesso");

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        const authMethod = user.isAnonymous ? 'Anônimo' : 'Google';
                        const displayInfo = user.displayName ? `${user.displayName} (${authMethod})` : `${window.userId} (${authMethod})`;
                        
                        document.getElementById('user-id-display').textContent = `Usuário: ${displayInfo}`;
                        document.getElementById('auth-buttons').innerHTML = `
                            <button onclick="window.unifiedApp.signOutUser()" class="btn btn-danger">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                </svg>
                                Sair
                            </button>
                        `;
                        
                        console.log("Usuário autenticado:", window.userId, "Método:", authMethod);
                        // Define as referências de coleção após a autenticação
                        window.fichasCollectionRef = collection(window.db, `artifacts/${window.appId}/users/${window.userId}/fichas`);
                        window.productsCollectionRef = collection(window.db, `artifacts/${window.appId}/users/${window.userId}/products`);

                        if (window.db) {
                            // Inicializa a aplicação unificada APENAS UMA VEZ após a autenticação
                            window.unifiedApp.init(); 
                        } else {
                            console.error("Banco de dados Firebase não disponível após autenticação.");
                            window.unifiedApp.showMessage('Erro: Banco de dados não disponível após autenticação. Recarregue a página.', 'error');
                        }
                    } else {
                        window.userId = 'Não autenticado';
                        document.getElementById('user-id-display').textContent = `Usuário: ${window.userId}`;
                        document.getElementById('auth-buttons').innerHTML = `
                            <button onclick="window.unifiedApp.signInWithGoogle()" class="btn btn-primary">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                Entrar com Google
                            </button>
                        `;
                        
                        // Desabilitar botões que dependem de autenticação completa
                        window.unifiedApp.disableAuthRequiredButtons();
                    }
                });

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                window.unifiedApp.showMessage('Erro ao inicializar o Firebase. Verifique a configuração.', 'error');
            }
        }

        // Chamar a inicialização do Firebase quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', initializeFirebase);

        // Expondo as funções do Firestore SDK globalmente para uso em todos os módulos
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.addDoc = addDoc; 
    </script>

    <style>
        /* Variáveis CSS para cores e sombras */
        :root {
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --border-radius: 0.75rem;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Reset básico e fontes */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            line-height: 1.6;
        }

        /* Estilo do container principal */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
        }

        /* Animação de entrada */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Estilo do cabeçalho */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Estilo da navegação por abas */
        .tab-nav {
            display: flex;
            justify-content: center;
            background-color: var(--gray-100);
            border-bottom: 1px solid var(--gray-200);
        }

        .tab-button {
            padding: 1rem 1.5rem;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            text-decoration: none; /* Remove sublinhado padrão */
        }

        .tab-button:hover {
            color: var(--primary-color);
            background-color: var(--gray-200);
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background-color: white;
        }

        /* Conteúdo principal e seções */
        .content {
            padding: 2rem;
        }

        .tab-content {
            display: none; /* Esconde o conteúdo das abas por padrão */
        }

        .tab-content.active {
            display: block; /* Mostra o conteúdo da aba ativa */
        }

        .section {
            background: var(--gray-50);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--gray-200);
            transition: var(--transition);
        }

        .section:hover {
            box-shadow: var(--shadow-md);
        }

        .section-header {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-800);
            margin: 0;
        }

        /* Estilos de botões */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            min-height: 44px; /* Touch-friendly minimum */
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #7c3aed;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #059669;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background-color: #d97706;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-gray {
            background-color: var(--gray-300);
            color: var(--gray-800);
        }

        .btn-gray:hover:not(:disabled) {
            background-color: var(--gray-400);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-full {
            width: 100%;
        }

        /* Estilos de formulário */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: var(--transition);
            background-color: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-input::-webkit-outer-spin-button,
        .form-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .form-input[type=number] {
            -moz-appearance: textfield;
        }

        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: var(--transition);
            background-color: white;
            resize: vertical;
            min-height: 80px;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Layout de grid e flexbox */
        .grid {
            display: grid;
            gap: 1rem;
        }

        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .flex-wrap {
            flex-wrap: wrap;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-3 {
            gap: 0.75rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        /* Margens e paddings */
        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .p-4 {
            padding: 1rem;
        }

        /* Alinhamento de texto */
        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        /* Tamanhos de texto e pesos de fonte */
        .text-sm {
            font-size: 0.875rem;
        }

        .text-lg {
            font-size: 1.125rem;
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .font-medium {
            font-weight: 500;
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-bold {
            font-weight: 700;
        }

        /* Cores de texto */
        .text-gray-500 {
            color: var(--gray-500);
        }

        .text-gray-600 {
            color: var(--gray-600);
        }

        .text-gray-700 {
            color: var(--gray-700);
        }

        .text-gray-800 {
            color: var(--gray-800);
        }

        /* Blocos específicos da aplicação */
        .collaborator-block {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        .collaborator-block:hover {
            box-shadow: var(--shadow-md);
        }

        .client-row, .service-row, .product-sold-row, .product-row {
            background: var(--gray-50);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--gray-200);
        }

        .observation-area {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }

        .observation-area.visible {
            display: block;
        }

        /* Mensagens de feedback */
        .message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 500;
            animation: slideInDown 0.3s ease-out;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .message-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .message-info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        /* Modais */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            padding: 1rem;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow-xl);
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .saved-reports-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .report-item {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .report-item:last-child {
            border-bottom: none;
        }

        .report-item:hover {
            background-color: var(--gray-50);
        }

        .report-item.selected {
            background-color: #e0e7ff;
            font-weight: 600;
        }

        /* Spinner de carregamento */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Estilos responsivos */
        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }

            .header {
                padding: 1.5rem 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .content {
                padding: 1rem;
            }

            .section {
                padding: 1rem;
            }

            .grid-cols-3, .grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }

            .flex {
                flex-direction: column;
            }

            .flex > * {
                width: 100%;
            }

            .btn {
                padding: 1rem;
                font-size: 1rem;
            }

            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }

            .modal-buttons {
                flex-direction: column;
            }

            .tab-nav {
                flex-direction: column;
            }

            .tab-button {
                border-bottom: none;
                border-left: 3px solid transparent;
            }

            .tab-button.active {
                border-bottom-color: transparent;
                border-left-color: var(--primary-color);
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.75rem;
            }

            .section-title {
                font-size: 1.25rem;
            }

            .collaborator-block {
                padding: 1rem;
            }

            .client-row, .service-row, .product-sold-row, .product-row {
                padding: 0.5rem;
            }
        }

        /* Estilos de impressão */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .main-container {
                box-shadow: none;
                border-radius: 0;
            }

            .header, .tab-nav {
                display: none !important; /* Esconde cabeçalho e navegação na impressão */
            }

            .btn,
            .modal {
                display: none !important;
            }

            .tab-content {
                display: block !important; /* Garante que todo o conteúdo seja impresso */
            }

            .section {
                border: none;
                box-shadow: none;
                margin-bottom: 1rem;
                padding: 0;
            }
        }

        /* Suporte a modo de alto contraste */
        @media (prefers-contrast: high) {
            .section {
                border: 2px solid var(--gray-400);
            }

            .btn {
                border: 2px solid currentColor;
            }
        }

        /* Suporte a movimento reduzido */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <header class="header">
            <h1>Sistema de Gestão do Salão</h1>
            <p style="font-size: 1.2rem; margin-top: 0.5rem; opacity: 0.9;">Tudo em um só lugar!</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="tab-nav">
            <a href="#fechamento-semanal" class="tab-button active" data-tab="fechamento-semanal-app">Fechamento Semanal</a>
            <a href="#fichas-clientes" class="tab-button" data-tab="fichas-clientes-app">Fichas de Cliente</a>
            <a href="#controle-estoque" class="tab-button" data-tab="controle-estoque-app">Controle de Estoque</a>
        </nav>

        <!-- Main Content Area -->
        <main class="content">
            <!-- User Authentication Section (Common to all apps) -->
            <div class="section">
                <div class="flex items-center justify-between mb-4">
                    <p id="user-id-display" class="text-sm text-gray-500">Usuário: Carregando...</p>
                    <div id="auth-buttons" class="flex gap-2">
                        <!-- Authentication buttons will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Area for feedback messages (Common to all apps) -->
            <div id="app-message" class="message" style="display: none;"></div>

            <!-- Fechamento Semanal Tab Content -->
            <div id="fechamento-semanal-app" class="tab-content active">
                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">Informações do Fechamento</h2>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Data do Fechamento Semanal</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="form-group">
                                <label for="day" class="form-label">Dia</label>
                                <input type="number" id="day" min="1" max="31" placeholder="Dia" class="form-input" oninput="window.unifiedApp.salonApp.updateDateDisplay(); window.unifiedApp.salonApp.saveLocalData()">
                            </div>
                            <div class="form-group">
                                <label for="month" class="form-label">Mês</label>
                                <select id="month" class="form-input" onchange="window.unifiedApp.salonApp.updateDateDisplay(); window.unifiedApp.salonApp.saveLocalData()">
                                    <option value="">Selecione o Mês</option>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Março</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="year" class="form-label">Ano</label>
                                <input type="number" id="year" min="2000" max="2100" placeholder="Ano" class="form-input" oninput="window.unifiedApp.salonApp.updateDateDisplay(); window.unifiedApp.salonApp.saveLocalData()">
                            </div>
                        </div>
                        <p id="dateDisplay" class="text-center text-lg font-medium text-gray-800 mt-4"></p>
                    </div>

                    <div class="mt-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Opções de Dados</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="window.unifiedApp.salonApp.exportDataToFile()" class="btn btn-secondary btn-full">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Exportar Dados
                            </button>
                            <button onclick="window.unifiedApp.salonApp.importDataFromFile()" class="btn btn-secondary btn-full">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                </svg>
                                Importar Dados
                            </button>
                            <button id="saveToFirestoreBtn" onclick="window.unifiedApp.salonApp.saveWeeklyClosingToFirestore()" class="btn btn-success btn-full" disabled>
                                <span id="save-spinner" class="loading-spinner mr-2 hidden"></span>
                                <svg id="save-icon" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                Salvar na Nuvem
                            </button>
                            <button id="loadFromFirestoreBtn" onclick="window.unifiedApp.salonApp.openSavedReportsModal()" class="btn btn-warning btn-full" disabled>
                                <span id="load-spinner" class="loading-spinner mr-2 hidden"></span>
                                <svg id="load-icon" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                </svg>
                                Carregar da Nuvem
                            </button>
                            <button id="loadDataFromFichasSystemBtn" onclick="window.unifiedApp.salonApp.loadDataFromFichasSystem()" class="btn btn-info btn-full" disabled>
                                <span id="fichas-spinner" class="loading-spinner mr-2 hidden"></span>
                                <svg id="fichas-icon" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                                </svg>
                                Importar das Fichas
                            </button>
                            <button id="clearAllDataBtn" onclick="window.unifiedApp.salonApp.showClearConfirm()" class="btn btn-gray btn-full" disabled>
                                <span id="clear-spinner" class="loading-spinner mr-2 hidden"></span>
                                <svg id="clear-icon" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Limpar Tudo
                            </button>
                        </div>
                    </div>
                </section>

                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">Colaboradoras</h2>
                    </div>
                    <div id="collaborators-container">
                        <!-- Blocos de colaboradoras serão adicionados dinamicamente aqui -->
                    </div>
                    <button onclick="window.unifiedApp.salonApp.addCollaborator()" class="btn btn-primary btn-full mt-4">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Adicionar Colaboradora
                    </button>
                </section>

                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">Produtos Vendidos</h2>
                    </div>
                    <div id="products-container">
                        <!-- Linhas de produtos serão adicionadas dinamicamente aqui -->
                    </div>
                    <button onclick="window.unifiedApp.salonApp.addProductRow()" class="btn btn-success btn-full mt-4">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Adicionar Produto
                    </button>
                    <div class="mt-4 text-right">
                        <p class="text-lg font-bold text-gray-800">Total Produtos: <span id="products-total">R$ 0,00</span></p>
                    </div>
                </section>

                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">Resumo Geral</h2>
                    </div>
                    <div class="text-right mb-4">
                        <p class="text-lg font-bold text-gray-800">Total Bruto Geral: <span id="overall-gross-total">R$ 0,00</span></p>
                        <p class="text-lg font-bold text-red-600">Total Desconto Cartão: <span id="total-card-discount">R$ 0,00</span></p>
                        <p class="text-lg font-bold text-gray-800">Lucro Líquido do Salão: <span id="overall-net-total">R$ 0,00</span></p>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Detalhes da Contribuição:</h3>
                        <div id="detailed-contribution" class="text-gray-700">
                            <!-- Detalhes da contribuição serão preenchidos aqui -->
                        </div>
                    </div>
                </section>

                <button onclick="window.unifiedApp.salonApp.generatePDF()" class="btn btn-secondary btn-full text-lg font-bold">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Gerar PDF do Fechamento
                </button>
            </div>

            <!-- Fichas de Cliente Tab Content -->
            <div id="fichas-clientes-app" class="tab-content">
                <section class="section">
                    <h2 class="section-title">Nova Ficha de Atendimento</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="clientName" class="form-label">Nome da Cliente</label>
                            <input type="text" id="clientName" placeholder="Nome Completo da Cliente" class="form-input" oninput="window.unifiedApp.fichasApp.saveLocalData()">
                        </div>
                        <div>
                            <label for="professionalName" class="form-label">Nome da Profissional</label>
                            <input type="text" id="professionalName" placeholder="Nome da Profissional" class="form-input" oninput="window.unifiedApp.fichasApp.saveLocalData()">
                        </div>
                    </div>

                    <div class="mt-4">
                        <h3 class="text-md font-medium text-gray-700 mb-2">Serviços</h3>
                        <div id="services-container">
                            <!-- Service rows will be added dynamically here -->
                        </div>
                        <button onclick="window.unifiedApp.fichasApp.addServiceRow()" class="btn btn-primary btn-full mt-2">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Adicionar Serviço
                        </button>
                    </div>

                    <div class="mt-4">
                        <h3 class="text-md font-medium text-gray-700 mb-2">Produtos Vendidos (Opcional)</h3>
                        <div id="products-sold-container">
                            <!-- Products sold rows will be added dynamically here -->
                        </div>
                        <button onclick="window.unifiedApp.fichasApp.addProductSoldRow()" class="btn btn-success btn-full mt-2">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Adicionar Produto
                        </button>
                    </div>

                    <div class="mt-6 flex justify-end">
                        <button id="addFichaBtn" onclick="window.unifiedApp.fichasApp.addFicha()" class="btn btn-primary text-lg font-bold" disabled>
                            <span id="add-ficha-spinner" class="loading-spinner mr-2 hidden"></span>
                            <svg id="add-ficha-icon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Registrar Ficha
                        </button>
                    </div>
                </section>

                <section class="section">
                    <h2 class="section-title">Fichas Registradas</h2>
                    <div id="fichas-list" class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Cliente</th>
                                    <th class="py-3 px-6 text-left">Profissional</th>
                                    <th class="py-3 px-6 text-left">Serviços</th>
                                    <th class="py-3 px-6 text-left">Produtos</th>
                                    <th class="py-3 px-6 text-center">Total Ficha</th>
                                    <th class="py-3 px-6 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light" id="fichas-table-body">
                                <!-- Fichas will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-6 flex flex-col sm:flex-row gap-3">
                        <button id="clearAllFichasBtn" onclick="window.unifiedApp.fichasApp.showClearAllFichasConfirm()" class="btn btn-danger btn-full" disabled>
                            <span id="clear-fichas-spinner" class="loading-spinner mr-2 hidden"></span>
                            <svg id="clear-fichas-icon" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Limpar Todas as Fichas
                        </button>
                        <button id="exportWeeklyDataBtn" onclick="window.unifiedApp.fichasApp.generateAndExportWeeklyData()" class="btn btn-secondary btn-full" disabled>
                            <span id="export-weekly-spinner" class="loading-spinner mr-2 hidden"></span>
                            <svg id="export-weekly-icon" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7m-4 2l4-4m0 0l-4-4m4 4H7"></path>
                            </svg>
                            Exportar Dados para Fechamento Semanal
                        </button>
                    </div>
                </section>

                <section class="section">
                    <h2 class="section-title">Opções de Arquivo Local</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button onclick="window.unifiedApp.fichasApp.exportDataToFile()" class="btn btn-info btn-full">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Exportar Fichas (JSON)
                        </button>
                        <button onclick="window.unifiedApp.fichasApp.importDataFromFile()" class="btn btn-info btn-full">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                            </svg>
                            Importar Fichas (JSON)
                        </button>
                    </div>
                </section>
            </div>

            <!-- Controle de Estoque Tab Content -->
            <div id="controle-estoque-app" class="tab-content">
                <section class="section">
                    <h2 class="section-title">Cadastrar Novo Produto</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="productName" class="form-label">Nome do Produto</label>
                            <input type="text" id="productName" placeholder="Ex: Tintura, Shampoo, Papel Higiênico" class="form-input" oninput="window.unifiedApp.productInventoryApp.saveLocalData()">
                        </div>
                        <div>
                            <label for="productQuantity" class="form-label">Quantidade</label>
                            <input type="number" id="productQuantity" min="0" value="0" class="form-input text-right" oninput="window.unifiedApp.productInventoryApp.saveLocalData()">
                        </div>
                        <div>
                            <label for="productUnitValue" class="form-label">Valor Unitário (R$)</label>
                            <input type="number" step="0.01" min="0" id="productUnitValue" placeholder="0.00 (Opcional)" class="form-input text-right" oninput="window.unifiedApp.productInventoryApp.saveLocalData()">
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end">
                        <button id="addProductBtn" onclick="window.unifiedApp.productInventoryApp.addProduct()" class="btn btn-primary text-lg font-bold" disabled>
                            <span id="add-product-spinner" class="loading-spinner mr-2 hidden"></span>
                            <svg id="add-product-icon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Adicionar Produto
                        </button>
                    </div>
                </section>

                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">Estoque de Produtos</h2>
                        <p class="text-lg font-bold text-gray-800">Valor Total do Estoque: <span id="total-inventory-value">R$ 0,00</span></p>
                    </div>
                    
                    <div id="products-list" class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Produto</th>
                                    <th class="py-3 px-6 text-center">Quantidade</th>
                                    <th class="py-3 px-6 text-right">Valor Unitário</th>
                                    <th class="py-3 px-6 text-right">Valor Total</th>
                                    <th class="py-3 px-6 text-center">Status</th>
                                    <th class="py-3 px-6 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light" id="products-table-body">
                                <!-- Products will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-6 flex flex-col sm:flex-row gap-3">
                        <button id="clearAllProductsBtn" onclick="window.unifiedApp.productInventoryApp.showClearAllProductsConfirm()" class="btn btn-danger btn-full" disabled>
                            <span id="clear-products-spinner" class="loading-spinner mr-2 hidden"></span>
                            <svg id="clear-products-icon" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Limpar Todos os Produtos
                        </button>
                    </div>
                </section>

                <section class="section">
                    <h2 class="section-title">Opções de Arquivo Local</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button onclick="window.unifiedApp.productInventoryApp.exportDataToFile()" class="btn btn-info btn-full">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Exportar Estoque (JSON)
                        </button>
                        <button onclick="window.unifiedApp.productInventoryApp.importDataFromFile()" class="btn btn-info btn-full">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                            </svg>
                            Importar Estoque (JSON)
                        </button>
                    </div>
                </section>

                <section class="section">
                    <h2 class="section-title">Opções da Nuvem (Firebase)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button id="saveToCloudBtn" onclick="window.unifiedApp.productInventoryApp.saveAllProductsToFirestore()" class="btn btn-success btn-full" disabled>
                            <span id="save-cloud-spinner" class="loading-spinner mr-2 hidden"></span>
                            <svg id="save-cloud-icon" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            Salvar na Nuvem
                        </button>
                        <button id="loadFromCloudBtn" onclick="window.unifiedApp.productInventoryApp.loadProductsFromFirestore()" class="btn btn-warning btn-full" disabled>
                            <span id="load-cloud-spinner" class="loading-spinner mr-2 hidden"></span>
                            <svg id="load-cloud-icon" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                            </svg>
                            Carregar da Nuvem
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal de Confirmação Personalizado (Unificado) -->
    <div id="custom-confirm-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Confirmar Ação</h3>
            <p class="text-gray-600 mb-4" id="confirm-message">Tem certeza que deseja continuar?</p>
            <p class="text-sm text-gray-500 mb-6">Esta ação não pode ser desfeita.</p>
            <div class="modal-buttons">
                <button class="btn btn-gray" onclick="window.unifiedApp.handleConfirm(false)">Cancelar</button>
                <button class="btn btn-danger" onclick="window.unifiedApp.handleConfirm(true)">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Relatórios Salvos (Apenas para Fechamento Semanal) -->
    <div id="saved-reports-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Escolha um Fechamento Salvo</h3>
            <div id="saved-reports-list" class="saved-reports-list">
                <!-- Lista de relatórios salvos será carregada aqui -->
            </div>
            <div class="modal-buttons">
                <button class="btn btn-gray" onclick="window.unifiedApp.salonApp.closeSavedReportsModal()">Fechar</button>
                <button class="btn btn-primary" onclick="window.unifiedApp.salonApp.loadSelectedReport()">Carregar Selecionado</button>
            </div>
        </div>
    </div>

    <!-- Novo Modal para Anexar Comprovante (Apenas para Fechamento Semanal) -->
    <div id="attach-receipt-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Anexar Comprovante?</h3>
            <p class="text-gray-600 mb-4">Deseja anexar um comprovante de pagamento ao PDF desta colaboradora?</p>
            <div class="modal-buttons">
                <button class="btn btn-gray" onclick="window.unifiedApp.salonApp.handleAttachReceiptChoice(false)">Não, gerar sem comprovante</button>
                <button class="btn btn-primary" onclick="window.unifiedApp.salonApp.handleAttachReceiptChoice(true)">Sim, anexar comprovante</button>
            </div>
        </div>
    </div>

    <script>
        // Objeto principal da aplicação unificada
        window.unifiedApp = {
            activeTab: 'fechamento-semanal-app', // Aba ativa por padrão
            confirmAction: null, // Ação pendente para o modal de confirmação
            reportToDeleteId: null, // ID do relatório a ser excluído (para Fechamento Semanal)

            /**
             * Inicializa a aplicação unificada e seus módulos.
             */
            init() {
                console.log("Unified App inicializado.");
                this.setupTabListeners();
                // Chama showTab para a aba inicial, que por sua vez inicializará o módulo correspondente.
                this.showTab(this.activeTab); 
                this.enableButtons(); // Habilita botões que dependem de autenticação
            },

            /**
             * Configura os listeners para os botões de aba.
             */
            setupTabListeners() {
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        const tabId = event.target.dataset.tab;
                        this.showTab(tabId);
                    });
                });
            },

            /**
             * Mostra a aba selecionada e inicializa seu módulo.
             * @param {string} tabId - O ID da aba a ser mostrada.
             */
            showTab(tabId) {
                // Remove a classe 'active' de todos os botões e conteúdos
                document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                // Adiciona a classe 'active' ao botão e conteúdo da aba selecionada
                document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
                document.getElementById(tabId).classList.add('active');

                this.activeTab = tabId;
                console.log(`Aba ativa: ${this.activeTab}`);

                // Inicializa o módulo correspondente à aba ativa
                // Isso garante que o init de cada módulo seja chamado quando sua aba é ativada
                switch (tabId) {
                    case 'fechamento-semanal-app': // Corrigido o ID da aba
                        this.salonApp.init();
                        break;
                    case 'fichas-clientes-app': // Corrigido o ID da aba
                        this.fichasApp.init();
                        break;
                    case 'controle-estoque-app': // Corrigido o ID da aba
                        this.productInventoryApp.init();
                        break;
                }
            },

            /**
             * Habilita os botões que requerem autenticação em todos os módulos.
             */
            enableButtons() {
                this.salonApp.enableButtons();
                this.fichasApp.enableButtons();
                this.productInventoryApp.enableButtons();
            },

            /**
             * Desabilita os botões que requerem autenticação em todos os módulos.
             */
            disableAuthRequiredButtons() {
                this.salonApp.disableAuthRequiredButtons();
                this.fichasApp.disableAuthRequiredButtons();
                this.productInventoryApp.disableAuthRequiredButtons();
            },

            // --- Funções de Autenticação (Unificadas) ---
            /**
             * Função para fazer login com o Google.
             */
            async signInWithGoogle() {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(window.auth, provider);
                    this.showMessage('Autenticado com Google!', 'success');
                } catch (error) {
                    console.error("Erro ao autenticar com Google:", error);
                    this.showMessage('Erro ao autenticar com Google: ' + error.message, 'error');
                }
            },

            /**
             * Função para fazer logout do usuário.
             */
            async signOutUser() {
                try {
                    await signOut(window.auth);
                    this.showMessage('Sessão encerrada.', 'info');
                    // Limpar dados locais de todos os módulos ao sair
                    this.salonApp.clearAllData();
                    this.fichasApp.fichas = [];
                    this.fichasApp.renderFichasTable();
                    this.fichasApp.clearInputFields();
                    this.productInventoryApp.products = [];
                    this.productInventoryApp.renderProductsTable();
                    this.productInventoryApp.clearInputFields();

                    this.disableAuthRequiredButtons();
                } catch (error) {
                    console.error("Erro ao sair:", error);
                    this.showMessage('Erro ao sair: ' + error.message, 'error');
                }
            },
            // --- Fim Funções de Autenticação ---

            // --- Helper Functions for Messages and Modals (Unificadas) ---
            /**
             * Exibe uma mensagem na interface.
             * @param {string} message - A mensagem a ser exibida.
             * @param {string} type - O tipo da mensagem ('success', 'error', 'info').
             */
            showMessage(message, type = 'success') {
                const msgDiv = document.getElementById('app-message');
                msgDiv.textContent = message;
                msgDiv.classList.remove('hidden', 'message-error', 'message-success', 'message-info');
                if (type === 'success') {
                    msgDiv.classList.add('message-success');
                } else if (type === 'error') {
                    msgDiv.classList.add('message-error');
                } else if (type === 'info') {
                    msgDiv.classList.add('message-info');
                }
                msgDiv.style.display = 'block'; 
                setTimeout(() => {
                    msgDiv.style.display = 'none';
                }, 5000);
            },

            /**
             * Mostra o modal de confirmação genérico.
             * @param {string} message - A mensagem a ser exibida no modal.
             * @param {string} actionType - O tipo de ação a ser confirmada (ex: 'clearAllData', 'clearAllFichas', 'clearAllProducts', 'deleteSavedReport').
             * @param {string|null} itemId - O ID do item a ser afetado, se aplicável.
             */
            showConfirmModal(message, actionType, itemId = null) {
                document.getElementById('confirm-message').textContent = message;
                document.getElementById('custom-confirm-modal').style.display = 'flex';
                this.confirmAction = actionType;
                this.reportToDeleteId = itemId; // Reutiliza para qualquer ID de item
            },

            /**
             * Lida com a resposta do modal de confirmação.
             * @param {boolean} confirmed - True se a ação foi confirmada, false caso contrário.
             */
            handleConfirm(confirmed) {
                document.getElementById('custom-confirm-modal').style.display = 'none';
                if (confirmed) {
                    switch (this.confirmAction) {
                        case 'clearAllData':
                            this.salonApp.clearAllDataFromFirestoreAndLocal();
                            break;
                        case 'clearAllFichas':
                            this.fichasApp.clearAllFichasFirestoreOnly(); // Chama a função que limpa apenas o Firestore
                            break;
                        case 'clearAllProducts':
                            this.productInventoryApp.clearAllProductsFirestoreOnly(); // Chama a função que limpa apenas o Firestore
                            break;
                        case 'deleteSavedReport':
                            this.salonApp.deleteSavedReport(this.reportToDeleteId);
                            break;
                        default:
                            console.warn("Ação de confirmação desconhecida:", this.confirmAction);
                            break;
                    }
                } else {
                    this.showMessage('Operação cancelada.', 'info');
                }
                this.confirmAction = null; 
                this.reportToDeleteId = null; 
            },
            // --- End Helper Functions ---

            // --- Módulo: Fechamento Semanal (salonApp) ---
            salonApp: {
                collaborators: [],
                products: [],
                salonName: "Espaço Fran Kokott",
                savedReports: [],
                selectedReportId: null,
                currentCollaboratorIndexForPdf: null,
                cardDiscountRates: {
                    'pix': 0, 'dinheiro': 0, 'debito': 0.0137, 'credito_1x': 0.0315, 
                    'credito_2x': 0.0539, 'credito_3x': 0.0612
                },

                init() {
                    this.loadLocalData();
                    if (this.collaborators.length === 0) {
                        this.collaborators.push({ 
                            name: '', clients: [{ name: '', value: 0, paymentMethod: 'pix' }], 
                            discountPercentage: 0.30, observations: ''
                        });
                    }
                    if (this.products.length === 0) {
                        this.products.push({ clientName: '', value: 0, paymentMethod: 'pix' });
                    }
                    this.renderAllUI();
                    this.updateDateDisplay();
                    this.calculateAllTotals();
                    this.enableButtons(); // Garante que os botões do módulo estejam habilitados
                },

                enableButtons() {
                    const authRequiredButtons = [
                        'loadDataFromFichasSystemBtn', 'clearAllDataBtn', 'saveToFirestoreBtn', 'loadFromFirestoreBtn'
                    ];
                    authRequiredButtons.forEach(id => {
                        const btn = document.getElementById(id);
                        if (btn) btn.disabled = false;
                    });
                },

                disableAuthRequiredButtons() {
                    const authRequiredButtons = [
                        'loadDataFromFichasSystemBtn', 'clearAllDataBtn', 'saveToFirestoreBtn', 'loadFromFirestoreBtn'
                    ];
                    authRequiredButtons.forEach(id => {
                        const btn = document.getElementById(id);
                        if (btn) btn.disabled = true;
                    });
                },

                clearAllData() {
                    this.collaborators = [];
                    this.products = [];
                    document.getElementById('day').value = '';
                    document.getElementById('month').value = '';
                    document.getElementById('year').value = '';
                    this.collaborators.push({ 
                        name: '', clients: [{ name: '', value: 0, paymentMethod: 'pix' }], 
                        discountPercentage: 0.30, observations: ''
                    });
                    this.products.push({ clientName: '', value: 0, paymentMethod: 'pix' });
                    this.renderAllUI();
                    this.updateDateDisplay();
                    this.calculateAllTotals();
                    this.saveLocalData();
                },

                renderAllUI() {
                    document.getElementById('collaborators-container').innerHTML = '';
                    document.getElementById('products-container').innerHTML = '';
                    this.collaborators.forEach((collabData, index) => {
                        this.addCollaboratorUI(collabData, index);
                    });
                    this.products.forEach((productData, index) => {
                        this.addProductRowUI(productData, index);
                    });
                    this.updateDateDisplay();
                    this.calculateAllTotals();
                },

                addCollaboratorUI(collabData, index) {
                    const container = document.getElementById('collaborators-container');
                    const newCollaboratorDiv = document.createElement('div');
                    newCollaboratorDiv.className = 'collaborator-block';
                    newCollaboratorDiv.setAttribute('data-index', index);
                    const hasName = collabData.name && collabData.name.trim() !== '';

                    newCollaboratorDiv.innerHTML = `
                        <div class="flex flex-wrap items-center justify-between mb-4 gap-2">
                            <input type="text" placeholder="Nome da Colaboradora" value="${collabData.name}" 
                                class="form-input flex-grow text-lg font-semibold min-w-[150px]" 
                                oninput="window.unifiedApp.salonApp.updateCollaboratorName(${index}, this.value); window.unifiedApp.salonApp.saveLocalData()">
                            <div class="flex items-center gap-2">
                                <label for="collab-discount-${index}" class="form-label">Parte Salão (%):</label>
                                <input type="number" id="collab-discount-${index}" min="0" max="100" 
                                    value="${(collabData.discountPercentage * 100).toFixed(0)}" 
                                    class="form-input w-20 text-right" 
                                    oninput="window.unifiedApp.salonApp.updateCollaboratorDiscount(${index}, this.value); window.unifiedApp.salonApp.saveLocalData()">
                            </div>
                            <button onclick="window.unifiedApp.salonApp.removeCollaborator(this)" class="btn btn-danger">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                        <h3 class="text-md font-medium text-gray-700 mb-2">Clientes</h3>
                        <div class="clients-container" id="clients-container-${index}">
                            <!-- Linhas de clientes serão adicionadas aqui dinamicamente -->
                        </div>
                        <button onclick="window.unifiedApp.salonApp.addClientRow(${index})" class="btn btn-primary btn-full mt-4">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Adicionar Cliente
                        </button>
                        
                        <div class="observation-area ${hasName ? 'visible' : ''}" id="observation-area-${index}">
                            <label for="observations-${index}" class="form-label">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                Observações
                            </label>
                            <textarea id="observations-${index}" placeholder="Observações sobre a colaboradora..." 
                                    class="form-textarea" 
                                    oninput="window.unifiedApp.salonApp.updateCollaboratorObservations(${index}, this.value); window.unifiedApp.salonApp.saveLocalData()">${collabData.observations || ''}</textarea>
                        </div>
                        
                        <div class="mt-4 text-right">
                            <p class="text-sm font-medium text-gray-700">Total Bruto Serviços: <span id="collab-gross-total-display-${index}">R$ 0,00</span></p>
                            <p class="text-sm font-medium text-gray-700">Líquido P/ Comissão: <span id="collab-net-for-commission-${index}">R$ 0,00</span></p>
                            <p class="text-sm font-medium text-gray-700">-Parte do Salão (<span id="collab-discount-percentage-display-${index}">${(collabData.discountPercentage * 100).toFixed(0)}</span>%): <span id="collab-salon-share-value-${index}">R$ 0,00</span></p>
                            <p class="text-md font-bold text-gray-800">Total Líquido Colaboradora: <span id="collab-net-total-display-${index}">R$ 0,00</span></p>
                        </div>
                        <button onclick="window.unifiedApp.salonApp.promptAttachReceipt(${index})" class="btn btn-secondary btn-full mt-4">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Gerar PDF da Colaboradora
                        </button>
                    `;
                    container.appendChild(newCollaboratorDiv);
                    collabData.clients.forEach((clientData, clientIndex) => {
                        this.addClientRowUI(clientData, index, clientIndex);
                    });
                },

                addClientRowUI(clientData, collaboratorIndex, clientIndex) {
                    const container = document.getElementById(`clients-container-${collaboratorIndex}`);
                    const newClientDiv = document.createElement('div');
                    newClientDiv.className = 'client-row flex items-center gap-2 mb-2';
                    newClientDiv.innerHTML = `
                        <input type="text" placeholder="Nome do Cliente" value="${clientData.name}" 
                            class="form-input flex-grow min-w-[100px]" 
                            oninput="window.unifiedApp.salonApp.updateClientData(${collaboratorIndex}, ${clientIndex}, 'name', this.value); window.unifiedApp.salonApp.saveLocalData()">
                        <input type="number" step="0.01" min="0" placeholder="Valor" value="${clientData.value}" 
                            class="form-input w-28 text-right" 
                            oninput="window.unifiedApp.salonApp.updateClientData(${collaboratorIndex}, ${clientIndex}, 'value', parseFloat(this.value) || 0); window.unifiedApp.salonApp.saveLocalData()">
                        <select class="form-input w-24" onchange="window.unifiedApp.salonApp.updateClientData(${collaboratorIndex}, ${clientIndex}, 'paymentMethod', this.value); window.unifiedApp.salonApp.saveLocalData()">
                            <option value="pix" ${clientData.paymentMethod === 'pix' ? 'selected' : ''}>Pix</option>
                            <option value="debito" ${clientData.paymentMethod === 'debito' ? 'selected' : ''}>Débito</option>
                            <option value="credito_1x" ${clientData.paymentMethod === 'credito_1x' ? 'selected' : ''}>Crédito 1x</option>
                            <option value="credito_2x" ${clientData.paymentMethod === 'credito_2x' ? 'selected' : ''}>Crédito 2x</option>
                            <option value="credito_3x" ${clientData.paymentMethod === 'credito_3x' ? 'selected' : ''}>Crédito 3x</option>
                            <option value="dinheiro" ${clientData.paymentMethod === 'dinheiro' ? 'selected' : ''}>Dinheiro</option>
                        </select>
                        <button onclick="window.unifiedApp.salonApp.removeClientRow(this, ${collaboratorIndex}, ${clientIndex})" class="btn btn-danger">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    `;
                    container.appendChild(newClientDiv);
                },

                addProductRowUI(productData, index) {
                    const container = document.getElementById('products-container');
                    const newProductDiv = document.createElement('div');
                    newProductDiv.className = 'product-row flex items-center gap-2 mb-2';
                    newProductDiv.innerHTML = `
                        <input type="text" placeholder="Nome da Cliente" value="${productData.clientName}" 
                            class="form-input flex-grow min-w-[120px]" 
                            oninput="window.unifiedApp.salonApp.updateProductData(${index}, 'clientName', this.value); window.unifiedApp.salonApp.saveLocalData()">
                        <input type="number" step="0.01" min="0" placeholder="Valor" value="${productData.value}" 
                            class="form-input w-28 text-right" 
                            oninput="window.unifiedApp.salonApp.updateProductData(${index}, 'value', parseFloat(this.value) || 0); window.unifiedApp.salonApp.saveLocalData()">
                        <select class="form-input w-24" onchange="window.unifiedApp.salonApp.updateProductData(${index}, 'paymentMethod', this.value); window.unifiedApp.salonApp.saveLocalData()">
                            <option value="pix" ${productData.paymentMethod === 'pix' ? 'selected' : ''}>Pix</option>
                            <option value="debito" ${productData.paymentMethod === 'debito' ? 'selected' : ''}>Débito</option>
                            <option value="credito_1x" ${productData.paymentMethod === 'credito_1x' ? 'selected' : ''}>Crédito 1x</option>
                            <option value="credito_2x" ${productData.paymentMethod === 'credito_2x' ? 'selected' : ''}>Crédito 2x</option>
                            <option value="credito_3x" ${productData.paymentMethod === 'credito_3x' ? 'selected' : ''}>Crédito 3x</option>
                            <option value="dinheiro" ${productData.paymentMethod === 'dinheiro' ? 'selected' : ''}>Dinheiro</option>
                        </select>
                        <button onclick="window.unifiedApp.salonApp.removeProductRow(this, ${index})" class="btn btn-danger">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    `;
                    container.appendChild(newProductDiv);
                },

                updateDateDisplay() {
                    const day = document.getElementById('day').value;
                    const month = document.getElementById('month').value;
                    const year = document.getElementById('year').value;
                    const monthName = document.getElementById('month').options[document.getElementById('month').selectedIndex]?.text || '';
                    const dateDisplay = document.getElementById('dateDisplay');
                    if (day && month && year) {
                        dateDisplay.textContent = `Fechamento semana do dia ${day} de ${monthName} de ${year}`;
                    } else {
                        dateDisplay.textContent = 'Preencha a data para exibir.';
                    }
                },

                addCollaborator() {
                    const newCollabData = { 
                        name: '', clients: [{ name: '', value: 0, paymentMethod: 'pix' }], 
                        discountPercentage: 0.30, observations: ''
                    };
                    this.collaborators.push(newCollabData);
                    this.renderAllUI();
                    this.saveLocalData();
                },

                removeCollaborator(button) {
                    const collabBlock = button.closest('.collaborator-block');
                    const indexToRemove = parseInt(collabBlock.getAttribute('data-index'));
                    this.collaborators.splice(indexToRemove, 1);
                    this.renderAllUI();
                    this.saveLocalData();
                },

                updateCollaboratorName(index, name) {
                    if (this.collaborators[index]) {
                        this.collaborators[index].name = name;
                        const observationArea = document.getElementById(`observation-area-${index}`);
                        if (observationArea) {
                            if (name && name.trim() !== '') {
                                observationArea.classList.add('visible');
                            } else {
                                observationArea.classList.remove('visible');
                            }
                        }
                    }
                },

                updateCollaboratorObservations(index, observations) {
                    if (this.collaborators[index]) {
                        this.collaborators[index].observations = observations;
                    }
                },

                updateCollaboratorDiscount(index, value) {
                    let newDiscount = parseFloat(value) / 100;
                    if (isNaN(newDiscount) || newDiscount < 0 || newDiscount > 1) {
                        newDiscount = 0.30;
                        document.getElementById(`collab-discount-${index}`).value = 30;
                    }
                    if (this.collaborators[index]) {
                        this.collaborators[index].discountPercentage = newDiscount;
                        document.getElementById(`collab-discount-percentage-display-${index}`).textContent = (newDiscount * 100).toFixed(0);
                        this.calculateCollaboratorTotal(index);
                    }
                },

                addClientRow(collaboratorIndex) {
                    if (this.collaborators[collaboratorIndex]) {
                        this.collaborators[collaboratorIndex].clients.push({ name: '', value: 0, paymentMethod: 'pix' });
                        this.renderAllUI();
                        this.saveLocalData();
                    }
                },

                removeClientRow(button, collaboratorIndex, clientIndex) {
                    if (this.collaborators[collaboratorIndex]) {
                        this.collaborators[collaboratorIndex].clients.splice(clientIndex, 1);
                        this.renderAllUI();
                        this.saveLocalData();
                    }
                },

                updateClientData(collaboratorIndex, clientIndex, field, value) {
                    if (this.collaborators[collaboratorIndex] && this.collaborators[collaboratorIndex].clients[clientIndex]) {
                        this.collaborators[collaboratorIndex].clients[clientIndex][field] = value;
                        this.calculateCollaboratorTotal(collaboratorIndex);
                    }
                },

                addProductRow() {
                    this.products.push({ clientName: '', value: 0, paymentMethod: 'pix' });
                    this.renderAllUI();
                    this.saveLocalData();
                },

                removeProductRow(button, productIndex) {
                    this.products.splice(productIndex, 1);
                    this.renderAllUI();
                    this.saveLocalData();
                },

                updateProductData(index, field, value) {
                    if (this.products[index]) {
                        this.products[index][field] = value;
                        this.calculateAllTotals();
                    }
                },

                calculateCardDiscount(value, paymentMethod) {
                    return value * (this.cardDiscountRates[paymentMethod] || 0);
                },

                calculateCollaboratorTotal(collaboratorIndex) {
                    let grossTotalServices = 0;
                    const collab = this.collaborators[collaboratorIndex];
                    if (collab) {
                        collab.clients.forEach(client => {
                            grossTotalServices += client.value;
                        });
                        const salonShareValue = grossTotalServices * collab.discountPercentage;
                        const collabNetTotal = grossTotalServices - salonShareValue;

                        document.getElementById(`collab-gross-total-display-${collaboratorIndex}`).textContent = `R$ ${grossTotalServices.toFixed(2).replace('.', ',')}`;
                        document.getElementById(`collab-net-for-commission-${collaboratorIndex}`).textContent = `R$ ${grossTotalServices.toFixed(2).replace('.', ',')}`;
                        document.getElementById(`collab-salon-share-value-${collaboratorIndex}`).textContent = `R$ ${salonShareValue.toFixed(2).replace('.', ',')}`;
                        document.getElementById(`collab-net-total-display-${collaboratorIndex}`).textContent = `R$ ${collabNetTotal.toFixed(2).replace('.', ',')}`;
                    }
                    this.calculateAllTotals();
                },

                calculateAllTotals() {
                    let overallGrossRevenue = 0;
                    let totalCardDiscount = 0;
                    let totalCollaboratorNetPayments = 0;

                    this.collaborators.forEach(collab => {
                        let grossServices = 0;
                        collab.clients.forEach(client => {
                            grossServices += client.value;
                            totalCardDiscount += this.calculateCardDiscount(client.value, client.paymentMethod);
                        });
                        overallGrossRevenue += grossServices;
                        const salonShareValue = grossServices * collab.discountPercentage;
                        const collabNetTotal = grossServices - salonShareValue;
                        totalCollaboratorNetPayments += collabNetTotal;
                    });

                    this.products.forEach(product => {
                        overallGrossRevenue += product.value;
                        const productCardDiscount = this.calculateCardDiscount(product.value, product.paymentMethod);
                        totalCardDiscount += productCardDiscount;
                    });

                    const salonNetProfit = overallGrossRevenue - totalCardDiscount - totalCollaboratorNetPayments;

                    document.getElementById('products-total').textContent = `R$ ${this.products.reduce((sum, p) => sum + p.value, 0).toFixed(2).replace('.', ',')}`;
                    document.getElementById('overall-gross-total').textContent = `R$ ${overallGrossRevenue.toFixed(2).replace('.', ',')}`;
                    document.getElementById('total-card-discount').textContent = `R$ ${totalCardDiscount.toFixed(2).replace('.', ',')}`;
                    document.getElementById('overall-net-total').textContent = `R$ ${salonNetProfit.toFixed(2).replace('.', ',')}`;

                    this.updateDetailedContribution();
                },

                updateDetailedContribution() {
                    const detailedContributionDiv = document.getElementById('detailed-contribution');
                    let content = '';
                    let totalGrossServices = 0;
                    this.collaborators.forEach(collab => {
                        totalGrossServices += collab.clients.reduce((sum, client) => sum + client.value, 0);
                    });

                    if (this.collaborators.length > 0) {
                        content += '<p class="font-bold">Serviços por Colaboradora (Bruto):</p>';
                        this.collaborators.forEach(collab => {
                            const collabGrossTotal = collab.clients.reduce((sum, client) => sum + client.value, 0);
                            if (totalGrossServices > 0) {
                                const percentageOfServices = (collabGrossTotal / totalGrossServices) * 100;
                                content += `<p class="ml-4">${collab.name || 'Colaboradora sem nome'}: R$ ${collabGrossTotal.toFixed(2).replace('.', ',')} (${percentageOfServices.toFixed(1)}% dos serviços)</p>`;
                            } else {
                                content += `<p class="ml-4">${collab.name || 'Colaboradora sem nome'}: R$ ${collabGrossTotal.toFixed(2).replace('.', ',')}</p>`;
                            }
                        });
                    } else {
                        content += '<p>Nenhum serviço registrado.</p>';
                    }

                    const overallProductsTotal = this.products.reduce((sum, product) => sum + product.value, 0);
                    content += `<p class="font-bold mt-2">Venda de Produtos:</p>`;
                    content += `<p class="ml-4">Total de Produtos: R$ ${overallProductsTotal.toFixed(2).replace('.', ',')}</p>`;
                    detailedContributionDiv.innerHTML = content;
                },

                formatPaymentMethodForPdf(paymentMethod) {
                    switch (paymentMethod) {
                        case 'pix': return 'Pix';
                        case 'debito': return 'Débito';
                        case 'credito_1x': return 'Crédito (1x)';
                        case 'credito_2x': return 'Crédito (2x)';
                        case 'credito_3x': return 'Crédito (3x)';
                        case 'dinheiro': return 'Dinheiro';
                        default: return paymentMethod.toUpperCase();
                    }
                },

                promptAttachReceipt(collaboratorIndex) {
                    this.currentCollaboratorIndexForPdf = collaboratorIndex;
                    document.getElementById('attach-receipt-modal').style.display = 'flex';
                },

                handleAttachReceiptChoice(attach) {
                    document.getElementById('attach-receipt-modal').style.display = 'none';
                    const collaboratorIndex = this.currentCollaboratorIndexForPdf;

                    if (attach) {
                        const fileInput = document.createElement('input');
                        fileInput.type = 'file';
                        fileInput.accept = 'image/*';

                        fileInput.onchange = async (event) => {
                            const file = event.target.files[0];
                            let imageDataUrl = null;
                            if (file) {
                                if (!file.type.startsWith('image/')) {
                                    window.unifiedApp.showMessage('Por favor, selecione um arquivo de imagem (JPG, PNG, GIF, etc.) para o comprovante.', 'error');
                                } else {
                                    try {
                                        imageDataUrl = await new Promise((resolve, reject) => {
                                            const reader = new FileReader();
                                            reader.onload = (e) => resolve(e.target.result);
                                            reader.onerror = (e) => reject(e);
                                            reader.readAsDataURL(file);
                                        });
                                    } catch (error) {
                                        console.error("Erro ao ler o arquivo de imagem:", error);
                                        window.unifiedApp.showMessage('Erro ao carregar a imagem do comprovante. O PDF será gerado sem ela.', 'warning');
                                    }
                                }
                            } else {
                                window.unifiedApp.showMessage('Nenhuma imagem selecionada. Gerando PDF sem comprovante.', 'info');
                            }
                            this._generateCollaboratorPdfContent(collaboratorIndex, imageDataUrl);
                        };
                        fileInput.click();
                    } else {
                        this._generateCollaboratorPdfContent(collaboratorIndex, null);
                    }
                    this.currentCollaboratorIndexForPdf = null;
                },

                async _generateCollaboratorPdfContent(collaboratorIndex, imageDataUrl) {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const collab = this.collaborators[collaboratorIndex];
                    if (!collab) {
                        console.error("Colaboradora não encontrada para geração de PDF.");
                        window.unifiedApp.showMessage('Erro: Colaboradora não encontrada para gerar PDF.', 'error');
                        return;
                    }

                    const dateText = document.getElementById('dateDisplay').textContent;
                    const collabName = collab.name || 'Colaboradora sem nome';
                    const collabTitleY = 20;

                    doc.setFontSize(20);
                    doc.text(this.salonName, 105, collabTitleY, null, null, "center");

                    let y = collabTitleY + 15;

                    doc.setFontSize(14);
                    doc.text(`Fechamento semanal (${collabName})`, 105, y, null, null, "center");
                    y += 15;
                    doc.setFontSize(12);
                    doc.text(dateText, 105, y, null, null, "center");
                    y += 15;

                    doc.setFontSize(14);
                    doc.text("Serviços Prestados:", 15, y);
                    y += 10;

                    if (collab.clients.length === 0) {
                        doc.setFontSize(10);
                        doc.text("Nenhum cliente registrado para esta colaboradora.", 20, y);
                        y += 10;
                    } else {
                        collab.clients.forEach(client => {
                            if (y > 270) { doc.addPage(); y = 15; }
                            doc.setFontSize(10);
                            doc.text(`${client.name || 'Nome do Cliente'}: R$ ${client.value.toFixed(2).replace('.', ',')} (${this.formatPaymentMethodForPdf(client.paymentMethod)})`, 25, y);
                            y += 5;
                        });
                    }

                    const grossTotalServices = collab.clients.reduce((sum, client) => sum + client.value, 0);
                    const salonShareValue = grossTotalServices * collab.discountPercentage;
                    const collabNetTotal = grossTotalServices - salonShareValue;

                    if (y > 270) { doc.addPage(); y = 15; }
                    doc.setFontSize(10);
                    doc.text(`Total Bruto Serviços: R$ ${grossTotalServices.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right");
                    y += 5;
                    doc.text(`Líquido P/ Comissão: R$ ${grossTotalServices.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right");
                    y += 5;
                    doc.text(`Parte do Salão (-${(collab.discountPercentage * 100).toFixed(0)}%): R$ ${salonShareValue.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right");
                    y += 5;
                    doc.setFontSize(12);
                    doc.text(`Total Líquido Colaboradora: R$ ${collabNetTotal.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right");
                    y += 15;

                    if (collab.observations && collab.observations.trim() !== '') {
                        y += 15;
                        if (y > 260) { doc.addPage(); y = 15; }
                        doc.setFontSize(12);
                        doc.text("Observações:", 15, y);
                        y += 7;
                        doc.setFontSize(10);
                        const lines = doc.splitTextToSize(collab.observations, 180);
                        lines.forEach(line => {
                            if (y > 270) { doc.addPage(); y = 15; }
                            doc.text(line, 15, y);
                            y += 5;
                        });
                    }

                    if (imageDataUrl) {
                        y += 15;
                        if (y > 260) { doc.addPage(); y = 15; }
                        doc.setFontSize(14);
                        doc.text("Comprovante de Pagamento:", 15, y);
                        y += 10;
                        try {
                            const img = new Image();
                            img.src = imageDataUrl;
                            await new Promise(resolve => img.onload = resolve);
                            const imgWidth = img.width;
                            const imgHeight = img.height;
                            const pageWidth = doc.internal.pageSize.getWidth() - 30;
                            const pageHeight = doc.internal.pageSize.getHeight() - y - 15;
                            let finalImgWidth = pageWidth;
                            let finalImgHeight = (imgHeight * pageWidth) / imgWidth;
                            if (finalImgHeight > pageHeight) {
                                finalImgHeight = pageHeight;
                                finalImgWidth = (imgWidth * pageHeight) / imgHeight;
                            }
                            const imgX = 15 + (pageWidth - finalImgWidth) / 2;
                            if (y + finalImgHeight > doc.internal.pageSize.getHeight() - 15) {
                                doc.addPage();
                                y = 15;
                            }
                            doc.addImage(imageDataUrl, 'JPEG', imgX, y, finalImgWidth, finalImgHeight); 
                            y += finalImgHeight + 10;
                        } catch (imgError) {
                            console.error("Erro ao adicionar imagem ao PDF:", imgError);
                            window.unifiedApp.showMessage('Erro ao adicionar a imagem do comprovante ao PDF. O PDF será gerado sem ela.', 'warning');
                        }
                    }
                    doc.save(`fechamento_semanal_${collabName.replace(/\s+/g, '_').toLowerCase()}.pdf`);
                    window.unifiedApp.showMessage(`PDF da colaboradora ${collabName} gerado!`, 'success');
                },

                generatePDF() {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const dateText = document.getElementById('dateDisplay').textContent;
                    const mainTitleY = 20;

                    doc.setFontSize(20);
                    doc.text(this.salonName, 105, mainTitleY, null, null, "center");
                    let y = mainTitleY + 15;

                    doc.setFontSize(14);
                    doc.text("Fechamento semanal (Geral)", 105, y, null, null, "center");
                    y += 15;
                    doc.setFontSize(14);
                    doc.text(dateText, 105, y, null, null, "center");
                    y += 15;

                    doc.setFontSize(16);
                    doc.text("Colaboradoras:", 15, y);
                    y += 10;

                    if (this.collaborators.length === 0) {
                        doc.setFontSize(12);
                        doc.text("Nenhuma colaboradora adicionada.", 15, y);
                        y += 10;
                    } else {
                        this.collaborators.forEach(collab => {
                            if (y > 270) { doc.addPage(); y = 15; }
                            doc.setFontSize(14);
                            doc.text(`${collab.name || 'Nome da Colaboradora'}:`, 20, y);
                            y += 7;
                            if (collab.clients.length === 0) {
                                doc.setFontSize(10);
                                doc.text("Nenhum cliente registrado.", 25, y);
                                y += 7;
                            } else {
                                collab.clients.forEach(client => {
                                    if (y > 270) { doc.addPage(); y = 15; }
                                    doc.setFontSize(10);
                                    doc.text(`${client.name || 'Nome do Cliente'}: R$ ${client.value.toFixed(2).replace('.', ',')} (${this.formatPaymentMethodForPdf(client.paymentMethod)})`, 25, y);
                                    y += 5;
                                });
                            }
                            const grossTotalServices = collab.clients.reduce((sum, client) => sum + client.value, 0);
                            const salonShareValue = grossTotalServices * collab.discountPercentage;
                            const collabNetTotal = grossTotalServices - salonShareValue;

                            if (y > 270) { doc.addPage(); y = 15; }
                            doc.setFontSize(10);
                            doc.text(`Total Bruto Serviços: R$ ${grossTotalServices.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right");
                            y += 5;
                            doc.text(`Líquido P/ Comissão: R$ ${grossTotalServices.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right");
                            y += 5;
                            doc.text(`Parte do Salão (-${(collab.discountPercentage * 100).toFixed(0)}%): R$ ${salonShareValue.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right");
                            y += 5;
                            doc.setFontSize(12);
                            doc.text(`Total Líquido Colaboradora: R$ ${collabNetTotal.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right");
                            y += 15;
                        });
                    }

                    if (y > 260) { doc.addPage(); y = 15; }
                    doc.setFontSize(16);
                    doc.text("Produtos Vendidos:", 15, y);
                    y += 10;

                    if (this.products.length === 0) {
                        doc.setFontSize(12);
                        doc.text("Nenhum produto vendido.", 15, y);
                        y += 10;
                    } else {
                        this.products.forEach(product => {
                            if (y > 270) { doc.addPage(); y = 15; }
                            doc.setFontSize(10);
                            doc.text(`${product.clientName || 'Cliente sem nome'}: R$ ${product.value.toFixed(2).replace('.', ',')} (${this.formatPaymentMethodForPdf(product.paymentMethod)})`, 20, y);
                            y += 5;
                        });
                    }

                    const overallProductsTotal = this.products.reduce((sum, product) => sum + product.value, 0);
                    const overallProductsCardDiscount = this.products.reduce((sum, product) => sum + this.calculateCardDiscount(product.value, product.paymentMethod), 0);
                    if (y > 270) { doc.addPage(); y = 15; }
                    doc.setFontSize(12);
                    doc.text(`Total Bruto Produtos: R$ ${overallProductsTotal.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right");
                    y += 5;
                    doc.text(`Desconto Cartão Produtos: R$ ${overallProductsCardDiscount.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right");
                    y += 15;

                    if (y > 260) { doc.addPage(); y = 15; }
                    doc.setFontSize(16);
                    doc.text("Detalhes da Contribuição:", 15, y);
                    y += 10;

                    let totalGrossServicesForPDF = this.collaborators.reduce((sum, collab) => sum + collab.clients.reduce((s, c) => s + c.value, 0), 0);
                    
                    if (this.collaborators.length > 0) {
                        if (y > 270) { doc.addPage(); y = 15; }
                        doc.setFontSize(12);
                        doc.text("Serviços por Colaboradora (Bruto):", 20, y);
                        y += 7;
                        this.collaborators.forEach(collab => {
                            const collabGrossTotal = collab.clients.reduce((sum, client) => sum + client.value, 0);
                            if (totalGrossServicesForPDF > 0) {
                                const percentageOfServices = (collabGrossTotal / totalGrossServicesForPDF) * 100;
                                if (y > 270) { doc.addPage(); y = 15; }
                                doc.setFontSize(10);
                                doc.text(`${collab.name || 'Colaboradora sem nome'}: R$ ${collabGrossTotal.toFixed(2).replace('.', ',')} (${percentageOfServices.toFixed(1)}% dos serviços)`, 25, y);
                                y += 5;
                            } else {
                                if (y > 270) { doc.addPage(); y = 15; }
                                doc.setFontSize(10);
                                doc.text(`${collab.name || 'Colaboradora sem nome'}: R$ ${collabGrossTotal.toFixed(2).replace('.', ',')}`, 25, y);
                                y += 5;
                            }
                        });
                    } else {
                        if (y > 270) { doc.addPage(); y = 15; }
                        doc.setFontSize(10);
                        doc.text("Nenhum serviço registrado.", 20, y);
                        y += 5;
                    }

                    if (y > 270) { doc.addPage(); y = 15; }
                    doc.setFontSize(12);
                    doc.text("Venda de Produtos:", 20, y);
                    y += 7;
                    doc.setFontSize(10);
                    doc.text(`Total de Produtos: R$ ${overallProductsTotal.toFixed(2).replace('.', ',')}`, 25, y);
                    y += 10;

                    if (y > 260) { doc.addPage(); y = 15; }
                    doc.setFontSize(16);
                    doc.text("Resumo Geral:", 15, y);
                    y += 10;

                    let overallGrossRevenue = 0;
                    let totalCardDiscount = 0;
                    let totalCollaboratorNetPayments = 0;

                    this.collaborators.forEach(collab => {
                        let grossServices = 0;
                        collab.clients.forEach(client => {
                            grossServices += client.value;
                            totalCardDiscount += this.calculateCardDiscount(client.value, client.paymentMethod);
                        });
                        overallGrossRevenue += grossServices;
                        const salonShareValue = grossServices * collab.discountPercentage;
                        const collabNetTotal = grossServices - salonShareValue;
                        totalCollaboratorNetPayments += collabNetTotal;
                    });

                    this.products.forEach(product => {
                        overallGrossRevenue += product.value;
                        totalCardDiscount += this.calculateCardDiscount(product.value, product.paymentMethod);
                    });

                    const salonNetProfit = overallGrossRevenue - totalCardDiscount - totalCollaboratorNetPayments;

                    if (y > 270) { doc.addPage(); y = 15; }
                    doc.setFontSize(14);
                    doc.text(`Total Bruto Geral: R$ ${overallGrossRevenue.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right");
                    y += 7;
                    doc.text(`Total Desconto Cartão: R$ ${totalCardDiscount.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right");
                    y += 7;
                    doc.setFontSize(16);
                    doc.text(`Lucro Líquido do Salão: R$ ${salonNetProfit.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right");

                    doc.save("fechamento_semanal_salao.pdf");
                    window.unifiedApp.showMessage('PDF do fechamento geral gerado!', 'success');
                },

                saveLocalData() {
                    const dataToSave = {
                        salonName: this.salonName,
                        collaborators: this.collaborators,
                        products: this.products,
                        date: {
                            day: document.getElementById('day').value,
                            month: document.getElementById('month').value,
                            year: document.getElementById('year').value
                        }
                    };
                    localStorage.setItem('salonWeeklyClosingData', JSON.stringify(dataToSave));
                },

                loadLocalData() {
                    const savedData = localStorage.getItem('salonWeeklyClosingData');
                    if (savedData) {
                        try {
                            const parsedData = JSON.parse(savedData);
                            this.collaborators = parsedData.collaborators || [];
                            this.products = parsedData.products || [];
                            this.salonName = parsedData.salonName || 'Espaço Fran Kokott';

                            document.getElementById('day').value = parsedData.date?.day || '';
                            document.getElementById('month').value = parsedData.date?.month || '';
                            document.getElementById('year').value = parsedData.date?.year || '';

                            this.collaborators.forEach(collab => {
                                if (collab.discountPercentage === undefined) {
                                    collab.discountPercentage = 0.30;
                                }
                                if (collab.observations === undefined) {
                                    collab.observations = '';
                                }
                                collab.clients.forEach(client => {
                                    if (client.paymentMethod === undefined || client.paymentMethod === 'credito') {
                                        client.paymentMethod = 'credito_1x';
                                    }
                                });
                            });
                            this.products.forEach(product => {
                                if (product.paymentMethod === undefined || product.paymentMethod === 'credito') {
                                    product.paymentMethod = 'credito_1x';
                                }
                            });
                            this.renderAllUI();
                            window.unifiedApp.showMessage('Dados carregados do salvamento automático.', 'info');
                        } catch (e) {
                            console.error("Erro ao carregar dados do localStorage:", e);
                            localStorage.removeItem('salonWeeklyClosingData');
                            window.unifiedApp.showMessage('Erro ao carregar dados salvos localmente. Dados corrompidos foram removidos.', 'error');
                        }
                    }
                },

                exportDataToFile() {
                    const dataToSave = {
                        salonName: this.salonName,
                        collaborators: this.collaborators,
                        products: this.products,
                        date: {
                            day: document.getElementById('day').value,
                            month: document.getElementById('month').value,
                            year: document.getElementById('year').value
                        }
                    };
                    const jsonString = JSON.stringify(dataToSave, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `fechamento_salao_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    window.unifiedApp.showMessage('Dados exportados com sucesso!', 'success');
                },

                importDataFromFile() {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.json';
                    fileInput.onchange = (event) => {
                        const file = event.target.files[0];
                        if (!file) {
                            window.unifiedApp.showMessage('Nenhum arquivo selecionado.', 'info');
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const importedData = JSON.parse(e.target.result);
                                if (importedData.collaborators && Array.isArray(importedData.collaborators) &&
                                    importedData.products && Array.isArray(importedData.products) &&
                                    importedData.date && typeof importedData.date === 'object') {
                                    this.collaborators = importedData.collaborators;
                                    this.products = importedData.products;
                                    this.salonName = importedData.salonName || 'Espaço Fran Kokott';

                                    this.collaborators.forEach(collab => {
                                        if (collab.discountPercentage === undefined) {
                                            collab.discountPercentage = 0.30;
                                        }
                                        if (collab.observations === undefined) {
                                            collab.observations = '';
                                        }
                                        collab.clients.forEach(client => {
                                            if (client.paymentMethod === undefined || client.paymentMethod === 'credito') {
                                                client.paymentMethod = 'credito_1x';
                                            }
                                        });
                                    });
                                    this.products.forEach(product => {
                                        if (product.paymentMethod === undefined || product.paymentMethod === 'credito') {
                                            product.paymentMethod = 'credito_1x';
                                        }
                                    });

                                    document.getElementById('day').value = importedData.date.day || '';
                                    document.getElementById('month').value = importedData.date.month || '';
                                    document.getElementById('year').value = importedData.date.year || '';
                                    this.renderAllUI();
                                    this.saveLocalData();
                                    window.unifiedApp.showMessage('Dados importados com sucesso!', 'success');
                                } else {
                                    window.unifiedApp.showMessage('Formato de arquivo JSON inválido.', 'error');
                                }
                            } catch (parseError) {
                                window.unifiedApp.showMessage('Erro ao ler o arquivo: Não é um JSON válido.', 'error');
                            }
                        };
                        reader.readAsText(file);
                    };
                    fileInput.click();
                },

                async saveWeeklyClosingToFirestore() {
                    if (!window.db || !window.userId || window.userId === 'Não autenticado') {
                        window.unifiedApp.showMessage('Por favor, faça login para salvar dados na nuvem.', 'error');
                        return;
                    }
                    const day = document.getElementById('day').value;
                    const month = document.getElementById('month').value;
                    const year = document.getElementById('year').value;
                    if (!day || !month || !year) {
                        window.unifiedApp.showMessage('Por favor, preencha o dia, mês e ano para salvar o fechamento.', 'error');
                        return;
                    }
                    window.unifiedApp.showMessage('Salvando dados na nuvem...', 'info');
                    window.unifiedApp.toggleLoadingSpinner('save', true);
                    const dataToSave = {
                        salonName: this.salonName,
                        collaborators: this.collaborators,
                        products: this.products,
                        date: { day, month, year },
                        notes: "",
                        lastSaved: new Date().toISOString()
                    };
                    try {
                        const collectionRef = window.collection(window.db, `artifacts/${window.appId}/users/${window.userId}/manualWeeklySaves`);
                        await window.addDoc(collectionRef, dataToSave);
                        window.unifiedApp.showMessage('Dados salvos na nuvem com sucesso!', 'success');
                    } catch (e) {
                        console.error("Erro ao salvar no Firestore: ", e);
                        window.unifiedApp.showMessage('Erro ao salvar dados na nuvem: ' + e.message, 'error');
                    } finally {
                        window.unifiedApp.toggleLoadingSpinner('save', false);
                    }
                },

                async openSavedReportsModal() {
                    if (!window.db || !window.userId || window.userId === 'Não autenticado') {
                        window.unifiedApp.showMessage('Por favor, faça login para carregar dados da nuvem.', 'error');
                        return;
                    }
                    window.unifiedApp.showMessage('Buscando relatórios salvos...', 'info');
                    window.unifiedApp.toggleLoadingSpinner('load', true);
                    const reportsListDiv = document.getElementById('saved-reports-list');
                    reportsListDiv.innerHTML = '<p class="text-center text-gray-500 p-4">Carregando...</p>';
                    this.selectedReportId = null;
                    try {
                        const collectionRef = window.collection(window.db, `artifacts/${window.appId}/users/${window.userId}/manualWeeklySaves`);
                        const querySnapshot = await window.getDocs(collectionRef);
                        this.savedReports = [];
                        if (querySnapshot.empty) {
                            reportsListDiv.innerHTML = '<p class="text-center text-gray-500 p-4">Nenhum fechamento semanal salvo.</p>';
                            window.unifiedApp.showMessage('Nenhum fechamento semanal salvo para carregar.', 'info');
                            return;
                        }
                        reportsListDiv.innerHTML = '';
                        querySnapshot.forEach(doc => {
                            const data = doc.data();
                            this.savedReports.push({ id: doc.id, ...data });
                            const reportItem = document.createElement('div');
                            reportItem.className = 'report-item';
                            reportItem.setAttribute('data-report-id', doc.id);
                            const date = data.date;
                            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                            const formattedDate = date.day && date.month && date.year ? 
                                                `${date.day} de ${monthNames[parseInt(date.month) - 1]} de ${date.year}` : 
                                                'Data Indefinida';
                            const savedDate = data.lastSaved ? new Date(data.lastSaved).toLocaleDateString('pt-BR') : 'Desconhecida';
                            const savedTime = data.lastSaved ? new Date(data.lastSaved).toLocaleTimeString('pt-BR') : '';

                            reportItem.innerHTML = `
                                <div>
                                    <p class="font-medium">Fechamento: ${formattedDate}</p>
                                    <p class="text-xs text-gray-500">Salvo em: ${savedDate} às ${savedTime}</p>
                                </div>
                                <button class="btn btn-danger text-sm" onclick="event.stopPropagation(); window.unifiedApp.showConfirmModal('Tem certeza que deseja excluir este relatório salvo?', 'deleteSavedReport', '${doc.id}')">Excluir</button>
                            `;
                            reportItem.onclick = (event) => this.selectReport(event, doc.id);
                            reportsListDiv.appendChild(reportItem);
                        });
                        document.getElementById('saved-reports-modal').style.display = 'flex';
                        window.unifiedApp.showMessage('Relatórios salvos carregados!', 'success');

                    } catch (error) {
                        console.error('Erro ao carregar relatórios salvos do Firestore:', error);
                        window.unifiedApp.showMessage('Erro ao carregar relatórios salvos: ' + error.message, 'error');
                    } finally {
                        window.unifiedApp.toggleLoadingSpinner('load', false);
                    }
                },

                closeSavedReportsModal() {
                    document.getElementById('saved-reports-modal').style.display = 'none';
                },

                selectReport(event, reportId) {
                    document.querySelectorAll('#saved-reports-list .report-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    event.currentTarget.classList.add('selected');
                    this.selectedReportId = reportId;
                },

                async loadSelectedReport() {
                    if (!this.selectedReportId) {
                        window.unifiedApp.showMessage('Por favor, selecione um fechamento para carregar.', 'info');
                        return;
                    }
                    window.unifiedApp.showMessage('Carregando fechamento selecionado...', 'info');
                    window.unifiedApp.toggleLoadingSpinner('load', true);
                    const reportToLoad = this.savedReports.find(report => report.id === this.selectedReportId);

                    if (reportToLoad) {
                        this.collaborators = reportToLoad.collaborators || [];
                        this.products = reportToLoad.products || [];
                        this.salonName = reportToLoad.salonName || 'Espaço Fran Kokott';

                        this.collaborators.forEach(collab => {
                                collab.discountPercentage = collab.discountPercentage !== undefined ? collab.discountPercentage : 0.30;
                                collab.observations = collab.observations !== undefined ? collab.observations : '';
                                collab.clients.forEach(client => {
                                    if (client.paymentMethod === undefined || client.paymentMethod === 'credito') {
                                        client.paymentMethod = 'credito_1x';
                                    }
                                });
                            });
                            this.products.forEach(product => {
                                if (product.paymentMethod === undefined || product.paymentMethod === 'credito') {
                                    product.paymentMethod = 'credito_1x';
                                }
                            });

                        document.getElementById('day').value = reportToLoad.date?.day || '';
                        document.getElementById('month').value = reportToLoad.date?.month || '';
                        document.getElementById('year').value = reportToLoad.date?.year || '';
                        
                        this.renderAllUI();
                        this.closeSavedReportsModal();
                        this.saveLocalData();
                        window.unifiedApp.showMessage('Fechamento carregado com sucesso!', 'success');
                    } else {
                        window.unifiedApp.showMessage('Erro: Fechamento selecionado não encontrado.', 'error');
                    }
                    window.unifiedApp.toggleLoadingSpinner('load', false);
                },

                deleteSavedReportConfirmation(reportId) {
                    window.unifiedApp.showConfirmModal('Tem certeza que deseja excluir este relatório salvo? Esta ação não pode ser desfeita.', 'deleteSavedReport', reportId);
                },

                async deleteSavedReport(reportId) {
                    if (!window.db || !window.userId || window.userId === 'Não autenticado') {
                        window.unifiedApp.showMessage('Por favor, faça login para excluir relatórios.', 'error');
                        return;
                    }
                    window.unifiedApp.showMessage('Excluindo relatório...', 'info');
                    window.unifiedApp.toggleLoadingSpinner('load', true);
                    try {
                        const docRef = window.doc(window.db, `artifacts/${window.appId}/users/${window.userId}/manualWeeklySaves`, reportId);
                        await window.deleteDoc(docRef);
                        window.unifiedApp.showMessage('Relatório excluído com sucesso!', 'success');
                        this.openSavedReportsModal();
                    } catch (error) {
                        console.error('Erro ao excluir relatório salvo:', error);
                        window.unifiedApp.showMessage('Erro ao excluir relatório: ' + error.message, 'error');
                    } finally {
                        window.unifiedApp.toggleLoadingSpinner('load', false);
                    }
                },

                async loadDataFromFichasSystem() {
                    if (!window.db || !window.userId || window.userId === 'Não autenticado') {
                        window.unifiedApp.showMessage('Por favor, faça login para importar dados das fichas.', 'error');
                        return;
                    }
                    window.unifiedApp.showMessage('Carregando dados das fichas...', 'info');
                    window.unifiedApp.toggleLoadingSpinner('fichas', true);
                    try {
                        const docRef = window.doc(window.db, `artifacts/${window.appId}/users/${window.userId}/weeklyReportsAggregated/currentWeek`);
                        const docSnap = await window.getDoc(docRef);

                        if (docSnap.exists()) {
                            const importedData = docSnap.data();
                            this.collaborators = [];
                            this.products = [];

                            if (importedData.collaborators && Array.isArray(importedData.collaborators)) {
                                importedData.collaborators.forEach(collab => {
                                    if (collab.discountPercentage === undefined) {
                                        collab.discountPercentage = 0.30;
                                    }
                                    if (collab.observations === undefined) {
                                        collab.observations = '';
                                    }
                                    collab.clients.forEach(client => {
                                        if (client.paymentMethod === undefined || client.paymentMethod === 'credito') {
                                            client.paymentMethod = 'credito_1x';
                                        }
                                    });
                                    this.collaborators.push(collab);
                                });
                            }
                            if (importedData.products && Array.isArray(importedData.products)) {
                                importedData.products.forEach(product => {
                                    if (product.paymentMethod === undefined || product.paymentMethod === 'credito') {
                                        product.paymentMethod = 'credito_1x';
                                    }
                                    this.products.push(product);
                                });
                            }
                            this.renderAllUI();
                            this.saveLocalData();
                            window.unifiedApp.showMessage('Dados importados do sistema de Fichas com sucesso!', 'success');
                        } else {
                            window.unifiedApp.showMessage('Nenhum dado de fechamento semanal encontrado para importar.', 'info');
                        }
                    } catch (error) {
                        window.unifiedApp.showMessage('Erro ao importar dados: ' + error.message, 'error');
                        console.error('Erro ao importar dados do Firestore:', error);
                    } finally {
                        window.unifiedApp.toggleLoadingSpinner('fichas', false);
                    }
                },

                async clearAllDataFromFirestoreAndLocal() {
                    if (!window.db || !window.userId || window.userId === 'Não autenticado') {
                        window.unifiedApp.showMessage('Por favor, faça login para limpar dados na nuvem.', 'error');
                        return;
                    }
                    window.unifiedApp.showMessage('Limpando todos os dados...', 'info');
                    window.unifiedApp.toggleLoadingSpinner('clear', true);
                    try {
                        this.clearAllData();

                        const manualSavesCollectionRef = window.collection(window.db, `artifacts/${window.appId}/users/${window.userId}/manualWeeklySaves`);
                        const manualSavesSnapshot = await window.getDocs(manualSavesCollectionRef);
                        const deleteManualSavesPromises = [];
                        manualSavesSnapshot.forEach((doc) => {
                            deleteManualSavesPromises.push(window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/users/${window.userId}/manualWeeklySaves`, doc.id)));
                        });
                        await Promise.all(deleteManualSavesPromises);

                        const currentWeekDocRef = window.doc(window.db, `artifacts/${window.appId}/users/${window.userId}/weeklyReportsAggregated/currentWeek`);
                        const currentWeekDocSnap = await window.getDoc(currentWeekDocRef);
                        if (currentWeekDocSnap.exists()) {
                            await window.deleteDoc(currentWeekDocRef);
                        }

                        // Limpa fichas individuais e produtos de estoque também
                        await window.unifiedApp.fichasApp.clearAllFichasFirestoreOnly();
                        await window.unifiedApp.productInventoryApp.clearAllProductsFirestoreOnly();

                        window.unifiedApp.showMessage('Todos os dados foram limpos (local e nuvem).', 'success');
                    } catch (error) {
                        window.unifiedApp.showMessage('Erro ao limpar dados na nuvem: ' + error.message, 'error');
                        console.error('Erro ao limpar dados do Firestore:', error);
                    } finally {
                        window.unifiedApp.toggleLoadingSpinner('clear', false);
                    }
                },
            },

            // --- Módulo: Fichas de Cliente (fichasApp) ---
            fichasApp: {
                fichas: [],

                init() {
                    this.loadLocalData();
                    this.loadFichasFromFirestore();
                    // Garante que as linhas de input existam para a aba ativa
                    if (document.querySelectorAll('#fichas-clientes-app .service-row').length === 0) {
                        this.addServiceRow();
                    }
                    if (document.querySelectorAll('#fichas-clientes-app .product-sold-row').length === 0) {
                        this.addProductSoldRow();
                    }
                    this.enableButtons();
                },

                enableButtons() {
                    const authRequiredButtons = [
                        'addFichaBtn', 'clearAllFichasBtn', 'exportWeeklyDataBtn'
                    ];
                    authRequiredButtons.forEach(id => {
                        const btn = document.getElementById(id);
                        if (btn) btn.disabled = false;
                    });
                },

                disableAuthRequiredButtons() {
                    const authRequiredButtons = [
                        'addFichaBtn', 'clearAllFichasBtn', 'exportWeeklyDataBtn'
                    ];
                    authRequiredButtons.forEach(id => {
                        const btn = document.getElementById(id);
                        if (btn) btn.disabled = true;
                    });
                },

                async saveFichaToFirestore(fichaData) {
                    if (!window.db || !window.userId || !window.fichasCollectionRef) {
                        window.unifiedApp.showMessage('Firebase não inicializado ou usuário não autenticado. Não foi possível salvar a ficha.', 'error');
                        return null;
                    }
                    window.unifiedApp.toggleLoadingSpinner('add-ficha', true);
                    try {
                        const docRef = await window.addDoc(window.fichasCollectionRef, fichaData);
                        window.unifiedApp.showMessage('Ficha registrada e salva na nuvem!', 'success');
                        return docRef.id;
                    } catch (e) {
                        console.error("Erro ao adicionar ficha ao Firestore: ", e);
                        window.unifiedApp.showMessage('Erro ao salvar ficha na nuvem: ' + e.message, 'error');
                        return null;
                    } finally {
                        window.unifiedApp.toggleLoadingSpinner('add-ficha', false);
                    }
                },

                async loadFichasFromFirestore() {
                    if (!window.db || !window.userId || !window.fichasCollectionRef) {
                        console.log('Firebase não inicializado ou usuário não autenticado. Não foi possível carregar as fichas.');
                        return;
                    }
                    window.unifiedApp.showMessage('Carregando fichas do Firestore...', 'info');
                    window.unifiedApp.toggleLoadingSpinner('clear-fichas', true);
                    try {
                        this.fichas = []; 
                        const querySnapshot = await window.getDocs(window.fichasCollectionRef);
                        querySnapshot.forEach((doc) => {
                            this.fichas.push({ id: doc.id, ...doc.data() });
                        });
                        this.renderFichasTable();
                        window.unifiedApp.showMessage('Fichas carregadas do Firestore com sucesso!', 'success');
                    } catch (e) {
                        console.error("Erro ao carregar fichas do Firestore: ", e);
                        window.unifiedApp.showMessage('Erro ao carregar fichas da nuvem: ' + e.message, 'error');
                    } finally {
                        window.unifiedApp.toggleLoadingSpinner('clear-fichas', false);
                    }
                },

                async removeFichaFromFirestore(fichaId) {
                    if (!window.db || !window.userId) {
                        window.unifiedApp.showMessage('Firebase não inicializado ou usuário não autenticado. Não foi possível remover a ficha.', 'error');
                        return false;
                    }
                    try {
                        await window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/users/${window.userId}/fichas`, fichaId));
                        window.unifiedApp.showMessage('Ficha removida da nuvem.', 'info');
                        return true;
                    } catch (e) {
                        console.error("Erro ao remover ficha do Firestore: ", e);
                        window.unifiedApp.showMessage('Erro ao remover ficha da nuvem: ' + e.message, 'error');
                        return false;
                    }
                },

                async saveWeeklyReportDataToFirestore(data) {
                    if (!window.db || !window.userId) {
                        window.unifiedApp.showMessage('Firebase não inicializado ou usuário não autenticado. Não foi possível exportar dados.', 'error');
                        return;
                    }
                    window.unifiedApp.toggleLoadingSpinner('export-weekly', true);
                    try {
                        const docRef = window.doc(window.db, `artifacts/${window.appId}/users/${window.userId}/weeklyReportsAggregated/currentWeek`);
                        await window.setDoc(docRef, data);
                        window.unifiedApp.showMessage('Dados agregados para fechamento semanal salvos no Firestore!', 'success');
                    } catch (e) {
                        console.error("Erro ao salvar dados agregados no Firestore: ", e);
                        window.unifiedApp.showMessage('Erro ao salvar dados agregados na nuvem: ' + e.message, 'error');
                    } finally {
                        window.unifiedApp.toggleLoadingSpinner('export-weekly', false);
                    }
                },

                addServiceRow(serviceName = '', serviceValue = '', paymentMethod = 'pix') {
                    const container = document.getElementById('services-container');
                    const newServiceDiv = document.createElement('div');
                    newServiceDiv.className = 'flex items-center gap-2 mb-2 service-row';
                    newServiceDiv.innerHTML = `
                        <input type="text" placeholder="Nome do Serviço" value="${serviceName}" 
                            class="service-name form-input flex-grow min-w-[100px]" oninput="window.unifiedApp.fichasApp.saveLocalData()">
                        <input type="number" step="0.01" min="0" placeholder="Valor" value="${serviceValue}" 
                            class="service-value form-input w-28 text-right" oninput="window.unifiedApp.fichasApp.saveLocalData()">
                        <select class="payment-method form-input w-24" onchange="window.unifiedApp.fichasApp.saveLocalData()">
                            <option value="pix" ${paymentMethod === 'pix' ? 'selected' : ''}>Pix</option>
                            <option value="debito" ${paymentMethod === 'debito' ? 'selected' : ''}>Débito</option>
                            <option value="credito_1x" ${paymentMethod === 'credito_1x' ? 'selected' : ''}>Crédito 1x</option>
                            <option value="credito_2x" ${paymentMethod === 'credito_2x' ? 'selected' : ''}>Crédito 2x</option>
                            <option value="credito_3x" ${paymentMethod === 'credito_3x' ? 'selected' : ''}>Crédito 3x</option>
                            <option value="dinheiro" ${paymentMethod === 'dinheiro' ? 'selected' : ''}>Dinheiro</option>
                        </select>
                        <button onclick="window.unifiedApp.fichasApp.removeRow(this)" class="btn btn-danger p-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    container.appendChild(newServiceDiv);
                },

                addProductSoldRow(productName = '', productValue = '', paymentMethod = 'pix') {
                    const container = document.getElementById('products-sold-container');
                    const newProductDiv = document.createElement('div');
                    newProductDiv.className = 'flex items-center gap-2 mb-2 product-sold-row';
                    newProductDiv.innerHTML = `
                        <input type="text" placeholder="Nome do Produto" value="${productName}" 
                            class="product-sold-name form-input flex-grow min-w-[100px]" oninput="window.unifiedApp.fichasApp.saveLocalData()">
                        <input type="number" step="0.01" min="0" placeholder="Valor" value="${productValue}" 
                            class="product-sold-value form-input w-28 text-right" oninput="window.unifiedApp.fichasApp.saveLocalData()">
                        <select class="payment-method form-input w-24" onchange="window.unifiedApp.fichasApp.saveLocalData()">
                            <option value="pix" ${paymentMethod === 'pix' ? 'selected' : ''}>Pix</option>
                            <option value="debito" ${paymentMethod === 'debito' ? 'selected' : ''}>Débito</option>
                            <option value="credito_1x" ${paymentMethod === 'credito_1x' ? 'selected' : ''}>Crédito 1x</option>
                            <option value="credito_2x" ${paymentMethod === 'credito_2x' ? 'selected' : ''}>Crédito 2x</option>
                            <option value="credito_3x" ${paymentMethod === 'credito_3x' ? 'selected' : ''}>Crédito 3x</option>
                            <option value="dinheiro" ${paymentMethod === 'dinheiro' ? 'selected' : ''}>Dinheiro</option>
                        </select>
                        <button onclick="window.unifiedApp.fichasApp.removeRow(this)" class="btn btn-danger p-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    container.appendChild(newProductDiv);
                },

                removeRow(button) {
                    button.closest('.flex').remove();
                    this.saveLocalData();
                },

                clearInputFields() {
                    document.getElementById('clientName').value = '';
                    document.getElementById('professionalName').value = '';
                    document.getElementById('services-container').innerHTML = ''; 
                    document.getElementById('products-sold-container').innerHTML = ''; 
                    this.addServiceRow(); 
                    this.addProductSoldRow(); 
                    this.saveLocalData();
                },

                async addFicha() {
                    if (!window.db || !window.userId || !window.fichasCollectionRef) {
                        window.unifiedApp.showMessage('Firebase não inicializado ou usuário não autenticado. Por favor, aguarde alguns segundos e tente novamente.', 'error');
                        return;
                    }
                    const clientName = document.getElementById('clientName').value.trim();
                    const professionalName = document.getElementById('professionalName').value.trim();
                    if (!clientName || !professionalName) {
                        window.unifiedApp.showMessage('Por favor, preencha o nome da Cliente e da Profissional.', 'error');
                        return;
                    }
                    const services = [];
                    document.querySelectorAll('#fichas-clientes-app .service-row').forEach(row => {
                        const name = row.querySelector('.service-name').value.trim();
                        const value = parseFloat(row.querySelector('.service-value').value) || 0;
                        const paymentMethod = row.querySelector('.payment-method').value;
                        if (name && value > 0) {
                            services.push({ name, value, paymentMethod });
                        }
                    });
                    const productsSold = [];
                    document.querySelectorAll('#fichas-clientes-app .product-sold-row').forEach(row => {
                        const name = row.querySelector('.product-sold-name').value.trim();
                        const value = parseFloat(row.querySelector('.product-sold-value').value) || 0;
                        const paymentMethod = row.querySelector('.payment-method').value;
                        if (name && value > 0) {
                            productsSold.push({ name, value, paymentMethod });
                        }
                    });
                    if (services.length === 0 && productsSold.length === 0) {
                        window.unifiedApp.showMessage('Por favor, adicione pelo menos um serviço ou um produto vendido.', 'error');
                        return;
                    }
                    const totalFicha = services.reduce((sum, s) => sum + s.value, 0) + productsSold.reduce((sum, p) => sum + p.value, 0);
                    const newFicha = {
                        clientName, professionalName, services, productsSold, totalFicha,
                        timestamp: new Date().toISOString() 
                    };
                    const fichaId = await this.saveFichaToFirestore(newFicha);
                    if (fichaId) {
                        this.fichas.push({ id: fichaId, ...newFicha }); 
                        this.renderFichasTable();
                        this.clearInputFields();
                        this.saveLocalData();
                    }
                },

                async removeFicha(index) {
                    const fichaToRemove = this.fichas[index];
                    if (!fichaToRemove || !fichaToRemove.id) {
                        window.unifiedApp.showMessage('Erro: Ficha ou ID da ficha não encontrado para remoção.', 'error');
                        return;
                    }
                    const removed = await this.removeFichaFromFirestore(fichaToRemove.id);
                    if (removed) {
                        this.fichas.splice(index, 1); 
                        this.renderFichasTable();
                        this.saveLocalData();
                    }
                },

                async clearAllFichas() {
                    window.unifiedApp.showConfirmModal('Tem certeza que deseja limpar todas as fichas? Esta ação não pode ser desfeita.', 'clearAllFichas');
                },

                async clearAllFichasFirestoreOnly() {
                    if (!window.db || !window.userId || !window.fichasCollectionRef) {
                        window.unifiedApp.showMessage('Firebase não inicializado ou usuário não autenticado. Não foi possível limpar as fichas.', 'error');
                        return;
                    }
                    window.unifiedApp.showMessage('Limpando todas as fichas no Firestore...', 'info');
                    window.unifiedApp.toggleLoadingSpinner('clear-fichas', true);
                    try {
                        const querySnapshot = await window.getDocs(window.fichasCollectionRef);
                        const deletePromises = [];
                        querySnapshot.forEach((doc) => {
                            deletePromises.push(window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/users/${window.userId}/fichas`, doc.id)));
                        });
                        await Promise.all(deletePromises);
                        this.fichas = []; 
                        this.renderFichasTable();
                        window.unifiedApp.showMessage('Todas as fichas foram limpas (Firestore).', 'success');
                        this.saveLocalData();
                    } catch (e) {
                        console.error("Erro ao limpar todas as fichas do Firestore: ", e);
                        window.unifiedApp.showMessage('Erro ao limpar todas as fichas da nuvem: ' + e.message, 'error');
                    } finally {
                        window.unifiedApp.toggleLoadingSpinner('clear-fichas', false);
                    }
                },

                renderFichasTable() {
                    const tableBody = document.getElementById('fichas-table-body');
                    tableBody.innerHTML = ''; 
                    if (this.fichas.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="6" class="py-3 px-6 text-center text-gray-500">Nenhuma ficha registrada ainda.</td></tr>`;
                        return;
                    }
                    this.fichas.forEach((ficha, index) => {
                        const row = tableBody.insertRow();
                        row.className = 'border-b border-gray-200 hover:bg-gray-100';
                        const clientCell = row.insertCell();
                        clientCell.className = 'py-3 px-6 text-left whitespace-nowrap';
                        clientCell.textContent = ficha.clientName;
                        const professionalCell = row.insertCell();
                        professionalCell.className = 'py-3 px-6 text-left whitespace-nowrap';
                        professionalCell.textContent = ficha.professionalName;
                        const servicesCell = row.insertCell();
                        servicesCell.className = 'py-3 px-6 text-left';
                        servicesCell.innerHTML = ficha.services.map(s => `
                            <p>${s.name} (R$ ${s.value.toFixed(2).replace('.', ',')}) - ${this.formatPaymentMethodForDisplay(s.paymentMethod)}</p>
                        `).join('');
                        if (ficha.services.length === 0) servicesCell.textContent = 'Nenhum';
                        const productsCell = row.insertCell();
                        productsCell.className = 'py-3 px-6 text-left';
                        productsCell.innerHTML = ficha.productsSold.map(p => `
                            <p>${p.name} (R$ ${p.value.toFixed(2).replace('.', ',')}) - ${this.formatPaymentMethodForDisplay(p.paymentMethod)}</p>
                        `).join('');
                        if (ficha.productsSold.length === 0) productsCell.textContent = 'Nenhum';
                        const totalCell = row.insertCell();
                        totalCell.className = 'py-3 px-6 text-center font-bold';
                        totalCell.textContent = `R$ ${ficha.totalFicha.toFixed(2).replace('.', ',')}`;
                        const actionsCell = row.insertCell();
                        actionsCell.className = 'py-3 px-6 text-center';
                        actionsCell.innerHTML = `
                            <button onclick="window.unifiedApp.fichasApp.removeFicha(${index})" class="text-red-600 hover:text-red-800 font-medium">Remover</button>
                        `;
                    });
                },

                async generateAndExportWeeklyData() {
                    if (!window.db || !window.userId || !window.fichasCollectionRef) {
                        window.unifiedApp.showMessage('Firebase não inicializado ou usuário não autenticado. Não foi possível exportar dados para fechamento semanal.', 'error');
                        console.error("Erro: Firebase não inicializado ou usuário não autenticado ao tentar exportar dados semanais.");
                        return;
                    }
                    window.unifiedApp.showMessage('Exportando dados para fechamento semanal...', 'info');
                    window.unifiedApp.toggleLoadingSpinner('export-weekly', true);
                    const aggregatedData = {
                        collaborators: {}, products: []
                    };
                    this.fichas.forEach(ficha => {
                        const professionalName = ficha.professionalName.trim();
                        if (!aggregatedData.collaborators[professionalName]) {
                            aggregatedData.collaborators[professionalName] = {
                                name: professionalName, clients: [], discountPercentage: 0.30, observations: ''
                            };
                        }
                        ficha.services.forEach(service => {
                            aggregatedData.collaborators[professionalName].clients.push({
                                name: ficha.clientName + ' - ' + service.name, value: service.value, paymentMethod: service.paymentMethod 
                            });
                        });
                        ficha.productsSold.forEach(product => {
                            aggregatedData.products.push({
                                clientName: ficha.clientName + ' - ' + product.name, value: product.value, paymentMethod: product.paymentMethod 
                            });
                        });
                    });
                    const finalCollaboratorsArray = Object.values(aggregatedData.collaborators);
                    const dataToExport = {
                        collaborators: finalCollaboratorsArray, products: aggregatedData.products,
                        lastUpdated: new Date().toISOString() 
                    };
                    await this.saveWeeklyReportDataToFirestore(dataToExport);
                    window.unifiedApp.toggleLoadingSpinner('export-weekly', false);
                },

                saveLocalData() {
                    localStorage.setItem('clientFichasData', JSON.stringify(this.fichas));
                },

                loadLocalData() {
                    const savedData = localStorage.getItem('clientFichasData');
                    if (savedData) {
                        try {
                            this.fichas = JSON.parse(savedData);
                            this.fichas.forEach(ficha => {
                                ficha.services.forEach(service => {
                                    if (service.paymentMethod === undefined || service.paymentMethod === 'credito') {
                                        service.paymentMethod = 'credito_1x';
                                    }
                                });
                                ficha.productsSold.forEach(product => {
                                    if (product.paymentMethod === undefined || product.paymentMethod === 'credito') {
                                        product.paymentMethod = 'credito_1x';
                                    }
                                });
                            });
                            this.renderFichasTable();
                            window.unifiedApp.showMessage('Fichas carregadas do salvamento automático.', 'info');
                        } catch (e) {
                            console.error("Erro ao carregar dados do localStorage:", e);
                            localStorage.removeItem('clientFichasData');
                            window.unifiedApp.showMessage('Erro ao carregar fichas salvas localmente. Dados corrompidos foram removidos.', 'error');
                        }
                    }
                },

                exportDataToFile() {
                    const dataToSave = this.fichas;
                    const jsonString = JSON.stringify(dataToSave, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `fichas_clientes_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    window.unifiedApp.showMessage('Fichas exportadas para arquivo local com sucesso!', 'success');
                },

                importDataFromFile() {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.json';
                    fileInput.onchange = (event) => {
                        const file = event.target.files[0];
                        if (!file) {
                            window.unifiedApp.showMessage('Nenhum arquivo selecionado.', 'info');
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const importedData = JSON.parse(e.target.result);
                                if (Array.isArray(importedData) && importedData.every(item => 
                                    typeof item === 'object' && item.clientName && item.professionalName && Array.isArray(item.services) && Array.isArray(item.productsSold))) {
                                    this.fichas = importedData;
                                    this.fichas.forEach(ficha => {
                                        ficha.services.forEach(service => {
                                            if (service.paymentMethod === undefined || service.paymentMethod === 'credito') {
                                                service.paymentMethod = 'credito_1x';
                                            }
                                        });
                                        ficha.productsSold.forEach(product => {
                                            if (product.paymentMethod === undefined || product.paymentMethod === 'credito') {
                                                product.paymentMethod = 'credito_1x';
                                            }
                                        });
                                    });
                                    this.renderFichasTable();
                                    this.saveLocalData();
                                    window.unifiedApp.showMessage('Fichas importadas de arquivo local com sucesso!', 'success');
                                } else {
                                    window.unifiedApp.showMessage('Formato de arquivo JSON inválido para fichas de cliente.', 'error');
                                }
                            } catch (parseError) {
                                window.unifiedApp.showMessage('Erro ao ler o arquivo: Não é um JSON válido.', 'error');
                            }
                        };
                        reader.readAsText(file);
                    };
                    fileInput.click();
                },

                formatPaymentMethodForDisplay(paymentMethod) {
                    switch (paymentMethod) {
                        case 'pix': return 'Pix';
                        case 'debito': return 'Débito';
                        case 'credito_1x': return 'Crédito (1x)';
                        case 'credito_2x': return 'Crédito (2x)';
                        case 'credito_3x': return 'Crédito (3x)';
                        case 'dinheiro': return 'Dinheiro';
                        default: return paymentMethod.toUpperCase();
                    }
                }
            },

            // --- Módulo: Controle de Estoque (productInventoryApp) ---
            productInventoryApp: {
                products: [],

                init() {
                    this.loadLocalData();
                    this.loadProductsFromFirestore();
                    this.enableButtons();
                },

                enableButtons() {
                    const authRequiredButtons = [
                        'addProductBtn', 'clearAllProductsBtn', 'saveToCloudBtn', 'loadFromCloudBtn'
                    ];
                    authRequiredButtons.forEach(id => {
                        const btn = document.getElementById(id);
                        if (btn) btn.disabled = false;
                    });
                },

                disableAuthRequiredButtons() {
                    const authRequiredButtons = [
                        'addProductBtn', 'clearAllProductsBtn', 'saveToCloudBtn', 'loadFromCloudBtn'
                    ];
                    authRequiredButtons.forEach(id => {
                        const btn = document.getElementById(id);
                        if (btn) btn.disabled = true;
                    });
                },

                async saveProductToFirestore(productData) {
                    if (!window.db || !window.userId || !window.productsCollectionRef) {
                        window.unifiedApp.showMessage('Firebase não inicializado ou usuário não autenticado. Não foi possível salvar o produto.', 'error');
                        return null;
                    }
                    window.unifiedApp.toggleLoadingSpinner('add-product', true);
                    try {
                        const docRef = await window.addDoc(window.productsCollectionRef, productData);
                        window.unifiedApp.showMessage('Produto registrado e salvo na nuvem!', 'success');
                        return docRef.id;
                    } catch (e) {
                        console.error("Erro ao adicionar produto ao Firestore: ", e);
                        window.unifiedApp.showMessage('Erro ao salvar produto na nuvem: ' + e.message, 'error');
                        return null;
                    } finally {
                        window.unifiedApp.toggleLoadingSpinner('add-product', false);
                    }
                },

                async loadProductsFromFirestore() {
                    if (!window.db || !window.userId || !window.productsCollectionRef) {
                        console.log('Firebase não inicializado ou usuário não autenticado. Não foi possível carregar os produtos.');
                        return;
                    }
                    window.unifiedApp.showMessage('Carregando produtos do Firestore...', 'info');
                    window.unifiedApp.toggleLoadingSpinner('load-cloud', true);
                    try {
                        this.products = []; 
                        const querySnapshot = await window.getDocs(window.productsCollectionRef);
                        querySnapshot.forEach((doc) => {
                            this.products.push({ id: doc.id, ...doc.data() });
                        });
                        this.renderProductsTable();
                        window.unifiedApp.showMessage('Produtos carregados do Firestore com sucesso!', 'success');
                    } catch (e) {
                        console.error("Erro ao carregar produtos do Firestore: ", e);
                        window.unifiedApp.showMessage('Erro ao carregar produtos da nuvem: ' + e.message, 'error');
                    } finally {
                        window.unifiedApp.toggleLoadingSpinner('load-cloud', false);
                    }
                },

                async updateProductInFirestore(productId, newData) {
                    if (!window.db || !window.userId) {
                        window.unifiedApp.showMessage('Firebase não inicializado ou usuário não autenticado. Não foi possível atualizar o produto.', 'error');
                        return false;
                    }
                    try {
                        await window.setDoc(window.doc(window.db, `artifacts/${window.appId}/users/${window.userId}/products`, productId), newData, { merge: true });
                        return true;
                    } catch (e) {
                        console.error("Erro ao atualizar produto no Firestore: ", e);
                        window.unifiedApp.showMessage('Erro ao atualizar produto na nuvem: ' + e.message, 'error');
                        return false;
                    }
                },

                async deleteProductFromFirestore(productId) {
                    if (!window.db || !window.userId) {
                        window.unifiedApp.showMessage('Firebase não inicializado ou usuário não autenticado. Não foi possível remover o produto.', 'error');
                        return false;
                    }
                    try {
                        await window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/users/${window.userId}/products`, productId));
                        window.unifiedApp.showMessage('Produto removido da nuvem.', 'info');
                        return true;
                    } catch (e) {
                        console.error("Erro ao remover produto do Firestore: ", e);
                        window.unifiedApp.showMessage('Erro ao remover produto da nuvem: ' + e.message, 'error');
                        return false;
                    }
                },

                async saveAllProductsToFirestore() {
                    if (!window.db || !window.userId || !window.productsCollectionRef) {
                        window.unifiedApp.showMessage('Firebase não inicializado ou usuário não autenticado. Não foi possível salvar na nuvem.', 'error');
                        return;
                    }
                    window.unifiedApp.showMessage('Salvando todos os produtos na nuvem...', 'info');
                    window.unifiedApp.toggleLoadingSpinner('save-cloud', true);
                    try {
                        const querySnapshot = await window.getDocs(window.productsCollectionRef);
                        const deletePromises = [];
                        querySnapshot.forEach((doc) => {
                            deletePromises.push(window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/users/${window.userId}/products`, doc.id)));
                        });
                        await Promise.all(deletePromises);

                        const addPromises = [];
                        this.products.forEach(product => {
                            const { id, ...productDataWithoutId } = product; 
                            addPromises.push(window.addDoc(window.productsCollectionRef, productDataWithoutId));
                        });
                        await Promise.all(addPromises);

                        window.unifiedApp.showMessage('Todos os produtos foram salvos na nuvem!', 'success');
                    } catch (e) {
                        console.error("Erro ao salvar todos os produtos no Firestore: ", e);
                        window.unifiedApp.showMessage('Erro ao salvar todos os produtos na nuvem: ' + e.message, 'error');
                    } finally {
                        window.unifiedApp.toggleLoadingSpinner('save-cloud', false);
                    }
                },

                async clearAllProducts() {
                    window.unifiedApp.showConfirmModal('Tem certeza que deseja limpar todos os produtos? Esta ação não pode ser desfeita.', 'clearAllProducts');
                },

                async clearAllProductsFirestoreOnly() {
                    if (!window.db || !window.userId || !window.productsCollectionRef) {
                        window.unifiedApp.showMessage('Firebase não inicializado ou usuário não autenticado. Não foi possível limpar os produtos.', 'error');
                        return;
                    }
                    window.unifiedApp.showMessage('Limpando todos os produtos...', 'info');
                    window.unifiedApp.toggleLoadingSpinner('clear-products', true);
                    try {
                        const querySnapshot = await window.getDocs(window.productsCollectionRef);
                        const deletePromises = [];
                        querySnapshot.forEach((doc) => {
                            deletePromises.push(window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/users/${window.userId}/products`, doc.id)));
                        });
                        await Promise.all(deletePromises);
                        this.products = []; 
                        this.renderProductsTable();
                        window.unifiedApp.showMessage('Todos os produtos foram limpos (local e nuvem).', 'success');
                        this.saveLocalData(); 
                    } catch (e) {
                        console.error("Erro ao limpar todos os produtos do Firestore: ", e);
                        window.unifiedApp.showMessage('Erro ao limpar todos os produtos da nuvem: ' + e.message, 'error');
                    } finally {
                        window.unifiedApp.toggleLoadingSpinner('clear-products', false);
                    }
                },

                async addProduct() {
                    if (!window.db || !window.userId || !window.productsCollectionRef) {
                        window.unifiedApp.showMessage('Firebase não inicializado ou usuário não autenticado. Por favor, aguarde alguns segundos e tente novamente.', 'error');
                        return;
                    }
                    const name = document.getElementById('productName').value.trim();
                    const quantity = parseInt(document.getElementById('productQuantity').value) || 0;
                    const unitValue = parseFloat(document.getElementById('productUnitValue').value) || 0;
                    if (!name) {
                        window.unifiedApp.showMessage('Por favor, preencha o nome do produto.', 'error');
                        return;
                    }
                    const newProduct = {
                        name, quantity, unitValue,
                        timestamp: new Date().toISOString() 
                    };
                    const productId = await this.saveProductToFirestore(newProduct);
                    if (productId) {
                        this.products.push({ id: productId, ...newProduct }); 
                        this.renderProductsTable();
                        this.clearInputFields();
                        this.saveLocalData(); 
                    }
                },

                async removeProduct(index) {
                    const productToRemove = this.products[index];
                    if (!productToRemove || !productToRemove.id) {
                        window.unifiedApp.showMessage('Erro: Produto ou ID do produto não encontrado para remoção.', 'error');
                        return;
                    }
                    const removed = await this.deleteProductFromFirestore(productToRemove.id);
                    if (removed) {
                        this.products.splice(index, 1); 
                        this.renderProductsTable();
                        this.saveLocalData(); 
                    }
                },

                async updateProductQuantity(index, change) {
                    const product = this.products[index];
                    if (!product) return;
                    const newQuantity = product.quantity + change;
                    if (newQuantity < 0) {
                        window.unifiedApp.showMessage('A quantidade não pode ser negativa.', 'warning');
                        return;
                    }
                    product.quantity = newQuantity;
                    await this.updateProductInFirestore(product.id, { quantity: newQuantity });
                    this.renderProductsTable();
                    this.saveLocalData();
                },

                clearInputFields() {
                    document.getElementById('productName').value = '';
                    document.getElementById('productQuantity').value = 0;
                    document.getElementById('productUnitValue').value = '';
                },

                renderProductsTable() {
                    const tableBody = document.getElementById('products-table-body');
                    tableBody.innerHTML = ''; 
                    if (this.products.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="6" class="py-3 px-6 text-center text-gray-500">Nenhum produto registrado ainda.</td></tr>`;
                        this.calculateTotalInventoryValue();
                        return;
                    }
                    this.products.forEach((product, index) => {
                        const row = tableBody.insertRow();
                        row.className = 'border-b border-gray-200 hover:bg-gray-100';
                        const totalValue = product.quantity * product.unitValue;
                        const status = product.quantity > 0 ? 'Em Estoque' : 'Acabou';
                        const statusColor = product.quantity > 0 ? 'text-green-600 font-semibold' : 'text-red-600 font-semibold';

                        row.innerHTML = `
                            <td class="py-3 px-6 text-left whitespace-nowrap">${product.name}</td>
                            <td class="py-3 px-6 text-center">
                                <div class="flex items-center justify-center gap-2">
                                    <button onclick="window.unifiedApp.productInventoryApp.updateProductQuantity(${index}, -1)" class="btn btn-gray p-1 rounded-full w-8 h-8 flex items-center justify-center">-</button>
                                    <span>${product.quantity}</span>
                                    <button onclick="window.unifiedApp.productInventoryApp.updateProductQuantity(${index}, 1)" class="btn btn-gray p-1 rounded-full w-8 h-8 flex items-center justify-center">+</button>
                                </div>
                            </td>
                            <td class="py-3 px-6 text-right">${product.unitValue.toFixed(2).replace('.', ',')}</td>
                            <td class="py-3 px-6 text-right font-bold">R$ ${totalValue.toFixed(2).replace('.', ',')}</td>
                            <td class="py-3 px-6 text-center ${statusColor}">${status}</td>
                            <td class="py-3 px-6 text-center">
                                <button onclick="window.unifiedApp.productInventoryApp.removeProduct(${index})" class="text-red-600 hover:text-red-800 font-medium">Remover</button>
                            </td>
                        `;
                    });
                    this.calculateTotalInventoryValue();
                },

                calculateTotalInventoryValue() {
                    const total = this.products.reduce((sum, product) => sum + (product.quantity * product.unitValue), 0);
                    document.getElementById('total-inventory-value').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
                },

                saveLocalData() {
                    localStorage.setItem('productInventoryData', JSON.stringify(this.products));
                },

                loadLocalData() {
                    const savedData = localStorage.getItem('productInventoryData');
                    if (savedData) {
                        try {
                            this.products = JSON.parse(savedData);
                            this.products.forEach(product => {
                                product.unitValue = parseFloat(product.unitValue) || 0;
                                product.quantity = parseInt(product.quantity) || 0;
                            });
                            this.renderProductsTable();
                            window.unifiedApp.showMessage('Estoque carregado do salvamento automático.', 'info');
                        } catch (e) {
                            console.error("Erro ao carregar dados do localStorage:", e);
                            localStorage.removeItem('productInventoryData');
                            window.unifiedApp.showMessage('Erro ao carregar estoque salvo localmente. Dados corrompidos foram removidos.', 'error');
                        }
                    }
                },

                exportDataToFile() {
                    const dataToSave = this.products; 
                    const jsonString = JSON.stringify(dataToSave, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `estoque_produtos_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    window.unifiedApp.showMessage('Estoque exportado para arquivo local com sucesso!', 'success');
                },

                importDataFromFile() {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.json';
                    fileInput.onchange = (event) => {
                        const file = event.target.files[0];
                        if (!file) {
                            window.unifiedApp.showMessage('Nenhum arquivo selecionado.', 'info');
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const importedData = JSON.parse(e.target.result);
                                if (Array.isArray(importedData) && importedData.every(item => 
                                    typeof item === 'object' && item.name && typeof item.quantity === 'number' && typeof item.unitValue === 'number')) {
                                    this.products = importedData;
                                    this.renderProductsTable();
                                    this.saveLocalData(); 
                                    window.unifiedApp.showMessage('Estoque importado de arquivo local com sucesso!', 'success');
                                } else {
                                    window.unifiedApp.showMessage('Formato de arquivo JSON inválido para estoque de produtos.', 'error');
                                }
                            } catch (parseError) {
                                window.unifiedApp.showMessage('Erro ao ler o arquivo: Não é um JSON válido.', 'error');
                            }
                        };
                        reader.readAsText(file);
                    };
                    fileInput.click();
                }
            },

            /**
             * Alterna a visibilidade de um spinner de carregamento e seu ícone associado.
             * Esta função é unificada para ser usada por todos os módulos.
             * @param {string} type - O tipo de operação ('save', 'load', 'fichas', 'clear', 'add-ficha', 'export-weekly', 'add-product', 'clear-products', 'save-cloud', 'load-cloud').
             * @param {boolean} show - True para mostrar o spinner, false para ocultar.
             */
            toggleLoadingSpinner(type, show) {
                const spinner = document.getElementById(`${type}-spinner`);
                const icon = document.getElementById(`${type}-icon`);
                if (spinner && icon) {
                    spinner.classList.toggle('hidden', !show);
                    icon.classList.toggle('hidden', show);
                }
            }
        };
    </script>
</body>
</html>

