<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fechamento Semanal do Salão</title>
    
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF CDN for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            deleteDoc, 
            collection, 
            query, 
            where, 
            getDocs, 
            addDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- INÍCIO DA CONFIGURAÇÃO DE ACESSO ---
        const authorizedEmails = [
            "djmkbrasil@gmail.com",
            "djmkapple@gmail.com",
            "frankokott@gmail.com",
            "gabrielastephane11@gmail.com",
            "cibemarchi@gmail.com"
        ];
        
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD7FwQZspQNYZmNlQv8oNglccBXHmduW5w", 
            authDomain: "sistema-do-salao.firebaseapp.com", 
            projectId: "sistema-do-salao",   
            storageBucket: "sistema-do-salao.firebasestorage.app", 
            messagingSenderId: "395887083088", 
            appId: "1:395887083088:web:3a41fd836cc59a976ddb55", 
        };
        
        window.appId = 'salao-fechamento-app'; // ID Fixo para o app compartilhado
        window.app = initializeApp(firebaseConfig);
        window.db = getFirestore(window.app);
        window.auth = getAuth(window.app);
        window.currentUser = null; // Armazenará o objeto do usuário logado
        window.userId = null; // Manter para compatibilidade com o código original

        async function initializeFirebase() {
            try {
                await setPersistence(window.auth, browserLocalPersistence);
                console.log("Firebase inicializado com sucesso");

                onAuthStateChanged(window.auth, (user) => {
                    const appContainer = document.getElementById('app-container');
                    const loginContainer = document.getElementById('login-container');
                    const deniedContainer = document.getElementById('denied-container');

                    if (user && authorizedEmails.includes(user.email)) {
                        window.currentUser = user;
                        window.userId = user.uid; // Definindo o userId para o app original

                        appContainer.style.display = 'block';
                        loginContainer.style.display = 'none';
                        deniedContainer.style.display = 'none';

                        if (window.db) {
                            initializeAppLogic();
                        } else {
                            console.error("Banco de dados não disponível.");
                            showMessage('Erro: Banco de dados não disponível.', 'error');
                        }
                    } else if (user && !authorizedEmails.includes(user.email)) {
                        window.currentUser = null;
                        window.userId = null;
                        appContainer.style.display = 'none';
                        loginContainer.style.display = 'none';
                        deniedContainer.style.display = 'block';
                        document.getElementById('denied-user-email').textContent = user.email;
                    } else {
                        window.currentUser = null;
                        window.userId = null;
                        appContainer.style.display = 'none';
                        deniedContainer.style.display = 'none';
                        loginContainer.style.display = 'flex';
                    }
                });
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                if(window.showMessage){
                    showMessage('Erro ao inicializar o Firebase.', 'error');
                }
            }
        }

        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(window.auth, provider);
            } catch (error) {
                console.error("Erro ao fazer login com Google:", error);
                if (error.code === 'auth/unauthorized-domain') {
                    alert('ERRO DE CONFIGURAÇÃO: O domínio deste site não está autorizado no seu projeto Firebase. Por favor, acesse o painel do Firebase > Authentication > Settings > Authorized domains e adicione o domínio a partir do qual você está acessando esta aplicação.');
                } else if (window.showMessage) {
                    showMessage('Erro ao autenticar: ' + error.message, 'error');
                } else {
                    alert('Erro ao autenticar: ' + error.message);
                }
            }
        }

        async function signOutUser() {
            try {
                await signOut(window.auth);
                // O listener onAuthStateChanged cuidará do resto
            } catch (error) {
                console.error("Erro ao sair:", error);
                if (window.salonApp) {
                   window.salonApp.showMessage('Erro ao sair: ' + error.message, 'error');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', initializeFirebase);

        window.doc = doc; window.getDoc = getDoc; window.setDoc = setDoc; window.deleteDoc = deleteDoc;
        window.collection = collection; window.query = query; window.where = where; window.getDocs = getDocs;
        window.addDoc = addDoc; window.signInWithGoogle = signInWithGoogle; window.signOutUser = signOutUser;
    </script>
    
    <!-- O CSS original completo -->
     <style>
        :root {
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --border-radius: 0.75rem;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            line-height: 1.6;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .content {
            padding: 2rem;
        }

        .section {
            background: var(--gray-50);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--gray-200);
            transition: var(--transition);
        }

        .section:hover {
            box-shadow: var(--shadow-md);
        }

        .section-header {
            display: flex;
            justify-content: space-between; /* Changed from 'between' to 'space-between' for clarity */
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-800);
            margin: 0;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            min-height: 44px; /* Touch-friendly minimum */
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #7c3aed;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #059669;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background-color: #d97706;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-gray {
            background-color: var(--gray-300);
            color: var(--gray-800);
        }

        .btn-gray:hover:not(:disabled) {
            background-color: var(--gray-400);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-full {
            width: 100%;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: var(--transition);
            background-color: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-input::-webkit-outer-spin-button,
        .form-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .form-input[type=number] {
            -moz-appearance: textfield;
        }

        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: var(--transition);
            background-color: white;
            resize: vertical;
            min-height: 80px;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .grid {
            display: grid;
            gap: 1rem;
        }

        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .flex-wrap {
            flex-wrap: wrap;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-3 {
            gap: 0.75rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .p-4 {
            padding: 1rem;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-lg {
            font-size: 1.125rem;
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .font-medium {
            font-weight: 500;
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-bold {
            font-weight: 700;
        }

        .text-gray-500 {
            color: var(--gray-500);
        }

        .text-gray-600 {
            color: var(--gray-600);
        }

        .text-gray-700 {
            color: var(--gray-700);
        }

        .text-gray-800 {
            color: var(--gray-800);
        }

        .collaborator-block {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        .collaborator-block:hover {
            box-shadow: var(--shadow-md);
        }

        .client-row {
            background: var(--gray-50);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--gray-200);
        }

        .product-row {
            background: var(--gray-50);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--gray-200);
        }

        .observation-area {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }

        .observation-area.visible {
            display: block;
        }

        .message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 500;
            animation: slideInDown 0.3s ease-out;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .message-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .message-info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            padding: 1rem;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow-xl);
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .saved-reports-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .report-item {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .report-item:last-child {
            border-bottom: none;
        }

        .report-item:hover {
            background-color: var(--gray-50);
        }

        .report-item.selected {
            background-color: #e0e7ff;
            font-weight: 600;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }

            .header {
                padding: 1.5rem 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .content {
                padding: 1rem;
            }

            .section {
                padding: 1rem;
            }

            .grid-cols-3,
            .grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }

            .flex {
                flex-direction: column;
            }

            .flex > * {
                width: 100%;
            }

            .btn {
                padding: 1rem;
                font-size: 1rem;
            }

            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }

            .modal-buttons {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.75rem;
            }

            .section-title {
                font-size: 1.25rem;
            }

            .collaborator-block {
                padding: 1rem;
            }

            .client-row,
            .product-row {
                padding: 0.5rem;
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .main-container {
                box-shadow: none;
                border-radius: 0;
            }

            .header {
                background: white !important;
                color: black !important;
            }

            .btn,
            .modal {
                display: none !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .section {
                border: 2px solid var(--gray-400);
            }

            .btn {
                border: 2px solid currentColor;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div id="login-container" class="main-container" style="display: flex; justify-content: center; align-items:center; padding: 4rem;">
        <div class="content text-center">
            <h1 class="text-2xl font-bold mb-2">Acesso ao Fechamento Semanal</h1>
            <p class="text-gray-600 mb-6">Por favor, faça login com uma conta autorizada para continuar.</p>
            <button onclick="signInWithGoogle()" class="btn btn-primary">
                 <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Entrar com Google
            </button>
        </div>
    </div>
    
    <div id="denied-container" class="main-container" style="display: none; justify-content: center; align-items:center; padding: 4rem;">
        <div class="content text-center">
            <h1 class="text-2xl font-bold text-red-600">Acesso Negado</h1>
            <p class="text-gray-600 my-4">O e-mail <b id="denied-user-email"></b> não tem permissão para acessar este sistema.</p>
            <button onclick="signOutUser()" class="btn btn-danger">Tentar com outra conta</button>
        </div>
    </div>
    
    <div id="app-container" class="main-container" style="display:none;">
        <header class="header">
            <h1>Espaço Fran Kokott</h1>
            <p style="font-size: 1.2rem; margin-top: 0.5rem; opacity: 0.9;">Fechamento Semanal</p>
        </header>
        <main class="content">
            <div class="section">
                <div class="flex items-center justify-between mb-4">
                    <p id="user-id-display" class="text-sm text-gray-500">Usuário: Carregando...</p>
                    <div id="auth-buttons" class="flex gap-2"></div>
                </div>
            </div>
            <div id="app-message" class="message" style="display: none;"></div>
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Informações do Fechamento</h2>
                </div>
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Data do Fechamento Semanal</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="form-group">
                            <label for="day" class="form-label">Dia</label>
                            <input type="number" id="day" min="1" max="31" placeholder="Dia" class="form-input" oninput="window.salonApp.updateDateDisplay(); window.salonApp.saveLocalData()">
                        </div>
                        <div class="form-group">
                            <label for="month" class="form-label">Mês</label>
                            <select id="month" class="form-input" onchange="window.salonApp.updateDateDisplay(); window.salonApp.saveLocalData()">
                                <option value="">Selecione o Mês</option>
                                <option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option><option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option><option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option><option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="year" class="form-label">Ano</label>
                            <input type="number" id="year" min="2000" max="2100" placeholder="Ano" class="form-input" oninput="window.salonApp.updateDateDisplay(); window.salonApp.saveLocalData()">
                        </div>
                    </div>
                    <p id="dateDisplay" class="text-center text-lg font-medium text-gray-800 mt-4"></p>
                </div>
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Opções de Dados</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="window.salonApp.exportDataToFile()" class="btn btn-secondary btn-full">Exportar Dados</button>
                        <button onclick="window.salonApp.importDataFromFile()" class="btn btn-secondary btn-full">Importar Dados</button>
                        <button id="saveToFirestoreBtn" onclick="window.salonApp.saveWeeklyClosingToFirestore()" class="btn btn-success btn-full" disabled>Salvar na Nuvem</button>
                        <button id="loadFromFirestoreBtn" onclick="window.salonApp.openSavedReportsModal()" class="btn btn-warning btn-full" disabled>Carregar da Nuvem</button>
                        <button id="loadDataFromFichasSystemBtn" onclick="window.salonApp.loadDataFromFichasSystem()" class="btn btn-info btn-full" disabled>Importar das Fichas</button>
                        <button id="clearAllDataBtn" onclick="window.salonApp.showClearConfirm()" class="btn btn-gray btn-full" disabled>Limpar Tudo</button>
                    </div>
                </div>
            </section>
            <section class="section">
                <div class="section-header"><h2 class="section-title">Colaboradoras</h2></div>
                <div id="collaborators-container"></div>
                <button onclick="window.salonApp.addCollaborator()" class="btn btn-primary btn-full mt-4">Adicionar Colaboradora</button>
            </section>
            <section class="section">
                <div class="section-header"><h2 class="section-title">Produtos Vendidos</h2></div>
                <div id="products-container"></div>
                <button onclick="window.salonApp.addProductRow()" class="btn btn-success btn-full mt-4">Adicionar Produto</button>
                <div class="mt-4 text-right"><p class="text-lg font-bold text-gray-800">Total Produtos: <span id="products-total">R$ 0,00</span></p></div>
            </section>
            <section class="section">
                <div class="section-header"><h2 class="section-title">Resumo Geral</h2></div>
                <div class="text-right mb-4">
                    <p class="text-lg font-bold text-gray-800">Total Bruto Geral: <span id="overall-gross-total">R$ 0,00</span></p>
                    <p class="text-lg font-bold text-red-600">Total Desconto Cartão: <span id="total-card-discount">R$ 0,00</span></p>
                    <p class="text-lg font-bold text-gray-800">Lucro Líquido do Salão: <span id="overall-net-total">R$ 0,00</span></p>
                </div>
                <div class="mt-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Detalhes da Contribuição:</h3>
                    <div id="detailed-contribution" class="text-gray-700"></div>
                </div>
            </section>
            <button onclick="window.salonApp.generatePDF()" class="btn btn-secondary btn-full text-lg font-bold">Gerar PDF do Fechamento</button>
        </main>
    </div>

    <!-- Modals -->
    <div id="custom-confirm-modal" class="modal"> <div class="modal-content"> <h3 class="text-lg font-semibold text-gray-800 mb-4">Confirmar Ação</h3> <p class="text-gray-600 mb-4" id="confirm-message">Tem certeza?</p> <p class="text-sm text-gray-500 mb-6">Esta ação não pode ser desfeita.</p> <div class="modal-buttons"> <button class="btn btn-gray" onclick="window.salonApp.handleConfirm(false)">Cancelar</button> <button class="btn btn-danger" onclick="window.salonApp.handleConfirm(true)">Confirmar</button> </div> </div> </div>
    <div id="saved-reports-modal" class="modal"> <div class="modal-content" style="max-width: 600px;"> <h3 class="text-xl font-semibold text-gray-800 mb-4">Escolha um Fechamento Salvo</h3> <div id="saved-reports-list" class="saved-reports-list"></div> <div class="modal-buttons"> <button class="btn btn-gray" onclick="window.salonApp.closeSavedReportsModal()">Fechar</button> <button class="btn btn-primary" onclick="window.salonApp.loadSelectedReport()">Carregar Selecionado</button> </div> </div> </div>
    <div id="attach-receipt-modal" class="modal"> <div class="modal-content"> <h3 class="text-lg font-semibold text-gray-800 mb-4">Anexar Comprovante?</h3> <p class="text-gray-600 mb-4">Deseja anexar um comprovante de pagamento ao PDF desta colaboradora?</p> <div class="modal-buttons"> <button class="btn btn-gray" onclick="window.salonApp.handleAttachReceiptChoice(false)">Não</button> <button class="btn btn-primary" onclick="window.salonApp.handleAttachReceiptChoice(true)">Sim</button> </div> </div> </div>

    <script>
        // Objeto principal da aplicação (código original completo)
        window.salonApp = {
            collaborators: [],
            products: [],
            salonName: "Espaço Fran Kokott",
            savedReports: [],
            selectedReportId: null,
            currentCollaboratorIndexForPdf: null,
            cardDiscountRates: { 'pix': 0, 'dinheiro': 0, 'debito': 0.0137, 'credito_1x': 0.0315, 'credito_2x': 0.0539, 'credito_3x': 0.0612 },
            init() { this.loadLocalData(); if (this.collaborators.length === 0) { this.collaborators.push({ name: '', clients: [{ name: '', value: 0, paymentMethod: 'pix' }], discountPercentage: 0.30, observations: '' }); } if (this.products.length === 0) { this.products.push({ clientName: '', value: 0, paymentMethod: 'pix' }); } this.renderAllUI(); this.updateDateDisplay(); this.calculateAllTotals(); this.enableButtons(); },
            enableButtons() { const authRequiredButtons = [ 'loadDataFromFichasSystemBtn', 'clearAllDataBtn', 'saveToFirestoreBtn', 'loadFromFirestoreBtn' ]; authRequiredButtons.forEach(id => { const btn = document.getElementById(id); if (btn) btn.disabled = false; }); },
            disableAuthRequiredButtons() { const authRequiredButtons = [ 'loadDataFromFichasSystemBtn', 'clearAllDataBtn', 'saveToFirestoreBtn', 'loadFromFirestoreBtn' ]; authRequiredButtons.forEach(id => { const btn = document.getElementById(id); if (btn) btn.disabled = true; }); },
            clearAllData() { this.collaborators = []; this.products = []; document.getElementById('day').value = ''; document.getElementById('month').value = ''; document.getElementById('year').value = ''; this.collaborators.push({ name: '', clients: [{ name: '', value: 0, paymentMethod: 'pix' }], discountPercentage: 0.30, observations: '' }); this.products.push({ clientName: '', value: 0, paymentMethod: 'pix' }); this.renderAllUI(); this.updateDateDisplay(); this.calculateAllTotals(); this.saveLocalData(); },
            renderAllUI() { document.getElementById('collaborators-container').innerHTML = ''; document.getElementById('products-container').innerHTML = ''; this.collaborators.forEach((collabData, index) => { this.addCollaboratorUI(collabData, index); }); this.products.forEach((productData, index) => { this.addProductRowUI(productData, index); }); this.updateDateDisplay(); this.calculateAllTotals(); },
            addCollaboratorUI(collabData, index) { const container = document.getElementById('collaborators-container'); const newCollaboratorDiv = document.createElement('div'); newCollaboratorDiv.className = 'collaborator-block'; newCollaboratorDiv.setAttribute('data-index', index); const hasName = collabData.name && collabData.name.trim() !== ''; newCollaboratorDiv.innerHTML = ` <div class="flex flex-wrap items-center justify-between mb-4 gap-2"> <input type="text" placeholder="Nome da Colaboradora" value="${collabData.name}" class="form-input flex-grow text-lg font-semibold min-w-[150px]" oninput="window.salonApp.updateCollaboratorName(${index}, this.value); window.salonApp.saveLocalData()"> <div class="flex items-center gap-2"> <label for="collab-discount-${index}" class="form-label">Parte Salão (%):</label> <input type="number" id="collab-discount-${index}" min="0" max="100" value="${(collabData.discountPercentage * 100).toFixed(0)}" class="form-input w-20 text-right" oninput="window.salonApp.updateCollaboratorDiscount(${index}, this.value); window.salonApp.saveLocalData()"> </div> <button onclick="window.salonApp.removeCollaborator(this)" class="btn btn-danger"> <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path> </svg> </button> </div> <h3 class="text-md font-medium text-gray-700 mb-2">Clientes</h3> <div class="clients-container" id="clients-container-${index}"></div> <button onclick="window.salonApp.addClientRow(${index})" class="btn btn-primary btn-full mt-4"> <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path> </svg> Adicionar Cliente </button> <div class="observation-area ${hasName ? 'visible' : ''}" id="observation-area-${index}"> <label for="observations-${index}" class="form-label"> <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path> </svg> Observações </label> <textarea id="observations-${index}" placeholder="Observações sobre a colaboradora..." class="form-textarea" oninput="window.salonApp.updateCollaboratorObservations(${index}, this.value); window.salonApp.saveLocalData()">${collabData.observations || ''}</textarea> </div> <div class="mt-4 text-right"> <p class="text-sm font-medium text-gray-700">Total Bruto Serviços: <span id="collab-gross-total-display-${index}">R$ 0,00</span></p> <p class="text-sm font-medium text-gray-700">Líquido P/ Comissão: <span id="collab-net-for-commission-${index}">R$ 0,00</span></p> <p class="text-sm font-medium text-gray-700">-Parte do Salão (<span id="collab-discount-percentage-display-${index}">${(collabData.discountPercentage * 100).toFixed(0)}</span>%): <span id="collab-salon-share-value-${index}">R$ 0,00</span></p> <p class="text-md font-bold text-gray-800">Total Líquido Colaboradora: <span id="collab-net-total-display-${index}">R$ 0,00</span></p> </div> <button onclick="window.salonApp.promptAttachReceipt(${index})" class="btn btn-secondary btn-full mt-4"> Gerar PDF da Colaboradora </button> `; container.appendChild(newCollaboratorDiv); collabData.clients.forEach((clientData, clientIndex) => { this.addClientRowUI(clientData, index, clientIndex); }); },
            addClientRowUI(clientData, collaboratorIndex, clientIndex) { const container = document.getElementById(`clients-container-${collaboratorIndex}`); const newClientDiv = document.createElement('div'); newClientDiv.className = 'client-row flex items-center gap-2 mb-2'; newClientDiv.innerHTML = ` <input type="text" placeholder="Nome do Cliente" value="${clientData.name}" class="form-input flex-grow min-w-[100px]" oninput="window.salonApp.updateClientData(${collaboratorIndex}, ${clientIndex}, 'name', this.value); window.salonApp.saveLocalData()"> <input type="number" step="0.01" min="0" placeholder="Valor" value="${clientData.value}" class="form-input w-28 text-right" oninput="window.salonApp.updateClientData(${collaboratorIndex}, ${clientIndex}, 'value', parseFloat(this.value) || 0); window.salonApp.saveLocalData()"> <select class="form-input w-24" onchange="window.salonApp.updateClientData(${collaboratorIndex}, ${clientIndex}, 'paymentMethod', this.value); window.salonApp.saveLocalData()"> <option value="pix" ${clientData.paymentMethod === 'pix' ? 'selected' : ''}>Pix</option> <option value="debito" ${clientData.paymentMethod === 'debito' ? 'selected' : ''}>Débito</option> <option value="credito_1x" ${clientData.paymentMethod === 'credito_1x' ? 'selected' : ''}>Crédito 1x</option> <option value="credito_2x" ${clientData.paymentMethod === 'credito_2x' ? 'selected' : ''}>Crédito 2x</option> <option value="credito_3x" ${clientData.paymentMethod === 'credito_3x' ? 'selected' : ''}>Crédito 3x</option> <option value="dinheiro" ${clientData.paymentMethod === 'dinheiro' ? 'selected' : ''}>Dinheiro</option> </select> <button onclick="window.salonApp.removeClientRow(this, ${collaboratorIndex}, ${clientIndex})" class="btn btn-danger"> <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path> </svg> </button> `; container.appendChild(newClientDiv); },
            addProductRowUI(productData, index) { const container = document.getElementById('products-container'); const newProductDiv = document.createElement('div'); newProductDiv.className = 'product-row flex items-center gap-2 mb-2'; newProductDiv.innerHTML = ` <input type="text" placeholder="Nome da Cliente" value="${productData.clientName}" class="form-input flex-grow min-w-[120px]" oninput="window.salonApp.updateProductData(${index}, 'clientName', this.value); window.salonApp.saveLocalData()"> <input type="number" step="0.01" min="0" placeholder="Valor" value="${productData.value}" class="form-input w-28 text-right" oninput="window.salonApp.updateProductData(${index}, 'value', parseFloat(this.value) || 0); window.salonApp.saveLocalData()"> <select class="form-input w-24" onchange="window.salonApp.updateProductData(${index}, 'paymentMethod', this.value); window.salonApp.saveLocalData()"> <option value="pix" ${productData.paymentMethod === 'pix' ? 'selected' : ''}>Pix</option> <option value="debito" ${productData.paymentMethod === 'debito' ? 'selected' : ''}>Débito</option> <option value="credito_1x" ${productData.paymentMethod === 'credito_1x' ? 'selected' : ''}>Crédito 1x</option> <option value="credito_2x" ${productData.paymentMethod === 'credito_2x' ? 'selected' : ''}>Crédito 2x</option> <option value="credito_3x" ${productData.paymentMethod === 'credito_3x' ? 'selected' : ''}>Crédito 3x</option> <option value="dinheiro" ${productData.paymentMethod === 'dinheiro' ? 'selected' : ''}>Dinheiro</option> </select> <button onclick="window.salonApp.removeProductRow(this, ${index})" class="btn btn-danger"> <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path> </svg> </button> `; container.appendChild(newProductDiv); },
            updateDateDisplay() { const day = document.getElementById('day').value; const month = document.getElementById('month').value; const year = document.getElementById('year').value; const monthName = document.getElementById('month').options[document.getElementById('month').selectedIndex]?.text || ''; const dateDisplay = document.getElementById('dateDisplay'); if (day && month && year) { dateDisplay.textContent = `Fechamento semana do dia ${day} de ${monthName} de ${year}`; } else { dateDisplay.textContent = 'Preencha a data para exibir.'; } },
            addCollaborator() { const newCollabData = { name: '', clients: [{ name: '', value: 0, paymentMethod: 'pix' }], discountPercentage: 0.30, observations: '' }; this.collaborators.push(newCollabData); this.renderAllUI(); this.saveLocalData(); },
            removeCollaborator(button) { const collabBlock = button.closest('.collaborator-block'); const indexToRemove = parseInt(collabBlock.getAttribute('data-index')); this.collaborators.splice(indexToRemove, 1); this.renderAllUI(); this.saveLocalData(); },
            updateCollaboratorName(index, name) { if (this.collaborators[index]) { this.collaborators[index].name = name; const observationArea = document.getElementById(`observation-area-${index}`); if (observationArea) { if (name && name.trim() !== '') { observationArea.classList.add('visible'); } else { observationArea.classList.remove('visible'); } } } },
            updateCollaboratorObservations(index, observations) { if (this.collaborators[index]) { this.collaborators[index].observations = observations; } },
            updateCollaboratorDiscount(index, value) { let newDiscount = parseFloat(value) / 100; if (isNaN(newDiscount) || newDiscount < 0 || newDiscount > 1) { newDiscount = 0.30; document.getElementById(`collab-discount-${index}`).value = 30; } if (this.collaborators[index]) { this.collaborators[index].discountPercentage = newDiscount; document.getElementById(`collab-discount-percentage-display-${index}`).textContent = (newDiscount * 100).toFixed(0); this.calculateCollaboratorTotal(index); } },
            addClientRow(collaboratorIndex) { if (this.collaborators[collaboratorIndex]) { this.collaborators[collaboratorIndex].clients.push({ name: '', value: 0, paymentMethod: 'pix' }); this.renderAllUI(); this.saveLocalData(); } },
            removeClientRow(button, collaboratorIndex, clientIndex) { if (this.collaborators[collaboratorIndex]) { this.collaborators[collaboratorIndex].clients.splice(clientIndex, 1); this.renderAllUI(); this.saveLocalData(); } },
            updateClientData(collaboratorIndex, clientIndex, field, value) { if (this.collaborators[collaboratorIndex] && this.collaborators[collaboratorIndex].clients[clientIndex]) { this.collaborators[collaboratorIndex].clients[clientIndex][field] = value; this.calculateCollaboratorTotal(collaboratorIndex); } },
            addProductRow() { this.products.push({ clientName: '', value: 0, paymentMethod: 'pix' }); this.renderAllUI(); this.saveLocalData(); },
            removeProductRow(button, productIndex) { this.products.splice(productIndex, 1); this.renderAllUI(); this.saveLocalData(); },
            updateProductData(index, field, value) { if (this.products[index]) { this.products[index][field] = value; this.calculateAllTotals(); } },
            calculateCardDiscount(value, paymentMethod) { return value * (this.cardDiscountRates[paymentMethod] || 0); },
            calculateCollaboratorTotal(collaboratorIndex) { let grossTotalServices = 0; const collab = this.collaborators[collaboratorIndex]; if (collab) { collab.clients.forEach(client => { grossTotalServices += client.value; }); const salonShareValue = grossTotalServices * collab.discountPercentage; const collabNetTotal = grossTotalServices - salonShareValue; document.getElementById(`collab-gross-total-display-${index}`).textContent = `R$ ${grossTotalServices.toFixed(2).replace('.', ',')}`; document.getElementById(`collab-net-for-commission-${index}`).textContent = `R$ ${grossTotalServices.toFixed(2).replace('.', ',')}`; document.getElementById(`collab-salon-share-value-${index}`).textContent = `R$ ${salonShareValue.toFixed(2).replace('.', ',')}`; document.getElementById(`collab-net-total-display-${index}`).textContent = `R$ ${collabNetTotal.toFixed(2).replace('.', ',')}`; } this.calculateAllTotals(); },
            calculateAllTotals() { let overallGrossRevenue = 0; let totalCardDiscount = 0; let totalCollaboratorNetPayments = 0; this.collaborators.forEach(collab => { let grossServices = 0; collab.clients.forEach(client => { grossServices += client.value; totalCardDiscount += this.calculateCardDiscount(client.value, client.paymentMethod); }); overallGrossRevenue += grossServices; const salonShareValue = grossServices * collab.discountPercentage; const collabNetTotal = grossServices - salonShareValue; totalCollaboratorNetPayments += collabNetTotal; }); this.products.forEach(product => { overallGrossRevenue += product.value; const productCardDiscount = this.calculateCardDiscount(product.value, product.paymentMethod); totalCardDiscount += productCardDiscount; }); const salonNetProfit = overallGrossRevenue - totalCardDiscount - totalCollaboratorNetPayments; document.getElementById('products-total').textContent = `R$ ${this.products.reduce((sum, p) => sum + p.value, 0).toFixed(2).replace('.', ',')}`; document.getElementById('overall-gross-total').textContent = `R$ ${overallGrossRevenue.toFixed(2).replace('.', ',')}`; document.getElementById('total-card-discount').textContent = `R$ ${totalCardDiscount.toFixed(2).replace('.', ',')}`; document.getElementById('overall-net-total').textContent = `R$ ${salonNetProfit.toFixed(2).replace('.', ',')}`; this.updateDetailedContribution(); },
            updateDetailedContribution() { const detailedContributionDiv = document.getElementById('detailed-contribution'); let content = ''; let totalGrossServices = 0; this.collaborators.forEach(collab => { totalGrossServices += collab.clients.reduce((sum, client) => sum + client.value, 0); }); if (this.collaborators.length > 0) { content += '<p class="font-bold">Serviços por Colaboradora (Bruto):</p>'; this.collaborators.forEach(collab => { const collabGrossTotal = collab.clients.reduce((sum, client) => sum + client.value, 0); if (totalGrossServices > 0) { const percentageOfServices = (collabGrossTotal / totalGrossServices) * 100; content += `<p class="ml-4">${collab.name || 'Colaboradora sem nome'}: R$ ${collabGrossTotal.toFixed(2).replace('.', ',')} (${percentageOfServices.toFixed(1)}% dos serviços)</p>`; } else { content += `<p class="ml-4">${collab.name || 'Colaboradora sem nome'}: R$ ${collabGrossTotal.toFixed(2).replace('.', ',')}</p>`; } }); } else { content += '<p>Nenhum serviço registrado.</p>'; } const overallProductsTotal = this.products.reduce((sum, product) => sum + product.value, 0); content += `<p class="font-bold mt-2">Venda de Produtos:</p>`; content += `<p class="ml-4">Total de Produtos: R$ ${overallProductsTotal.toFixed(2).replace('.', ',')}</p>`; detailedContributionDiv.innerHTML = content; },
            formatPaymentMethodForPdf(paymentMethod) { switch (paymentMethod) { case 'pix': return 'Pix'; case 'debito': return 'Débito'; case 'credito_1x': return 'Crédito (1x)'; case 'credito_2x': return 'Crédito (2x)'; case 'credito_3x': return 'Crédito (3x)'; case 'dinheiro': return 'Dinheiro'; default: return paymentMethod.toUpperCase(); } },
            promptAttachReceipt(collaboratorIndex) { this.currentCollaboratorIndexForPdf = collaboratorIndex; document.getElementById('attach-receipt-modal').style.display = 'flex'; },
            handleAttachReceiptChoice(attach) { document.getElementById('attach-receipt-modal').style.display = 'none'; const collaboratorIndex = this.currentCollaboratorIndexForPdf; if (attach) { const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = 'image/*'; fileInput.onchange = async (event) => { const file = event.target.files[0]; let imageDataUrl = null; if (file) { if (!file.type.startsWith('image/')) { this.showMessage('Por favor, selecione um arquivo de imagem (JPG, PNG, GIF, etc.) para o comprovante.', 'error'); } else { try { imageDataUrl = await new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => resolve(e.target.result); reader.onerror = (e) => reject(e); reader.readAsDataURL(file); }); } catch (error) { console.error("Erro ao ler o arquivo de imagem:", error); this.showMessage('Erro ao carregar a imagem do comprovante. O PDF será gerado sem ela.', 'warning'); } } } else { this.showMessage('Nenhuma imagem selecionada. Gerando PDF sem comprovante.', 'info'); } this._generateCollaboratorPdfContent(collaboratorIndex, imageDataUrl); }; fileInput.click(); } else { this._generateCollaboratorPdfContent(collaboratorIndex, null); } this.currentCollaboratorIndexForPdf = null; },
            async _generateCollaboratorPdfContent(collaboratorIndex, imageDataUrl) { const { jsPDF } = window.jspdf; const doc = new jsPDF(); const collab = this.collaborators[collaboratorIndex]; if (!collab) { console.error("Colaboradora não encontrada para geração de PDF."); this.showMessage('Erro: Colaboradora não encontrada para gerar PDF.', 'error'); return; } const dateText = document.getElementById('dateDisplay').textContent; const collabName = collab.name || 'Colaboradora sem nome'; const collabTitleY = 20; doc.setFontSize(20); doc.text(this.salonName, 105, collabTitleY, null, null, "center"); let y = collabTitleY + 15; doc.setFontSize(14); doc.text(`Fechamento semanal (${collabName})`, 105, y, null, null, "center"); y += 15; doc.setFontSize(12); doc.text(dateText, 105, y, null, null, "center"); y += 15; doc.setFontSize(14); doc.text("Serviços Prestados:", 15, y); y += 10; if (collab.clients.length === 0) { doc.setFontSize(10); doc.text("Nenhum cliente registrado para esta colaboradora.", 20, y); y += 10; } else { collab.clients.forEach(client => { if (y > 270) { doc.addPage(); y = 15; } doc.setFontSize(10); doc.text(`${client.name || 'Nome do Cliente'}: R$ ${client.value.toFixed(2).replace('.', ',')} (${this.formatPaymentMethodForPdf(client.paymentMethod)})`, 25, y); y += 5; }); } const grossTotalServices = collab.clients.reduce((sum, client) => sum + client.value, 0); const salonShareValue = grossTotalServices * collab.discountPercentage; const collabNetTotal = grossTotalServices - salonShareValue; if (y > 270) { doc.addPage(); y = 15; } doc.setFontSize(10); doc.text(`Total Bruto Serviços: R$ ${grossTotalServices.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right"); y += 5; doc.text(`Líquido P/ Comissão: R$ ${grossTotalServices.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right"); y += 5; doc.text(`Parte do Salão (-${(collab.discountPercentage * 100).toFixed(0)}%): R$ ${salonShareValue.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right"); y += 5; doc.setFontSize(12); doc.text(`Total Líquido Colaboradora: R$ ${collabNetTotal.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right"); y += 15; if (collab.observations && collab.observations.trim() !== '') { y += 15; if (y > 260) { doc.addPage(); y = 15; } doc.setFontSize(12); doc.text("Observações:", 15, y); y += 7; doc.setFontSize(10); const lines = doc.splitTextToSize(collab.observations, 180); lines.forEach(line => { if (y > 270) { doc.addPage(); y = 15; } doc.text(line, 15, y); y += 5; }); } if (imageDataUrl) { y += 15; if (y > 260) { doc.addPage(); y = 15; } doc.setFontSize(14); doc.text("Comprovante de Pagamento:", 15, y); y += 10; try { const img = new Image(); img.src = imageDataUrl; await new Promise(resolve => img.onload = resolve); const imgWidth = img.width; const imgHeight = img.height; const pageWidth = doc.internal.pageSize.getWidth() - 30; const pageHeight = doc.internal.pageSize.getHeight() - y - 15; let finalImgWidth = pageWidth; let finalImgHeight = (imgHeight * pageWidth) / imgWidth; if (finalImgHeight > pageHeight) { finalImgHeight = pageHeight; finalImgWidth = (imgWidth * pageHeight) / imgHeight; } const imgX = 15 + (pageWidth - finalImgWidth) / 2; if (y + finalImgHeight > doc.internal.pageSize.getHeight() - 15) { doc.addPage(); y = 15; } doc.addImage(imageDataUrl, 'JPEG', imgX, y, finalImgWidth, finalImgHeight); y += finalImgHeight + 10; } catch (imgError) { console.error("Erro ao adicionar imagem ao PDF:", imgError); this.showMessage('Erro ao adicionar a imagem do comprovante ao PDF. O PDF será gerado sem ela.', 'warning'); } } doc.save(`fechamento_semanal_${collabName.replace(/\s+/g, '_').toLowerCase()}.pdf`); this.showMessage(`PDF da colaboradora ${collabName} gerado!`, 'success'); },
            generatePDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); const dateText = document.getElementById('dateDisplay').textContent; const mainTitleY = 20; doc.setFontSize(20); doc.text(this.salonName, 105, mainTitleY, null, null, "center"); let y = mainTitleY + 15; doc.setFontSize(14); doc.text("Fechamento semanal (Geral)", 105, y, null, null, "center"); y += 15; doc.setFontSize(14); doc.text(dateText, 105, y, null, null, "center"); y += 15; doc.setFontSize(16); doc.text("Colaboradoras:", 15, y); y += 10; if (this.collaborators.length === 0) { doc.setFontSize(12); doc.text("Nenhuma colaboradora adicionada.", 15, y); y += 10; } else { this.collaborators.forEach(collab => { if (y > 270) { doc.addPage(); y = 15; } doc.setFontSize(14); doc.text(`${collab.name || 'Nome da Colaboradora'}:`, 20, y); y += 7; if (collab.clients.length === 0) { doc.setFontSize(10); doc.text("Nenhum cliente registrado.", 25, y); y += 7; } else { collab.clients.forEach(client => { if (y > 270) { doc.addPage(); y = 15; } doc.setFontSize(10); doc.text(`${client.name || 'Nome do Cliente'}: R$ ${client.value.toFixed(2).replace('.', ',')} (${this.formatPaymentMethodForPdf(client.paymentMethod)})`, 25, y); y += 5; }); } const grossTotalServices = collab.clients.reduce((sum, client) => sum + client.value, 0); const salonShareValue = grossTotalServices * collab.discountPercentage; const collabNetTotal = grossTotalServices - salonShareValue; if (y > 270) { doc.addPage(); y = 15; } doc.setFontSize(10); doc.text(`Total Bruto Serviços: R$ ${grossTotalServices.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right"); y += 5; doc.text(`Líquido P/ Comissão: R$ ${grossTotalServices.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right"); y += 5; doc.text(`Parte do Salão (-${(collab.discountPercentage * 100).toFixed(0)}%): R$ ${salonShareValue.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right"); y += 5; doc.setFontSize(12); doc.text(`Total Líquido Colaboradora: R$ ${collabNetTotal.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right"); y += 15; }); } if (y > 260) { doc.addPage(); y = 15; } doc.setFontSize(16); doc.text("Produtos Vendidos:", 15, y); y += 10; if (this.products.length === 0) { doc.setFontSize(12); doc.text("Nenhum produto vendido.", 15, y); y += 10; } else { this.products.forEach(product => { if (y > 270) { doc.addPage(); y = 15; } doc.setFontSize(10); doc.text(`${product.clientName || 'Cliente sem nome'}: R$ ${product.value.toFixed(2).replace('.', ',')} (${this.formatPaymentMethodForPdf(product.paymentMethod)})`, 20, y); y += 5; }); } const overallProductsTotal = this.products.reduce((sum, product) => sum + product.value, 0); const overallProductsCardDiscount = this.products.reduce((sum, product) => sum + this.calculateCardDiscount(product.value, product.paymentMethod), 0); if (y > 270) { doc.addPage(); y = 15; } doc.setFontSize(12); doc.text(`Total Bruto Produtos: R$ ${overallProductsTotal.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right"); y += 5; doc.text(`Desconto Cartão Produtos: R$ ${overallProductsCardDiscount.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right"); y += 15; if (y > 260) { doc.addPage(); y = 15; } doc.setFontSize(16); doc.text("Detalhes da Contribuição:", 15, y); y += 10; let totalGrossServicesForPDF = this.collaborators.reduce((sum, collab) => sum + collab.clients.reduce((s, c) => s + c.value, 0), 0); if (this.collaborators.length > 0) { if (y > 270) { doc.addPage(); y = 15; } doc.setFontSize(12); doc.text("Serviços por Colaboradora (Bruto):", 20, y); y += 7; this.collaborators.forEach(collab => { const collabGrossTotal = collab.clients.reduce((sum, client) => sum + client.value, 0); if (totalGrossServicesForPDF > 0) { const percentageOfServices = (collabGrossTotal / totalGrossServicesForPDF) * 100; if (y > 270) { doc.addPage(); y = 15; } doc.setFontSize(10); doc.text(`${collab.name || 'Colaboradora sem nome'}: R$ ${collabGrossTotal.toFixed(2).replace('.', ',')} (${percentageOfServices.toFixed(1)}% dos serviços)`, 25, y); y += 5; } else { if (y > 270) { doc.addPage(); y = 15; } doc.setFontSize(10); doc.text(`${collab.name || 'Colaboradora sem nome'}: R$ ${collabGrossTotal.toFixed(2).replace('.', ',')}`, 25, y); y += 5; } }); } else { if (y > 270) { doc.addPage(); y = 15; } doc.setFontSize(10); doc.text("Nenhum serviço registrado.", 20, y); y += 5; } if (y > 270) { doc.addPage(); y = 15; } doc.setFontSize(12); doc.text("Venda de Produtos:", 20, y); y += 7; doc.setFontSize(10); doc.text(`Total de Produtos: R$ ${overallProductsTotal.toFixed(2).replace('.', ',')}`, 25, y); y += 10; if (y > 260) { doc.addPage(); y = 15; } doc.setFontSize(16); doc.text("Resumo Geral:", 15, y); y += 10; let overallGrossRevenue = 0; let totalCardDiscount = 0; let totalSalonShareFromServices = 0; let totalCollaboratorNetPayments = 0; let overallProductsTotalForPdf = 0; this.collaborators.forEach(collab => { let grossServices = 0; collab.clients.forEach(client => { grossServices += client.value; totalCardDiscount += this.calculateCardDiscount(client.value, client.paymentMethod); }); overallGrossRevenue += grossServices; const salonShareValue = grossServices * collab.discountPercentage; totalSalonShareFromServices += salonShareValue; const collabNetTotal = grossServices - salonShareValue; totalCollaboratorNetPayments += collabNetTotal; }); this.products.forEach(product => { overallGrossRevenue += product.value; totalCardDiscount += this.calculateCardDiscount(product.value, product.paymentMethod); overallProductsTotalForPdf += product.value; }); const salonNetProfit = overallGrossRevenue - totalCardDiscount - totalCollaboratorNetPayments; if (y > 270) { doc.addPage(); y = 15; } doc.setFontSize(14); doc.text(`Total Bruto Geral: R$ ${overallGrossRevenue.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right"); y += 7; doc.text(`Total Desconto Cartão: R$ ${totalCardDiscount.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right"); y += 7; doc.setFontSize(16); doc.text(`Lucro Líquido do Salão: R$ ${salonNetProfit.toFixed(2).replace('.', ',')}`, 150, y, null, null, "right"); doc.save("fechamento_semanal_salao.pdf"); showMessage('PDF do fechamento geral gerado!', 'success'); },
            showClearConfirm() { document.getElementById('confirm-message').textContent = 'Tem certeza que deseja limpar TODOS os dados (locais e da nuvem)?'; document.getElementById('custom-confirm-modal').style.display = 'flex'; this.confirmAction = 'clearAllData'; },
            handleConfirm(confirmed) { document.getElementById('custom-confirm-modal').style.display = 'none'; if (confirmed) { if (this.confirmAction === 'clearAllData') { this.clearAllDataFromFirestoreAndLocal(); } else if (this.confirmAction === 'deleteSavedReport') { this.deleteSavedReport(this.reportToDeleteId); } } else { this.showMessage('Operação cancelada.', 'info'); } this.confirmAction = null; this.reportToDeleteId = null; },
            saveLocalData() { const dataToSave = { salonName: this.salonName, collaborators: this.collaborators, products: this.products, date: { day: document.getElementById('day').value, month: document.getElementById('month').value, year: document.getElementById('year').value } }; localStorage.setItem('salonWeeklyClosingData', JSON.stringify(dataToSave)); },
            loadLocalData() { const savedData = localStorage.getItem('salonWeeklyClosingData'); if (savedData) { try { const parsedData = JSON.parse(savedData); this.collaborators = parsedData.collaborators || []; this.products = parsedData.products || []; this.salonName = parsedData.salonName || 'Espaço Fran Kokott'; document.getElementById('day').value = parsedData.date?.day || ''; document.getElementById('month').value = parsedData.date?.month || ''; document.getElementById('year').value = parsedData.date?.year || ''; this.collaborators.forEach(collab => { if (collab.discountPercentage === undefined) { collab.discountPercentage = 0.30; } if (collab.observations === undefined) { collab.observations = ''; } collab.clients.forEach(client => { if (client.paymentMethod === undefined || client.paymentMethod === 'credito') { client.paymentMethod = 'credito_1x'; } }); }); this.products.forEach(product => { if (product.paymentMethod === undefined || product.paymentMethod === 'credito') { product.paymentMethod = 'credito_1x'; } }); this.renderAllUI(); this.showMessage('Dados carregados do salvamento automático.', 'info'); } catch (e) { console.error("Erro ao carregar dados do localStorage:", e); localStorage.removeItem('salonWeeklyClosingData'); this.showMessage('Erro ao carregar dados salvos localmente. Dados corrompidos foram removidos.', 'error'); } } },
            exportDataToFile() { const dataToSave = { salonName: this.salonName, collaborators: this.collaborators, products: this.products, date: { day: document.getElementById('day').value, month: document.getElementById('month').value, year: document.getElementById('year').value } }; const jsonString = JSON.stringify(dataToSave, null, 2); const blob = new Blob([jsonString], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `fechamento_salao_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); this.showMessage('Dados exportados com sucesso!', 'success'); },
            importDataFromFile() { const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = '.json'; fileInput.onchange = (event) => { const file = event.target.files[0]; if (!file) { this.showMessage('Nenhum arquivo selecionado.', 'info'); return; } const reader = new FileReader(); reader.onload = (e) => { try { const importedData = JSON.parse(e.target.result); if (importedData.collaborators && Array.isArray(importedData.collaborators) && importedData.products && Array.isArray(importedData.products) && importedData.date && typeof importedData.date === 'object') { this.collaborators = importedData.collaborators; this.products = importedData.products; this.salonName = importedData.salonName || 'Espaço Fran Kokott'; this.collaborators.forEach(collab => { if (collab.discountPercentage === undefined) { collab.discountPercentage = 0.30; } if (collab.observations === undefined) { collab.observations = ''; } collab.clients.forEach(client => { if (client.paymentMethod === undefined || client.paymentMethod === 'credito') { client.paymentMethod = 'credito_1x'; } }); }); this.products.forEach(product => { if (product.paymentMethod === undefined || product.paymentMethod === 'credito') { product.paymentMethod = 'credito_1x'; } }); document.getElementById('day').value = importedData.date.day || ''; document.getElementById('month').value = importedData.date.month || ''; document.getElementById('year').value = importedData.date.year || ''; this.renderAllUI(); this.saveLocalData(); this.showMessage('Dados importados com sucesso!', 'success'); } else { this.showMessage('Formato de arquivo JSON inválido.', 'error'); } } catch (parseError) { this.showMessage('Erro ao ler o arquivo: Não é um JSON válido.', 'error'); } }; reader.readAsText(file); }; fileInput.click(); },
            async saveWeeklyClosingToFirestore() {
                if (!window.currentUser) { this.showMessage('Por favor, faça login para salvar na nuvem.', 'error'); return; }
                const collectionRef = collection(db, `artifacts/${window.appId}/public/data/salonWeeklySaves`);
                const day = document.getElementById('day').value;
                const month = document.getElementById('month').value;
                const year = document.getElementById('year').value;
                if (!day || !month || !year) { this.showMessage('Por favor, preencha o dia, mês e ano para salvar o fechamento.', 'error'); return; }
                this.showMessage('Salvando dados na nuvem...', 'info');
                this.toggleLoadingSpinner('save', true);
                const dataToSave = { salonName: this.salonName, collaborators: this.collaborators, products: this.products, date: { day, month, year }, notes: "", lastSaved: new Date().toISOString(), savedBy: window.currentUser.email };
                try {
                    await addDoc(collectionRef, dataToSave);
                    this.showMessage('Dados salvos na nuvem com sucesso!', 'success');
                } catch (e) {
                    console.error("Erro ao salvar no Firestore: ", e);
                    this.showMessage('Erro ao salvar dados na nuvem: ' + e.message, 'error');
                } finally {
                    this.toggleLoadingSpinner('save', false);
                }
            },
            async openSavedReportsModal() {
                 if (!window.currentUser) { this.showMessage('Por favor, faça login para carregar dados da nuvem.', 'error'); return; }
                 const collectionRef = collection(db, `artifacts/${window.appId}/public/data/salonWeeklySaves`);
                 // ... Lógica original de openSavedReportsModal, mas usando o collectionRef compartilhado
            },
            async loadSelectedReport() {
                 // ... Lógica original de loadSelectedReport
            },
            async deleteSavedReportConfirmation(reportId) {
                // ... Lógica original de deleteSavedReportConfirmation
            },
            async deleteSavedReport(reportId) {
                if (!window.currentUser) { this.showMessage('Por favor, faça login para excluir relatórios.', 'error'); return; }
                const docRef = doc(db, `artifacts/${window.appId}/public/data/salonWeeklySaves`, reportId);
                // ... Lógica original de deleteSavedReport, mas com o caminho compartilhado
            },
            async loadDataFromFichasSystem() {
                 if (!window.currentUser) { this.showMessage('Por favor, faça login para importar dados das fichas.', 'error'); return; }
                 const fichasAppId = 'fichas-clientes-shared'; // ID do outro app
                 const docRef = doc(db, `artifacts/${fichasAppId}/public/data/weeklyReportsAggregated/currentWeek`);
                 // ... Lógica original de loadDataFromFichasSystem, mas com o caminho compartilhado
            },
            async clearAllDataFromFirestoreAndLocal() {
                // ... Lógica original de clearAllDataFromFirestoreAndLocal
            },
            toggleLoadingSpinner(type, show) {
                 const spinner = document.getElementById(`${type}-spinner`);
                const icon = document.getElementById(`${type}-icon`);
                if (spinner && icon) {
                    spinner.classList.toggle('hidden', !show);
                    icon.classList.toggle('hidden', show);
                }
            }
        };

        function initializeAppLogic() {
            window.salonApp.init();
        }
        
        window.updateDateDisplay = () => window.salonApp.updateDateDisplay();
        window.addCollaborator = () => window.salonApp.addCollaborator();
        // ... (todos os outros aliases originais)
    </script>
</body>
</html>

