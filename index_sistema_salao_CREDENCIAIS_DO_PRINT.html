<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fechamento Semanal do Salão</title>
</head>
<body>
  <!-- SHIM para garantir signOut/logout -->
  <script>
    (function(){
      window.signOut = window.logout = async function () {
        try {
          if (typeof window.__hardLogout === 'function') return await window.__hardLogout();
          if (window.salonApp && typeof window.salonApp.signOutUser === 'function') return await window.salonApp.signOutUser();
          alert('Finalizando sessão...');
        } catch (e) {
          console.error(e);
          alert('Erro ao sair: ' + (e && e.message ? e.message : e));
        }
      };
    })();
  </script>

  <!-- Configuração Firebase (EXATAMENTE como você enviou) -->
  <script>
    window.firebaseConfig = {
      apiKey: "AIzaSyD7FwQZspQNYZmNlQv8oNglccBXHmduW5w",
      authDomain: "sistema-do-salao.firebaseapp.com",
      projectId: "sistema-do-salao",
      storageBucket: "sistema-do-salao.firebasestorage.app",
      messagingSenderId: "395887083088",
      appId: "1:395887083088:web:3a41fd836cc59a976ddb55",
      measurementId: "G-1D996M5FKZ"
    };
  </script>

  <script type="module">
    // ===== Firebase SDKs (CDN) =====
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      onAuthStateChanged,
      signOut as fbSignOut,
      setPersistence,
      browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      collectionGroup,
      query, where, orderBy, getDocs,
      Timestamp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

    // ===== Inicialização =====
    const firebaseConfig = window.firebaseConfig;
    const app   = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const analytics = getAnalytics(app); // opcional, mas usamos sua config com measurementId
    const auth  = getAuth(app);
    const db    = getFirestore(app);
    const appId = firebaseConfig.appId;

    // E-mails autorizados
    const AUTHORIZED_EMAILS = [
      "djmkbrasil@gmail.com",
      "frankokott@gmail.com",
      "djmkapple@gmail.com",
      "gabrielastephane11@gmail.com",
      "cibemarchi@gmail.com"
    ].map(e => e.toLowerCase());

    // Persistência em sessão (facilita trocar de conta)
    try { await setPersistence(auth, browserSessionPersistence); } catch (e) { console.warn("setPersistence:", e); }

    // ===== Login universal (popup -> fallback redirect) =====
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    async function robustLogin() {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.warn("Popup falhou, tentando redirect:", e?.code, e?.message);
        try { await signInWithRedirect(auth, provider); }
        catch (er) {
          console.error("Redirect falhou:", er?.code, er?.message);
          alert("Não foi possível iniciar o login do Google.\nVerifique pop-ups e domínios autorizados em Authentication.");
        }
      }
    }
    window.loginGoogle  = robustLogin;
    window.signInGoogle = robustLogin;
    window.login        = robustLogin;

    // ===== Logout forte =====
    window.__hardLogout = async () => {
      try { await fbSignOut(auth); } catch (e) { console.error(e); }
      try {
        const clearMatching = (s) => {
          try { const keys = []; for (let i=0;i<s.length;i++) keys.push(s.key(i));
            keys.forEach(k => { if (k && (k.includes("firebase") || k.includes("g_state"))) { try { s.removeItem(k); } catch {} } });
          } catch {}
        };
        clearMatching(window.localStorage);
        clearMatching(window.sessionStorage);
        if (window.indexedDB) {
          try { indexedDB.deleteDatabase("firebaseLocalStorageDb"); } catch {}
          try { indexedDB.deleteDatabase("firebase-installations-database"); } catch {}
          try { indexedDB.deleteDatabase("firebase-heartbeat-database"); } catch {}
        }
      } catch {}
      try { alert("Sessão encerrada."); } catch {}
      window.location.replace(window.location.pathname + window.location.search);
    };

    // ===== Helpers de datas (semana corrente, seg→dom) =====
    function startOfWeekUTC(d) {
      const x = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
      const day = x.getUTCDay() || 7; // 1..7 (dom = 7)
      if (day > 1) x.setUTCDate(x.getUTCDate() - (day - 1));
      x.setUTCHours(0,0,0,0);
      return x;
    }
    function endOfWeekUTC(d) {
      const s = startOfWeekUTC(d);
      const e = new Date(s); e.setUTCDate(e.getUTCDate() + 7);
      return e; // exclusivo
    }

    // ===== Busca todas as FICHAS da semana (collectionGroup) =====
    async function fetchWeeklyFichas(dateRef = new Date()) {
      const start = startOfWeekUTC(new Date(dateRef));
      const end   = endOfWeekUTC(new Date(dateRef));

      const fichasCg = collectionGroup(db, "fichas");

      // 1ª tentativa: com appId (se os docs tiverem este campo)
      let q = query(
        fichasCg,
        where("createdAt", ">=", Timestamp.fromDate(start)),
        where("createdAt", "<",  Timestamp.fromDate(end)),
        orderBy("createdAt", "asc"),
        where("appId", "==", appId)
      );

      let snap = await getDocs(q);
      if (snap.empty) {
        // Fallback: sem filtro de appId (funciona com fichas antigas)
        q = query(
          fichasCg,
          where("createdAt", ">=", Timestamp.fromDate(start)),
          where("createdAt", "<",  Timestamp.fromDate(end)),
          orderBy("createdAt", "asc")
        );
        snap = await getDocs(q);
      }

      const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      return { start, end, rows };
    }
    window.fetchWeeklyFichas = fetchWeeklyFichas; // expõe pra sua UI

    // ===== onAuthStateChanged =====
    onAuthStateChanged(auth, async (user) => {
      if (!user) return; // aguardando login

      const email = (user.email || "").toLowerCase();
      if (!AUTHORIZED_EMAILS.includes(email)) {
        await window.__hardLogout();
        alert("Este e-mail não tem permissão de acesso.");
        return;
      }

      // Ativa botões da sua UI, se existir método
      if (window.salonApp && typeof window.salonApp.enableButtons === "function") {
        try { window.salonApp.enableButtons(); } catch {}
      }

      // Carrega fichas da semana
      try {
        const { start, end, rows } = await fetchWeeklyFichas(new Date());

        // Hook: se seu app tiver um handler, usamos ele
        if (window.fechamentoApp && typeof window.fechamentoApp.onFichasLoaded === "function") {
          window.fechamentoApp.onFichasLoaded({ start, end, rows, user });
        } else {
          // Fallback: log no console
          console.log("[Fechamento] Semana:", start.toISOString(), "→", end.toISOString());
          console.log("[Fechamento] Fichas (total):", rows.length, rows);
        }
      } catch (e) {
        console.error("Erro ao buscar fichas:", e);
        alert("Erro ao carregar fichas da semana.");
      }
    });

    // Completa login via redirect (Safari / popup bloqueado)
    try {
      const rr = await getRedirectResult(auth);
      if (rr?.user) console.log("Login via redirect OK:", rr.user.email);
    } catch (e) {
      console.warn("getRedirectResult erro:", e?.code, e?.message);
    }

    // Banner de diagnóstico
    console.log("%c[INDEX vFinal] carregado — projeto: %s — appId: %s",
      "background:#222;color:#0f0;padding:4px;border-radius:4px",
      firebaseConfig.projectId, firebaseConfig.appId);
  </script>
  <div id="auth-buttons" style="display:none"></div>
</body>
</html>
