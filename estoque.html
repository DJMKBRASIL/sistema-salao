<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Fichas de Cliente</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais Firebase (serão preenchidas pelo ambiente Canvas ou padrão)
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyD7FwQZspQNYZmNlQv8oNglccBXHmduW5w",
            authDomain: "sistema-do-salao.firebaseapp.com",
            projectId: "sistema-do-salao",
            storageBucket: "sistema-do-salao.firebasestorage.app",
            messagingSenderId: "395887083088",
            appId: "1:395887083088:web:3a41fd836cc59a976ddb55",
            measurementId: "G-1D996M5FKZ"
        };
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Variáveis do Firebase agora como propriedades de window para acessibilidade global
        window.app = null;
        window.db = null;
        window.auth = null;
        window.userId = 'loading...'; // Será atualizado após a autenticação
        window.fichasCollectionRef = null; // Referência à coleção de fichas no Firestore
        window.fichasSavedSnapshots = []; // Array para armazenar snapshots de fichas salvas
        window.selectedFichaSnapshotId = null; // ID do snapshot selecionado no modal

        // Função de inicialização do Firebase e autenticação
        async function initializeFirebase() {
            try {
                window.app = initializeApp(window.firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);
                
                // Define a persistência da autenticação para armazenamento local
                await setPersistence(window.auth, browserLocalPersistence);
                console.log("Firebase initialized and persistence set to LOCAL."); // Debug log

                // Monitorar o estado de autenticação
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        // Usuário autenticado (pode ser anónimo ou Google)
                        window.userId = user.uid;
                        const authMethod = user.isAnonymous ? 'Anónimo' : 'Google';
                        const displayInfo = user.displayName ? `${user.displayName} (${authMethod})` : `${window.userId} (${authMethod})`;
                        document.getElementById('user-id-display').textContent = `Usuário: ${displayInfo}`;
                        document.getElementById('auth-buttons').innerHTML = `
                            <button onclick="signOutUser()" class="btn btn-danger">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                </svg>
                                Sair
                            </button>
                        `;
                        // Definir fichasCollectionRef aqui, após db e userId estarem disponíveis
                        window.fichasCollectionRef = collection(window.db, `artifacts/${window.appId}/users/${window.userId}/fichas`);
                        console.log("Usuário autenticado:", window.userId, "Método:", authMethod); // Debug log
                        if (window.db) {
                            initializeAppLogic(); // Carregar dados iniciais após autenticação
                        } else {
                            console.error("Firebase DB not available after authentication. (Inside onAuthStateChanged)"); // Debug log
                            showMessage('Erro: Banco de dados não disponível após autenticação. Recarregue a página.', 'error');
                        }
                    } else {
                        // Usuário não autenticado
                        window.userId = 'Não autenticado';
                        document.getElementById('user-id-display').textContent = `Usuário: ${window.userId}`;
                        document.getElementById('auth-buttons').innerHTML = `
                            <button onclick="signInWithGoogle()" class="btn btn-primary">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                Entrar com Google
                            </button>
                        `;
                        // Desabilitar botões que dependem de autenticação completa
                        document.getElementById('addFichaBtn').disabled = true;
                        document.getElementById('clearAllFichasBtn').disabled = true;
                        document.getElementById('exportWeeklyDataBtn').disabled = true;
                        document.getElementById('exportFichasToFileBtn').disabled = true;
                        document.getElementById('importFichasFromFileBtn').disabled = true;
                        document.getElementById('saveFichasToCloudBtn').disabled = true;
                        document.getElementById('loadFichasFromCloudBtn').disabled = true;
                    }
                });

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                showMessage('Erro ao inicializar o Firebase. Verifique a configuração.', 'error');
            }
        }

        // Função para autenticar com Google
        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(window.auth, provider);
                showMessage('Autenticado com Google!', 'success');
            } catch (error) {
                console.error("Erro ao autenticar com Google:", error);
                showMessage('Erro ao autenticar com Google: ' + error.message, 'error');
            }
        }

        // Função para sair
        async function signOutUser() {
            try {
                await signOut(window.auth);
                showMessage('Sessão encerrada.', 'info');
                // Limpar dados locais ao sair
                fichas = [];
                renderFichasTable();
                clearInputFields();
            } catch (error) {
                console.error("Erro ao sair:", error);
                showMessage('Erro ao sair: ' + error.message, 'error');
            }
        }

        // Chamar a inicialização do Firebase quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', initializeFirebase);

        // Expondo as funções do Firestore SDK diretamente, se necessário
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.addDoc = addDoc; // Adicionado para adicionar novos documentos
        // Expondo funções de autenticação para o HTML
        window.signInWithGoogle = signInWithGoogle;
        window.signOutUser = signOutUser;
    </script>

    <style>
        :root {
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --border-radius: 0.75rem;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            line-height: 1.6;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .content {
            padding: 2rem;
        }

        .section {
            background: var(--gray-50);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--gray-200);
            transition: var(--transition);
        }

        .section:hover {
            box-shadow: var(--shadow-md);
        }

        .section-header {
            display: flex;
            justify-content: space-between; /* Changed from 'between' to 'space-between' */
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-800);
            margin: 0;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            min-height: 44px; /* Touch-friendly minimum */
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #7c3aed;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #059669;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background-color: #d97706;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-gray {
            background-color: var(--gray-300);
            color: var(--gray-800);
        }

        .btn-gray:hover:not(:disabled) {
            background-color: var(--gray-400);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-full {
            width: 100%;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: var(--transition);
            background-color: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-input::-webkit-outer-spin-button,
        .form-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .form-input[type=number] {
            -moz-appearance: textfield;
        }

        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: var(--transition);
            background-color: white;
            resize: vertical;
            min-height: 80px;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .grid {
            display: grid;
            gap: 1rem;
        }

        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .flex-wrap {
            flex-wrap: wrap;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-3 {
            gap: 0.75rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .p-4 {
            padding: 1rem;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-lg {
            font-size: 1.125rem;
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .font-medium {
            font-weight: 500;
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-bold {
            font-weight: 700;
        }

        .text-gray-500 {
            color: var(--gray-500);
        }

        .text-gray-600 {
            color: var(--gray-600);
        }

        .text-gray-700 {
            color: var(--gray-700);
        }

        .text-gray-800 {
            color: var(--gray-800);
        }

        .client-row {
            background: var(--gray-50);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--gray-200);
        }

        .product-row {
            background: var(--gray-50);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--gray-200);
        }

        .message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 500;
            animation: slideInDown 0.3s ease-out;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .message-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .message-info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            padding: 1rem;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow-xl);
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .saved-reports-list { /* Reusing style for saved ficha snapshots */
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .report-item { /* Reusing style for saved ficha snapshots */
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .report-item:last-child {
            border-bottom: none;
        }

        .report-item:hover {
            background-color: var(--gray-50);
        }

        .report-item.selected {
            background-color: #e0e7ff;
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }

            .header {
                padding: 1.5rem 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .content {
                padding: 1rem;
            }

            .section {
                padding: 1rem;
            }

            .grid-cols-3 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }

            .grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }

            .flex {
                flex-direction: column;
            }

            .flex > * {
                width: 100%;
            }

            .btn {
                padding: 1rem;
                font-size: 1rem;
            }

            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }

            .modal-buttons {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.75rem;
            }

            .section-title {
                font-size: 1.25rem;
            }

            .client-row,
            .product-row {
                padding: 0.5rem;
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .main-container {
                box-shadow: none;
                border-radius: 0;
            }

            .header {
                background: white !important;
                color: black !important;
            }

            .btn,
            .modal {
                display: none !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .section {
                border: 2px solid var(--gray-400);
            }

            .btn {
                border: 2px solid currentColor;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <header class="header">
            <h1>Espaço Fran Kokott</h1>
            <p style="font-size: 1.2rem; margin-top: 0.5rem; opacity: 0.9;">Registro de Fichas de Cliente</p>
        </header>

        <!-- Main Content -->
        <main class="content">
            <!-- User Authentication Section -->
            <div class="section">
                <div class="flex items-center justify-between mb-4">
                    <p id="user-id-display" class="text-sm text-gray-500">Usuário: Carregando...</p>
                    <div id="auth-buttons" class="flex gap-2">
                        <!-- Authentication buttons will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Message Area -->
            <div id="app-message" class="message" style="display: none;"></div>

            <!-- Ficha Input Section -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Nova Ficha de Atendimento</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="clientName" class="form-label">Nome da Cliente</label>
                        <input type="text" id="clientName" placeholder="Nome Completo da Cliente" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="professionalName" class="form-label">Nome da Profissional</label>
                        <input type="text" id="professionalName" placeholder="Nome da Profissional" class="form-input">
                    </div>
                </div>

                <div class="mt-4">
                    <h3 class="text-md font-medium text-gray-700 mb-2">Serviços</h3>
                    <div id="services-container">
                        <!-- Service rows will be added dynamically here -->
                    </div>
                    <button onclick="addServiceRow()" class="btn btn-primary btn-full mt-4">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Adicionar Serviço
                    </button>
                </div>

                <div class="mt-4">
                    <h3 class="text-md font-medium text-gray-700 mb-2">Produtos Vendidos (Opcional)</h3>
                    <div id="products-sold-container">
                        <!-- Products sold rows will be added dynamically here -->
                    </div>
                    <button onclick="addProductSoldRow()" class="btn btn-success btn-full mt-4">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Adicionar Produto
                    </button>
                </div>

                <div class="mt-6 flex justify-end">
                    <button id="addFichaBtn" onclick="addFicha()" class="btn btn-primary text-lg font-bold" disabled>
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Registrar Ficha
                    </button>
                </div>
            </div>

            <!-- Recorded Fichas Section -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Fichas Registradas</h2>
                </div>
                <div id="fichas-list" class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Cliente</th>
                                <th class="py-3 px-6 text-left">Profissional</th>
                                <th class="py-3 px-6 text-left">Serviços</th>
                                <th class="py-3 px-6 text-left">Produtos</th>
                                <th class="py-3 px-6 text-center">Total Ficha</th>
                                <th class="py-3 px-6 text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light" id="fichas-table-body">
                            <!-- Fichas will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row gap-3">
                    <button id="clearAllFichasBtn" onclick="showClearAllFichasConfirm()" class="btn btn-danger btn-full" disabled>
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Limpar Todas as Fichas
                    </button>
                    <button id="exportWeeklyDataBtn" onclick="generateAndExportWeeklyData()" class="btn btn-secondary btn-full" disabled>
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                        </svg>
                        Exportar Dados para Fechamento Semanal
                    </button>
                    <button id="exportFichasToFileBtn" onclick="exportFichasToFile()" class="btn btn-secondary btn-full" disabled>
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Exportar Fichas para Arquivo
                    </button>
                    <button id="importFichasFromFileBtn" onclick="importFichasFromFile()" class="btn btn-secondary btn-full" disabled>
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                        Importar Fichas de Arquivo
                    </button>
                    <button id="saveFichasToCloudBtn" onclick="saveFichasSnapshotToFirestore()" class="btn btn-success btn-full" disabled>
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Salvar Fichas na Nuvem
                    </button>
                    <button id="loadFichasFromCloudBtn" onclick="openSavedFichasModal()" class="btn btn-warning btn-full" disabled>
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                        Carregar Fichas da Nuvem
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Confirmação para Limpar Tudo -->
    <div id="custom-confirm-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Confirmar Ação</h3>
            <p class="text-gray-600 mb-4">Tem certeza que deseja limpar todas as fichas?</p>
            <p class="text-sm text-gray-500 mb-6">Esta ação não pode ser desfeita.</p>
            <div class="modal-buttons">
                <button class="btn btn-gray" onclick="handleClearAllFichasConfirm(false)">Cancelar</button>
                <button class="btn btn-danger" onclick="handleClearAllFichasConfirm(true)">Limpar Tudo</button>
            </div>
        </div>
    </div>

    <!-- Novo Modal para Snapshots de Fichas Salvas -->
    <div id="saved-fichas-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Escolha um Snapshot de Fichas Salvas</h3>
            <div id="saved-fichas-list" class="saved-reports-list">
                <!-- Lista de snapshots de fichas salvas será carregada aqui -->
            </div>
            <div class="modal-buttons">
                <button class="btn btn-gray" onclick="closeSavedFichasModal()">Fechar</button>
                <button class="btn btn-primary" onclick="loadSelectedFichaSnapshot()">Carregar Selecionado</button>
            </div>
        </div>
    </div>

    <script>
        let fichas = []; // Array local para armazenar os objetos de ficha (para renderização e agregação)

        // --- Helper Functions for Messages and Modals ---
        function showMessage(message, type = 'success') {
            const msgDiv = document.getElementById('app-message');
            msgDiv.textContent = message;
            msgDiv.className = `message message-${type}`; // Use new message classes
            msgDiv.style.display = 'block';
            
            setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 5000);
        }

        function showClearAllFichasConfirm() {
            document.getElementById('custom-confirm-modal').style.display = 'flex';
        }

        function handleClearAllFichasConfirm(confirmed) {
            document.getElementById('custom-confirm-modal').style.display = 'none';
            if (confirmed) {
                clearAllFichas();
            } else {
                showMessage('Operação de limpeza cancelada.', 'info');
            }
        }
        // --- End Helper Functions ---

        // --- Firestore Functions ---
        async function saveFichaToFirestore(fichaData) {
            if (!window.db || !window.userId || !window.fichasCollectionRef) {
                showMessage('Firebase não inicializado ou usuário não autenticado. Não foi possível salvar a ficha.', 'error');
                return;
            }
            try {
                const docRef = await window.addDoc(window.fichasCollectionRef, fichaData);
                console.log("Ficha salva com ID:", docRef.id);
                showMessage('Ficha registrada e salva na nuvem!', 'success');
                return docRef.id;
            } catch (e) {
                console.error("Erro ao adicionar ficha ao Firestore: ", e);
                showMessage('Erro ao salvar ficha na nuvem: ' + e.message, 'error');
                return null;
            }
        }

        async function loadFichasFromFirestore() {
            if (!window.db || !window.userId || !window.fichasCollectionRef) {
                console.log('Firebase não inicializado ou usuário não autenticado. Não foi possível carregar as fichas.');
                return;
            }
            showMessage('Carregando fichas do Firestore...', 'info');
            try {
                fichas = []; 
                const querySnapshot = await window.getDocs(window.fichasCollectionRef);
                querySnapshot.forEach((doc) => {
                    fichas.push({ id: doc.id, ...doc.data() });
                });
                renderFichasTable();
                showMessage('Fichas carregadas do Firestore com sucesso!', 'success');
                console.log("Fichas carregadas:", fichas);
            } catch (e) {
                console.error("Erro ao carregar fichas do Firestore: ", e);
                showMessage('Erro ao carregar fichas da nuvem: ' + e.message, 'error');
            }
        }

        async function removeFichaFromFirestore(fichaId) {
            if (!window.db || !window.userId) {
                showMessage('Firebase não inicializado ou usuário não autenticado. Não foi possível remover a ficha.', 'error');
                return false;
            }
            try {
                await window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/users/${window.userId}/fichas`, fichaId));
                showMessage('Ficha removida da nuvem.', 'info');
                return true;
            } catch (e) {
                console.error("Erro ao remover ficha do Firestore: ", e);
                showMessage('Erro ao remover ficha da nuvem: ' + e.message, 'error');
                return false;
            }
        }

        async function saveWeeklyReportDataToFirestore(data) {
            if (!window.db || !window.userId) {
                showMessage('Firebase não inicializado ou usuário não autenticado. Não foi possível exportar dados.', 'error');
                return;
            }
            try {
                // Salva os dados agregados em um documento específico para o fechamento semanal
                // O caminho foi ajustado para corresponder ao que o sistema de fechamento semanal espera
                const docRef = window.doc(window.db, `artifacts/${window.appId}/users/${window.userId}/weeklyReportsAggregated/currentWeek`);
                await window.setDoc(docRef, data);
                console.log("Dados agregados para fechamento semanal salvos no Firestore com sucesso!");
                showMessage('Dados agregados para fechamento semanal salvos no Firestore!', 'success');
            } catch (e) {
                console.error("Erro ao salvar dados agregados no Firestore: ", e);
                showMessage('Erro ao salvar dados agregados na nuvem: ' + e.message, 'error');
            }
        }

        async function saveFichasSnapshotToFirestore() {
            if (!window.db || !window.userId || window.userId === 'Não autenticado') {
                showMessage('Por favor, faça login para salvar fichas na nuvem.', 'error');
                return;
            }

            if (fichas.length === 0) {
                showMessage('Não há fichas para salvar.', 'info');
                return;
            }

            showMessage('Salvando snapshot de fichas na nuvem...', 'info');

            const snapshotData = {
                fichas: fichas,
                savedAt: new Date().toISOString()
            };

            try {
                const collectionRef = window.collection(window.db, `artifacts/${window.appId}/users/${window.userId}/savedFichasSnapshots`);
                await window.addDoc(collectionRef, snapshotData);
                showMessage('Snapshot de fichas salvo na nuvem com sucesso!', 'success');
            } catch (e) {
                console.error("Erro ao salvar snapshot de fichas no Firestore: ", e);
                showMessage('Erro ao salvar snapshot de fichas na nuvem: ' + e.message, 'error');
            }
        }

        async function openSavedFichasModal() {
            if (!window.db || !window.userId || window.userId === 'Não autenticado') {
                showMessage('Por favor, faça login para carregar fichas da nuvem.', 'error');
                return;
            }

            showMessage('Buscando snapshots de fichas salvos...', 'info');
            const fichasListDiv = document.getElementById('saved-fichas-list');
            fichasListDiv.innerHTML = '<p class="text-center text-gray-500 p-4">Carregando...</p>';
            window.selectedFichaSnapshotId = null;

            try {
                const collectionRef = window.collection(window.db, `artifacts/${window.appId}/users/${window.userId}/savedFichasSnapshots`);
                const querySnapshot = await window.getDocs(query(collectionRef, orderBy("savedAt", "desc"))); // Order by latest
                
                window.fichasSavedSnapshots = [];
                if (querySnapshot.empty) {
                    fichasListDiv.innerHTML = '<p class="text-center text-gray-500 p-4">Nenhum snapshot de fichas salvo.</p>';
                    showMessage('Nenhum snapshot de fichas salvo para carregar.', 'info');
                    return;
                }

                fichasListDiv.innerHTML = '';
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    window.fichasSavedSnapshots.push({ id: doc.id, ...data });

                    const reportItem = document.createElement('div');
                    reportItem.className = 'report-item';
                    reportItem.setAttribute('data-report-id', doc.id);
                    
                    const savedDate = data.savedAt ? new Date(data.savedAt).toLocaleDateString('pt-BR') : 'Desconhecida';
                    const savedTime = data.savedAt ? new Date(data.savedAt).toLocaleTimeString('pt-BR') : '';

                    reportItem.innerHTML = `
                        <div>
                            <p class="font-medium">Snapshot salvo em: ${savedDate} às ${savedTime}</p>
                            <p class="text-xs text-gray-500">Total de fichas: ${data.fichas ? data.fichas.length : 0}</p>
                        </div>
                        <button class="btn btn-danger text-sm" onclick="event.stopPropagation(); deleteSavedFichaSnapshot('${doc.id}')">Excluir</button>
                    `;
                    
                    reportItem.onclick = (event) => selectFichaSnapshot(event, doc.id);
                    fichasListDiv.appendChild(reportItem);
                });

                document.getElementById('saved-fichas-modal').style.display = 'flex';
                showMessage('Snapshots de fichas carregados!', 'success');

            } catch (error) {
                console.error('Erro ao carregar snapshots de fichas salvos do Firestore:', error);
                showMessage('Erro ao carregar snapshots de fichas salvos: ' + error.message, 'error');
            }
        }

        function closeSavedFichasModal() {
            document.getElementById('saved-fichas-modal').style.display = 'none';
        }

        function selectFichaSnapshot(event, snapshotId) {
            document.querySelectorAll('#saved-fichas-list .report-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            window.selectedFichaSnapshotId = snapshotId;
        }

        async function loadSelectedFichaSnapshot() {
            if (!window.selectedFichaSnapshotId) {
                showMessage('Por favor, selecione um snapshot para carregar.', 'info');
                return;
            }

            showMessage('Carregando snapshot de fichas selecionado...', 'info');
            const snapshotToLoad = window.fichasSavedSnapshots.find(snapshot => snapshot.id === window.selectedFichaSnapshotId);

            if (snapshotToLoad && snapshotToLoad.fichas) {
                fichas = snapshotToLoad.fichas;
                renderFichasTable();
                closeSavedFichasModal();
                showMessage('Snapshot de fichas carregado com sucesso!', 'success');
            } else {
                showMessage('Erro: Snapshot de fichas selecionado não encontrado ou vazio.', 'error');
            }
        }

        async function deleteSavedFichaSnapshot(snapshotId) {
            if (!window.db || !window.userId || window.userId === 'Não autenticado') {
                showMessage('Por favor, faça login para excluir snapshots.', 'error');
                return;
            }

            if (confirm('Tem certeza que deseja excluir este snapshot de fichas salvo?')) {
                try {
                    const docRef = window.doc(window.db, `artifacts/${window.appId}/users/${window.userId}/savedFichasSnapshots`, snapshotId);
                    await window.deleteDoc(docRef);
                    showMessage('Snapshot de fichas excluído com sucesso!', 'success');
                    openSavedFichasModal(); // Recarrega a lista após a exclusão
                } catch (error) {
                    console.error('Erro ao excluir snapshot de fichas salvo:', error);
                    showMessage('Erro ao excluir snapshot: ' + error.message, 'error');
                }
            }
        }
        // --- End Firestore Functions ---

        // --- Dynamic Input Row Management ---
        function addServiceRow(serviceName = '', serviceValue = '', paymentMethod = 'pix') { // Added paymentMethod parameter
            const container = document.getElementById('services-container');
            const newServiceDiv = document.createElement('div');
            newServiceDiv.className = 'flex items-center gap-2 mb-2 client-row'; // Using client-row for styling
            newServiceDiv.innerHTML = `
                <input type="text" placeholder="Nome do Serviço" value="${serviceName}" class="service-name form-input flex-grow min-w-[100px]">
                <input type="number" step="0.01" min="0" placeholder="Valor" value="${serviceValue}" class="service-value form-input w-28 text-right">
                <select class="form-input w-24" onchange="updateServicePaymentMethod(this)">
                    <option value="pix" ${paymentMethod === 'pix' ? 'selected' : ''}>Pix</option>
                    <option value="debito" ${paymentMethod === 'debito' ? 'selected' : ''}>Débito</option>
                    <option value="credito" ${paymentMethod === 'credito' ? 'selected' : ''}>Crédito</option>
                    <option value="dinheiro" ${paymentMethod === 'dinheiro' ? 'selected' : ''}>Dinheiro</option>
                </select>
                <button onclick="removeRow(this)" class="btn btn-danger">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            `;
            container.appendChild(newServiceDiv);
        }

        function addProductSoldRow(productName = '', productValue = '', paymentMethod = 'pix') { // Added paymentMethod parameter
            const container = document.getElementById('products-sold-container');
            const newProductDiv = document.createElement('div');
            newProductDiv.className = 'flex items-center gap-2 mb-2 product-row'; // Using product-row for styling
            newProductDiv.innerHTML = `
                <input type="text" placeholder="Nome do Produto" value="${productName}" class="product-sold-name form-input flex-grow min-w-[100px]">
                <input type="number" step="0.01" min="0" placeholder="Valor" value="${productValue}" class="product-sold-value form-input w-28 text-right">
                <select class="form-input w-24" onchange="updateProductSoldPaymentMethod(this)">
                    <option value="pix" ${paymentMethod === 'pix' ? 'selected' : ''}>Pix</option>
                    <option value="debito" ${paymentMethod === 'debito' ? 'selected' : ''}>Débito</option>
                    <option value="credito" ${paymentMethod === 'credito' ? 'selected' : ''}>Crédito</option>
                    <option value="dinheiro" ${paymentMethod === 'dinheiro' ? 'selected' : ''}>Dinheiro</option>
                </select>
                <button onclick="removeRow(this)" class="btn btn-danger">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;
            container.appendChild(newProductDiv);
        }

        // Functions to update payment method for services and products (not directly used for ficha data structure, but good practice)
        function updateServicePaymentMethod(selectElement) {
            // This function would be more complex if we were directly editing existing ficha data in the UI
            // For now, it just ensures the select element works.
            console.log("Service payment method changed to:", selectElement.value);
        }

        function updateProductSoldPaymentMethod(selectElement) {
            // Similar to updateServicePaymentMethod
            console.log("Product payment method changed to:", selectElement.value);
        }

        function removeRow(button) {
            button.closest('.flex').remove();
        }

        function clearInputFields() {
            document.getElementById('clientName').value = '';
            document.getElementById('professionalName').value = '';
            document.getElementById('services-container').innerHTML = ''; // Clear all service rows
            document.getElementById('products-sold-container').innerHTML = ''; // Clear all product rows
            addServiceRow(); // Add one empty service row back
            addProductSoldRow(); // Add one empty product row back
        }
        // --- End Dynamic Input Row Management ---

        // --- Ficha Management Functions ---
        async function addFicha() {
            if (!window.db || !window.userId || !window.fichasCollectionRef) {
                showMessage('Firebase não inicializado ou usuário não autenticado. Por favor, aguarde alguns segundos e tente novamente.', 'error');
                return;
            }

            const clientName = document.getElementById('clientName').value.trim();
            const professionalName = document.getElementById('professionalName').value.trim();

            if (!clientName || !professionalName) {
                showMessage('Por favor, preencha o nome da Cliente e da Profissional.', 'error');
                return;
            }

            const services = [];
            document.querySelectorAll('.service-row').forEach(row => {
                const name = row.querySelector('.service-name').value.trim();
                const value = parseFloat(row.querySelector('.service-value').value) || 0;
                const paymentMethod = row.querySelector('select').value; // Get payment method
                if (name && value > 0) {
                    services.push({ name, value, paymentMethod });
                }
            });

            const productsSold = [];
            document.querySelectorAll('.product-sold-row').forEach(row => {
                const name = row.querySelector('.product-sold-name').value.trim();
                const value = parseFloat(row.querySelector('.product-sold-value').value) || 0;
                const paymentMethod = row.querySelector('select').value; // Get payment method
                if (name && value > 0) {
                    productsSold.push({ name, value, paymentMethod });
                }
            });

            if (services.length === 0 && productsSold.length === 0) {
                showMessage('Por favor, adicione pelo menos um serviço ou um produto vendido.', 'error');
                return;
            }

            const totalFicha = services.reduce((sum, s) => sum + s.value, 0) + productsSold.reduce((sum, p) => sum + p.value, 0);

            const newFicha = {
                clientName,
                professionalName,
                services,
                productsSold,
                totalFicha,
                timestamp: new Date().toISOString() // Para ordenação e ID único
            };

            const fichaId = await saveFichaToFirestore(newFicha);
            if (fichaId) {
                fichas.push({ id: fichaId, ...newFicha }); // Adiciona ao array local apenas após salvar no Firestore
                renderFichasTable();
                clearInputFields();
            }
        }

        async function removeFicha(index) {
            const fichaToRemove = fichas[index];
            if (!fichaToRemove || !fichaToRemove.id) {
                showMessage('Erro: Ficha ou ID da ficha não encontrado para remoção.', 'error');
                return;
            }

            const removed = await removeFichaFromFirestore(fichaToRemove.id);
            if (removed) {
                fichas.splice(index, 1); // Remove do array local apenas se removido do Firestore
                renderFichasTable();
            }
        }

        async function clearAllFichas() {
            if (!window.db || !window.userId || !window.fichasCollectionRef) {
                showMessage('Firebase não inicializado ou usuário não autenticado. Não foi possível limpar as fichas.', 'error');
                return;
            }
            showMessage('Limpando todas as fichas no Firestore...', 'info');
            try {
                const querySnapshot = await window.getDocs(window.fichasCollectionRef);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/users/${window.userId}/fichas`, doc.id)));
                });
                await Promise.all(deletePromises);
                fichas = []; // Limpa o array local após a exclusão no Firestore
                renderFichasTable();
                showMessage('Todas as fichas foram limpas (Firestore).', 'success');
            } catch (e) {
                console.error("Erro ao limpar todas as fichas do Firestore: ", e);
                showMessage('Erro ao limpar todas as fichas da nuvem: ' + e.message, 'error');
            }
        }

        function renderFichasTable() {
            const tableBody = document.getElementById('fichas-table-body');
            tableBody.innerHTML = ''; // Clear existing rows

            if (fichas.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="py-3 px-6 text-center text-gray-500">Nenhuma ficha registrada ainda.</td></tr>`;
                return;
            }

            fichas.forEach((ficha, index) => {
                const row = tableBody.insertRow();
                row.className = 'border-b border-gray-200 hover:bg-gray-100';

                // Client Name
                const clientCell = row.insertCell();
                clientCell.className = 'py-3 px-6 text-left whitespace-nowrap';
                clientCell.textContent = ficha.clientName;

                // Professional Name
                const professionalCell = row.insertCell();
                professionalCell.className = 'py-3 px-6 text-left whitespace-nowrap';
                professionalCell.textContent = ficha.professionalName;

                // Services
                const servicesCell = row.insertCell();
                servicesCell.className = 'py-3 px-6 text-left';
                servicesCell.innerHTML = ficha.services.map(s => `
                    <p>${s.name} (R$ ${s.value.toFixed(2).replace('.', ',')}) - ${s.paymentMethod || 'N/A'}</p>
                `).join('');
                if (ficha.services.length === 0) servicesCell.textContent = 'Nenhum';

                // Products Sold
                const productsCell = row.insertCell();
                productsCell.className = 'py-3 px-6 text-left';
                productsCell.innerHTML = ficha.productsSold.map(p => `
                    <p>${p.name} (R$ ${p.value.toFixed(2).replace('.', ',')}) - ${p.paymentMethod || 'N/A'}</p>
                `).join('');
                if (ficha.productsSold.length === 0) productsCell.textContent = 'Nenhum';

                // Total Ficha
                const totalCell = row.insertCell();
                totalCell.className = 'py-3 px-6 text-center font-bold';
                totalCell.textContent = `R$ ${ficha.totalFicha.toFixed(2).replace('.', ',')}`;

                // Actions
                const actionsCell = row.insertCell();
                actionsCell.className = 'py-3 px-6 text-center';
                actionsCell.innerHTML = `
                    <button onclick="removeFicha(${index})" class="text-red-600 hover:text-red-800 font-medium">Remover</button>
                `;
            });
        }
        // --- End Ficha Management Functions ---

        // --- File Operations ---
        function exportFichasToFile() {
            const dataToSave = fichas;
            const jsonString = JSON.stringify(dataToSave, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `fichas_clientes_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessage('Fichas exportadas para arquivo JSON!', 'success');
        }

        function importFichasFromFile() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';

            fileInput.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) {
                    showMessage('Nenhum arquivo selecionado.', 'info');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);

                        if (Array.isArray(importedData) && importedData.every(item => typeof item === 'object' && item !== null && 'clientName' in item && 'professionalName' in item)) {
                            fichas = importedData;
                            renderFichasTable();
                            showMessage('Fichas importadas com sucesso!', 'success');
                        } else {
                            showMessage('Formato de arquivo JSON inválido para fichas. Verifique o conteúdo.', 'error');
                        }
                    } catch (parseError) {
                        showMessage('Erro ao ler o arquivo: Não é um JSON válido.', 'error');
                    }
                };
                reader.readAsText(file);
            };

            fileInput.click();
        }
        // --- End File Operations ---


        // --- Integration with Weekly Closing System (Firestore) ---
        async function generateAndExportWeeklyData() {
            if (!window.db || !window.userId || !window.fichasCollectionRef) {
                showMessage('Firebase não inicializado ou usuário não autenticado. Não foi possível exportar dados para fechamento semanal.', 'error');
                console.error("Erro: Firebase não inicializado ou usuário não autenticado ao tentar exportar dados semanais.");
                return;
            }

            console.log("Iniciando a geração e exportação de dados semanais...");
            const aggregatedData = {
                collaborators: {}, // Use an object to easily group by professional name
                products: []
            };

            fichas.forEach(ficha => {
                const professionalName = ficha.professionalName.trim();

                // Aggregate services by professional
                if (!aggregatedData.collaborators[professionalName]) {
                    aggregatedData.collaborators[professionalName] = {
                        name: professionalName,
                        clients: [], // Will store { name: clientName, value: serviceValue } for this professional
                        discountPercentage: 0.30 // Default, can be adjusted in the main app
                    };
                }
                ficha.services.forEach(service => {
                    // For simplicity, each service is treated as a client entry for the professional's total
                    // If a professional does multiple services for the same client, they'll appear as separate entries
                    // This matches the current structure of the main app's 'clients' array
                    aggregatedData.collaborators[professionalName].clients.push({
                        name: ficha.clientName + ' - ' + service.name, // Combine client and service for clarity
                        value: service.value,
                        paymentMethod: service.paymentMethod || 'pix' // Include payment method
                    });
                });

                // Aggregate products
                ficha.productsSold.forEach(product => {
                    aggregatedData.products.push({
                        clientName: ficha.clientName + ' - ' + product.name, // Combine client and product for clarity
                        value: product.value,
                        paymentMethod: product.paymentMethod || 'pix' // Include payment method
                    });
                });
            });

            // Convert collaborators object back to an array
            const finalCollaboratorsArray = Object.values(aggregatedData.collaborators);

            const dataToExport = {
                collaborators: finalCollaboratorsArray,
                products: aggregatedData.products,
                lastUpdated: new Date().toISOString() // Adiciona um timestamp de atualização
            };

            console.log("Dados agregados para exportação:", dataToExport);
            await saveWeeklyReportDataToFirestore(dataToExport);
            console.log("Chamada para saveWeeklyReportDataToFirestore concluída.");
        }
        // --- End Integration ---

        // --- Initialization ---
        function initializeAppLogic() {
            console.log("initializeAppLogic called. window.db:", window.db, "window.userId:", window.userId); // Debug log
            loadFichasFromFirestore(); // Carrega fichas do Firestore
            // Ensure there's always at least one empty row for input
            if (document.querySelectorAll('.service-row').length === 0) {
                addServiceRow();
            }
            if (document.querySelectorAll('.product-sold-row').length === 0) {
                addProductSoldRow();
            }
            // Habilitar botões após a inicialização do Firebase e autenticação
            document.getElementById('addFichaBtn').disabled = false;
            document.getElementById('clearAllFichasBtn').disabled = false;
            document.getElementById('exportWeeklyDataBtn').disabled = false;
            document.getElementById('exportFichasToFileBtn').disabled = false;
            document.getElementById('importFichasFromFileBtn').disabled = false;
            document.getElementById('saveFichasToCloudBtn').disabled = false;
            document.getElementById('loadFichasFromCloudBtn').disabled = false;
            console.log("Buttons enabled."); // Debug log
        }
    </script>
</body>
</html>


