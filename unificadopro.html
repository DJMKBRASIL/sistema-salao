<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Fichas de Cliente</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut, 
            setPersistence, 
            browserLocalPersistence 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            deleteDoc, 
            collection, 
            getDocs, 
            addDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyD7FwQZspQNYZmNlQv8oNglccBXHmduW5w", 
            authDomain: "sistema-do-salao.firebaseapp.com", 
            projectId: "sistema-do-salao",   
            storageBucket: "sistema-do-salao.firebasestorage.app", 
            messagingSenderId: "395887083088", 
            appId: "1:395887083088:web:3a41fd836cc59a976ddb55"
        };
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.app = null;
        window.db = null;
        window.auth = null;
        window.userId = 'Carregando...'; 
        window.fichasCollectionRef = null; 

        async function initializeFirebase() {
            try {
                window.app = initializeApp(window.firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);
                
                await setPersistence(window.auth, browserLocalPersistence);
                console.log("Firebase inicializado com sucesso");

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        const authorizedCollaborators = [
                            "djmkbrasil@gmail.com",
                            "frankokott@gmail.com",
                            "djmkapple@gmail.com",
                            "gabrielastephane11@gmail.com",
                            "cibemarchi@gmail.com"
                        ];

                        if (authorizedCollaborators.includes(user.email)) {
                            document.getElementById('main-content').style.display = 'block';
                            window.userId = user.uid;
                            const displayInfo = user.displayName || user.email;
                            
                            document.getElementById('user-id-display').textContent = `Usuário: ${displayInfo}`;
                            document.getElementById('auth-buttons').innerHTML = `
                                <button onclick="window.fichasApp.signOutUser()" class="btn btn-danger">Sair</button>
                            `;
                            
                            console.log("Colaboradora autorizada:", user.email);
                            window.fichasCollectionRef = collection(window.db, `artifacts/${window.appId}/users/${window.userId}/fichas`);
                            
                            if (window.db) {
                                window.fichasApp.init(); 
                            } else {
                                window.fichasApp.showMessage('Erro: Banco de dados não disponível.', 'error');
                            }
                        } else {
                            document.getElementById('main-content').style.display = 'none';
                            window.fichasApp.showMessage('Acesso não autorizado para este e-mail.', 'error');
                            setTimeout(() => window.fichasApp.signOutUser(), 3000);
                        }
                    } else {
                        window.userId = 'Não autenticado';
                        document.getElementById('user-id-display').textContent = `Usuário: ${window.userId}`;
                        document.getElementById('auth-buttons').innerHTML = `
                            <button onclick="window.fichasApp.signInWithGoogle()" class="btn btn-primary">Entrar com Google</button>
                        `;
                        document.getElementById('main-content').style.display = 'none';
                        if (window.fichasApp) {
                           window.fichasApp.disableAuthRequiredButtons();
                        }
                    }
                });

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                window.fichasApp.showMessage('Erro ao inicializar o Firebase. Verifique a configuração.', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', initializeFirebase);
        
        window.fichasApp = {
            fichas: [],
            
            init() {
                this.loadFichasFromFirestore();
                if (document.querySelectorAll('.service-row').length === 0) this.addServiceRow();
                if (document.querySelectorAll('.product-sold-row').length === 0) this.addProductSoldRow();
                this.enableButtons();
            },

            enableButtons() {
                ['addFichaBtn', 'clearAllFichasBtn', 'exportWeeklyDataBtn', 'reloadFichasBtn'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.disabled = false;
                });
            },

            disableAuthRequiredButtons() {
                ['addFichaBtn', 'clearAllFichasBtn', 'exportWeeklyDataBtn', 'reloadFichasBtn'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.disabled = true;
                });
            },
            
            showMessage(message, type = 'success') {
                const msgDiv = document.getElementById('app-message');
                msgDiv.textContent = message;
                msgDiv.className = `message message-${type}`;
                setTimeout(() => { msgDiv.className = 'message hidden'; }, 5000);
            },

            async signInWithGoogle() {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(window.auth, provider);
                } catch (error) {
                    this.showMessage('Erro ao autenticar: ' + error.message, 'error');
                }
            },

            async signOutUser() {
                try {
                    await signOut(window.auth);
                    window.location.reload();
                } catch (error) {
                    this.showMessage('Erro ao sair: ' + error.message, 'error');
                }
            },
            
            showClearAllFichasConfirm() {
                document.getElementById('confirm-message').textContent = 'Tem certeza que deseja limpar todas as fichas?';
                document.getElementById('custom-confirm-modal').style.display = 'flex';
            },

            handleConfirm(confirmed) {
                document.getElementById('custom-confirm-modal').style.display = 'none';
                if (confirmed) {
                    this.clearAllFichas();
                }
            },

            async saveFichaToFirestore(fichaData) {
                if (!window.fichasCollectionRef) return null;
                this.toggleLoadingSpinner('add-ficha', true);
                try {
                    const docRef = await addDoc(window.fichasCollectionRef, fichaData);
                    return docRef.id;
                } catch (e) {
                    this.showMessage('Erro ao salvar ficha: ' + e.message, 'error');
                    return null;
                } finally {
                    this.toggleLoadingSpinner('add-ficha', false);
                }
            },

            async loadFichasFromFirestore() {
                if (!window.fichasCollectionRef) return;
                this.showMessage('Carregando fichas da nuvem...', 'info');
                this.toggleLoadingSpinner('reload-fichas', true);
                try {
                    this.fichas = []; 
                    const querySnapshot = await getDocs(window.fichasCollectionRef);
                    querySnapshot.forEach((doc) => {
                        this.fichas.push({ id: doc.id, ...doc.data() });
                    });
                    this.renderFichasTable();
                    this.showMessage('Fichas carregadas com sucesso!', 'success');
                } catch (e) {
                    this.showMessage('Erro ao carregar fichas: ' + e.message, 'error');
                } finally {
                    this.toggleLoadingSpinner('reload-fichas', false);
                }
            },

            async removeFichaFromFirestore(fichaId) {
                if (!window.db || !window.userId) return false;
                try {
                    await deleteDoc(doc(window.db, `artifacts/${window.appId}/users/${window.userId}/fichas`, fichaId));
                    return true;
                } catch (e) {
                    this.showMessage('Erro ao remover ficha: ' + e.message, 'error');
                    return false;
                }
            },
            
            addServiceRow(serviceData = {}) {
                const container = document.getElementById('services-container');
                const div = document.createElement('div');
                const today = new Date().toISOString().split('T')[0];

                div.className = 'grid grid-cols-1 md:grid-cols-5 gap-2 items-center mb-2 service-row p-2 border rounded-lg bg-white';
                div.innerHTML = `
                    <input type="date" value="${serviceData.date || today}" class="service-date form-input md:col-span-1">
                    <input type="text" placeholder="Nome do Serviço" value="${serviceData.name || ''}" class="service-name form-input md:col-span-2">
                    <input type="number" step="0.01" min="0" placeholder="Valor" value="${serviceData.value || ''}" class="service-value form-input w-full text-right md:col-span-1">
                    <div class="md:col-span-1 flex items-center gap-1">
                        <select class="payment-method form-select w-full">
                            <option value="pix" ${serviceData.paymentMethod === 'pix' ? 'selected' : ''}>Pix</option>
                            <option value="debito" ${serviceData.paymentMethod === 'debito' ? 'selected' : ''}>Débito</option>
                            <option value="credito_1x" ${serviceData.paymentMethod === 'credito_1x' ? 'selected' : ''}>Crédito 1x</option>
                            <option value="credito_2x" ${serviceData.paymentMethod === 'credito_2x' ? 'selected' : ''}>Crédito 2x</option>
                            <option value="credito_3x" ${serviceData.paymentMethod === 'credito_3x' ? 'selected' : ''}>Crédito 3x</option>
                            <option value="dinheiro" ${serviceData.paymentMethod === 'dinheiro' ? 'selected' : ''}>Dinheiro</option>
                        </select>
                        <button onclick="this.closest('.service-row').remove()" class="btn btn-danger p-2 flex-shrink-0">X</button>
                    </div>
                `;
                container.appendChild(div);
            },

            addProductSoldRow(productName = '', productValue = '', paymentMethod = 'pix') {
                const container = document.getElementById('products-sold-container');
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 mb-2 product-sold-row';
                div.innerHTML = `
                    <input type="text" placeholder="Nome do Produto" value="${productName}" class="product-sold-name form-input flex-grow">
                    <input type="number" step="0.01" min="0" placeholder="Valor" value="${productValue}" class="product-sold-value form-input w-28 text-right">
                    <select class="payment-method form-select w-32">
                         <option value="pix" ${paymentMethod === 'pix' ? 'selected' : ''}>Pix</option>
                        <option value="debito" ${paymentMethod === 'debito' ? 'selected' : ''}>Débito</option>
                        <option value="credito_1x" ${paymentMethod === 'credito_1x' ? 'selected' : ''}>Crédito 1x</option>
                        <option value="credito_2x" ${paymentMethod === 'credito_2x' ? 'selected' : ''}>Crédito 2x</option>
                        <option value="credito_3x" ${paymentMethod === 'credito_3x' ? 'selected' : ''}>Crédito 3x</option>
                        <option value="dinheiro" ${paymentMethod === 'dinheiro' ? 'selected' : ''}>Dinheiro</option>
                    </select>
                    <button onclick="this.closest('.product-sold-row').remove()" class="btn btn-danger p-2">X</button>
                `;
                container.appendChild(div);
            },

            clearInputFields() {
                document.getElementById('clientName').value = '';
                document.getElementById('professionalName').value = '';
                document.getElementById('services-container').innerHTML = ''; 
                document.getElementById('products-sold-container').innerHTML = ''; 
                this.addServiceRow(); 
                this.addProductSoldRow();
            },

            async addFicha() {
                const clientName = document.getElementById('clientName').value.trim();
                const professionalName = document.getElementById('professionalName').value.trim();
                if (!clientName || !professionalName) return this.showMessage('Preencha o nome da Cliente e da Profissional.', 'error');

                const services = Array.from(document.querySelectorAll('.service-row')).map(row => ({
                    date: row.querySelector('.service-date').value,
                    name: row.querySelector('.service-name').value.trim(),
                    value: parseFloat(row.querySelector('.service-value').value) || 0,
                    paymentMethod: row.querySelector('.payment-method').value
                })).filter(s => s.name && s.value > 0);

                const productsSold = Array.from(document.querySelectorAll('.product-sold-row')).map(row => ({
                    name: row.querySelector('.product-sold-name').value.trim(),
                    value: parseFloat(row.querySelector('.product-sold-value').value) || 0,
                    paymentMethod: row.querySelector('.payment-method').value
                })).filter(p => p.name && p.value > 0);

                if (services.length === 0 && productsSold.length === 0) return this.showMessage('Adicione pelo menos um serviço ou produto.', 'error');

                const totalFicha = services.reduce((s, i) => s + i.value, 0) + productsSold.reduce((s, i) => s + i.value, 0);

                const newFicha = { clientName, professionalName, services, productsSold, totalFicha, timestamp: new Date().toISOString() };

                const fichaId = await this.saveFichaToFirestore(newFicha);
                if (fichaId) {
                    this.fichas.push({ id: fichaId, ...newFicha }); 
                    this.renderFichasTable();
                    this.clearInputFields();
                    this.showMessage('Ficha registrada com sucesso!', 'success');
                }
            },

            async removeFicha(index) {
                const fichaToRemove = this.fichas[index];
                if (!fichaToRemove) return;
                
                const removed = await this.removeFichaFromFirestore(fichaToRemove.id);
                if (removed) {
                    this.fichas.splice(index, 1); 
                    this.renderFichasTable();
                    this.showMessage('Ficha removida.', 'info');
                }
            },

            async clearAllFichas() {
                this.toggleLoadingSpinner('clear-fichas', true);
                try {
                    const deletePromises = this.fichas.map(ficha => this.removeFichaFromFirestore(ficha.id));
                    await Promise.all(deletePromises);
                    this.fichas = []; 
                    this.renderFichasTable();
                    this.showMessage('Todas as fichas foram limpas.', 'success');
                } catch(e) {
                    this.showMessage('Erro ao limpar fichas: ' + e.message, 'error');
                } finally {
                    this.toggleLoadingSpinner('clear-fichas', false);
                }
            },

            renderFichasTable() {
                const tableBody = document.getElementById('fichas-table-body');
                tableBody.innerHTML = ''; 

                if (this.fichas.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="py-3 px-6 text-center text-gray-500">Nenhuma ficha registrada.</td></tr>`;
                    return;
                }

                this.fichas.forEach((ficha, index) => {
                    const row = tableBody.insertRow();
                    row.className = 'border-b border-gray-200 hover:bg-gray-100';

                    const servicesHtml = ficha.services.map(s => {
                        const serviceDate = s.date ? new Date(s.date + 'T00:00:00') : null;
                        const formattedDate = serviceDate ? serviceDate.toLocaleDateString('pt-BR') : 'Sem data';
                        return `<p>${formattedDate} - ${s.name} (R$ ${s.value.toFixed(2).replace('.', ',')})</p>`
                    }).join('');
                    
                    row.innerHTML = `
                        <td class="py-3 px-6 text-left whitespace-nowrap">${ficha.clientName}</td>
                        <td class="py-3 px-6 text-left whitespace-nowrap">${ficha.professionalName}</td>
                        <td class="py-3 px-6 text-left">${servicesHtml || 'Nenhum'}</td>
                        <td class="py-3 px-6 text-left">${ficha.productsSold.map(p => `<p>${p.name} (R$ ${p.value.toFixed(2).replace('.', ',')})</p>`).join('') || 'Nenhum'}</td>
                        <td class="py-3 px-6 text-center font-bold">R$ ${ficha.totalFicha.toFixed(2).replace('.', ',')}</td>
                        <td class="py-3 px-6 text-center">
                            <button onclick="window.fichasApp.removeFicha(${index})" class="text-red-600 hover:text-red-800 font-medium">Remover</button>
                        </td>
                    `;
                });
            },
            
            async generateAndExportWeeklyData() {
                 if (!window.db || !window.userId) return this.showMessage('Não autenticado.', 'error');
                this.toggleLoadingSpinner('export-weekly', true);

                const aggregatedData = { collaborators: {}, products: [] };

                this.fichas.forEach(ficha => {
                    const profName = ficha.professionalName.trim();
                    if (!aggregatedData.collaborators[profName]) {
                        aggregatedData.collaborators[profName] = { name: profName, clients: [] };
                    }
                    ficha.services.forEach(service => {
                        aggregatedData.collaborators[profName].clients.push({ 
                            name: ficha.clientName,
                            service: service.name,
                            date: service.date,
                            value: service.value, 
                            paymentMethod: service.paymentMethod 
                        });
                    });
                    ficha.productsSold.forEach(product => {
                        aggregatedData.products.push({ clientName: `${ficha.clientName} - ${product.name}`, value: product.value, paymentMethod: product.paymentMethod });
                    });
                });

                const dataToExport = {
                    collaborators: Object.values(aggregatedData.collaborators),
                    products: aggregatedData.products,
                    lastUpdated: new Date().toISOString() 
                };
                
                try {
                    const docRef = doc(window.db, `artifacts/${window.appId}/users/${window.userId}/weeklyReportsAggregated/currentWeek`);
                    await setDoc(docRef, dataToExport);
                    this.showMessage('Dados exportados para o Fechamento Semanal com sucesso!', 'success');
                } catch (e) {
                    this.showMessage('Erro ao exportar dados: ' + e.message, 'error');
                } finally {
                    this.toggleLoadingSpinner('export-weekly', false);
                }
            },

            toggleLoadingSpinner(type, show) {
                const spinner = document.getElementById(`${type}-spinner`);
                const icon = document.getElementById(`${type}-icon`);
                if (spinner && icon) {
                    spinner.classList.toggle('hidden', !show);
                    icon.classList.toggle('hidden', show);
                }
            }
        };
    </script>
</head>
<body>
    <div class="main-container">
        <header class="header">
            <h1>Registro de Fichas de Cliente</h1>
            <p style="font-size: 1.2rem; margin-top: 0.5rem; opacity: 0.9;">Gerencie seus atendimentos</p>
        </header>

        <main class="content">
            <div class="section">
                <div class="flex items-center justify-between mb-4">
                    <p id="user-id-display" class="text-sm text-gray-500">Usuário: Carregando...</p>
                    <div id="auth-buttons" class="flex gap-2"></div>
                </div>
            </div>

            <div id="app-message" class="message hidden"></div>
            
            <div id="main-content" style="display: none;">
                <section class="section">
                    <h2 class="section-title">Nova Ficha de Atendimento</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="clientName" class="block text-sm font-medium text-gray-700">Nome da Cliente</label>
                            <input type="text" id="clientName" placeholder="Nome Completo da Cliente" class="form-input mt-1">
                        </div>
                        <div>
                            <label for="professionalName" class="block text-sm font-medium text-gray-700">Nome da Profissional</label>
                            <input type="text" id="professionalName" placeholder="Nome da Profissional" class="form-input mt-1">
                        </div>
                    </div>

                    <div class="mt-4">
                        <h3 class="text-md font-medium text-gray-700 mb-2">Serviços</h3>
                        <div class="hidden md:grid md:grid-cols-5 gap-2 items-center mb-2 text-sm font-bold text-gray-600 px-2">
                            <span class="md:col-span-1">Data</span>
                            <span class="md:col-span-2">Serviço</span>
                            <span class="md:col-span-1 text-right">Valor</span>
                            <span class="md:col-span-1">Pagamento</span>
                        </div>
                        <div id="services-container"></div>
                        <button onclick="window.fichasApp.addServiceRow()" class="btn btn-primary btn-full mt-2">Adicionar Serviço</button>
                    </div>

                    <div class="mt-4">
                        <h3 class="text-md font-medium text-gray-700 mb-2">Produtos Vendidos (Opcional)</h3>
                        <div id="products-sold-container"></div>
                        <button onclick="window.fichasApp.addProductSoldRow()" class="btn btn-success btn-full mt-2">Adicionar Produto</button>
                    </div>

                    <div class="mt-6 flex justify-end">
                        <button id="addFichaBtn" onclick="window.fichasApp.addFicha()" class="btn btn-primary text-lg font-bold" disabled>
                            <span id="add-ficha-spinner" class="loading-spinner mr-2 hidden"></span>
                            <span id="add-ficha-icon">Registrar Ficha</span>
                        </button>
                    </div>
                </section>

                <section class="section">
                    <h2 class="section-title">Fichas Registradas</h2>
                     <button id="reloadFichasBtn" onclick="window.fichasApp.loadFichasFromFirestore()" class="btn btn-info mb-4" disabled>
                        <span id="reload-fichas-spinner" class="loading-spinner mr-2 hidden"></span>
                        <span id="reload-fichas-icon">Recarregar Fichas (Nuvem)</span>
                    </button>
                    <div id="fichas-list" class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Cliente</th>
                                    <th class="py-3 px-6 text-left">Profissional</th>
                                    <th class="py-3 px-6 text-left">Serviços</th>
                                    <th class="py-3 px-6 text-left">Produtos</th>
                                    <th class="py-3 px-6 text-center">Total Ficha</th>
                                    <th class="py-3 px-6 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light" id="fichas-table-body">
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-6 flex flex-col sm:flex-row gap-3">
                        <button id="clearAllFichasBtn" onclick="window.fichasApp.showClearAllFichasConfirm()" class="btn btn-danger btn-full" disabled>
                            <span id="clear-fichas-spinner" class="loading-spinner mr-2 hidden"></span>
                            <span id="clear-fichas-icon">Limpar Todas as Fichas</span>
                        </button>
                        <button id="exportWeeklyDataBtn" onclick="window.fichasApp.generateAndExportWeeklyData()" class="btn btn-secondary btn-full" disabled>
                            <span id="export-weekly-spinner" class="loading-spinner mr-2 hidden"></span>
                            <span id="export-weekly-icon">Exportar para Fechamento</span>
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div id="custom-confirm-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Confirmar Ação</h3>
            <p class="text-gray-600 mb-4" id="confirm-message">Tem certeza?</p>
            <div class="flex justify-end gap-4 mt-6">
                <button class="btn btn-gray" onclick="window.fichasApp.handleConfirm(false)">Cancelar</button>
                <button class="btn btn-danger" onclick="window.fichasApp.handleConfirm(true)">Confirmar</button>
            </div>
        </div>
    </div>
</body>
</html>

