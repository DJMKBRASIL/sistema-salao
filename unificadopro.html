<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Fichas de Cliente</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --primary-color: #6366f1; --primary-hover: #4f46e5; --secondary-color: #8b5cf6;
            --success-color: #10b981; --warning-color: #f59e0b; --danger-color: #ef4444;
            --info-color: #3b82f6; --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
            --border-radius: 0.75rem;
        }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .main-container { max-width: 1200px; margin: 2rem auto; background: white; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; padding: 2rem; text-align: center; border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); }
        .content { padding: 2rem; }
        .section { background: var(--gray-50); border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--gray-200); }
        .section-title { font-size: 1.5rem; font-weight: 600; color: #1f2937; margin-bottom: 1.5rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 500; border: none; cursor: pointer; transition: all 0.2s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-info { background-color: var(--info-color); color: white; }
        .btn-gray { background-color: #d1d5db; color: #374151; }
        .form-input, .form-select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; }
        .message { padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; font-weight: 500; display: none; }
        .message-success { background-color: #d1fae5; color: #065f46; }
        .message-error { background-color: #fee2e2; color: #991b1b; }
        .message-info { background-color: #dbeafe; color: #1e40af; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; border-radius: var(--border-radius); padding: 2rem; max-width: 500px; width: 90%; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="main-container">
        <header class="header">
            <h1 class="text-4xl font-bold">Registro de Fichas de Cliente</h1>
            <p class="text-xl mt-2">Gerencie seus atendimentos</p>
        </header>

        <main class="content">
            <div class="section">
                <div class="flex items-center justify-between">
                    <p id="user-id-display" class="text-sm text-gray-600">Carregando...</p>
                    <div id="auth-buttons"></div>
                </div>
            </div>

            <div id="app-message" class="message"></div>
            
            <div id="main-content" class="hidden">
                <section class="section">
                    <h2 class="section-title">Nova Ficha</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input type="text" id="clientName" placeholder="Nome da Cliente" class="form-input">
                        <input type="text" id="professionalName" placeholder="Nome da Profissional" class="form-input">
                    </div>
                    <div id="services-container" class="space-y-3"></div>
                    <button onclick="window.fichasApp.addServiceRow()" class="btn btn-primary w-full mt-3">Adicionar Serviço</button>
                    <div class="mt-6 flex justify-end">
                        <button id="addFichaBtn" onclick="window.fichasApp.addFicha()" class="btn btn-success text-lg" disabled>Registrar Ficha</button>
                    </div>
                </section>

                <section class="section">
                    <h2 class="section-title">Fichas Registradas</h2>
                    <button id="reloadFichasBtn" onclick="window.fichasApp.loadFichasFromFirestore()" class="btn btn-info mb-4" disabled>Recarregar Fichas</button>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Data</th>
                                    <th class="py-3 px-6 text-left">Cliente</th>
                                    <th class="py-3 px-6 text-left">Profissional</th>
                                    <th class="py-3 px-6 text-left">Serviço</th>
                                    <th class="py-3 px-6 text-right">Valor</th>
                                    <th class="py-3 px-6 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="fichas-table-body" class="text-gray-700 text-sm"></tbody>
                        </table>
                    </div>
                    <div class="mt-6 flex flex-col md:flex-row gap-3">
                        <button id="clearAllFichasBtn" onclick="window.fichasApp.showClearAllFichasConfirm()" class="btn btn-danger" disabled>Limpar Todas as Fichas</button>
                        <button id="exportWeeklyDataBtn" onclick="window.fichasApp.generateAndExportWeeklyData()" class="btn btn-secondary" disabled>Exportar para Fechamento</button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div id="custom-confirm-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4">Confirmar Ação</h3>
            <p id="confirm-message" class="mb-4">Tem certeza?</p>
            <div class="flex justify-end gap-4">
                <button class="btn btn-gray" onclick="window.fichasApp.handleConfirm(false)">Cancelar</button>
                <button class="btn btn-danger" onclick="window.fichasApp.handleConfirm(true)">Confirmar</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut, 
            setPersistence, 
            browserLocalPersistence 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDocs, 
            setDoc, 
            deleteDoc, 
            collection, 
            addDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyD7FwQZspQNYZmNlQv8oNglccBXHmduW5w", 
            authDomain: "sistema-do-salao.firebaseapp.com", 
            projectId: "sistema-do-salao",   
            storageBucket: "sistema-do-salao.firebasestorage.app", 
            messagingSenderId: "395887083088", 
            appId: "1:395887083088:web:3a41fd836cc59a976ddb55"
        };

        let db, auth, fichasCollectionRef;

        async function initializeFirebase() {
            try {
                const app = initializeApp(window.firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await setPersistence(auth, browserLocalPersistence);

                onAuthStateChanged(auth, (user) => {
                    const mainContent = document.getElementById('main-content');
                    if (user) {
                        const authorizedCollaborators = [
                            "djmkbrasil@gmail.com", "frankokott@gmail.com", "djmkapple@gmail.com",
                            "gabrielastephane11@gmail.com", "cibemarchi@gmail.com"
                        ];

                        if (authorizedCollaborators.includes(user.email)) {
                            mainContent.classList.remove('hidden');
                            document.getElementById('user-id-display').textContent = `Usuário: ${user.displayName || user.email}`;
                            document.getElementById('auth-buttons').innerHTML = `<button onclick="window.fichasApp.signOutUser()" class="btn btn-danger">Sair</button>`;
                            
                            fichasCollectionRef = collection(db, `artifacts/${window.appId}/shared_data/fichas`);
                            window.fichasApp.init();
                        } else {
                            mainContent.classList.add('hidden');
                            window.fichasApp.showMessage('Acesso não autorizado.', 'error');
                            setTimeout(() => window.fichasApp.signOutUser(), 3000);
                        }
                    } else {
                        mainContent.classList.add('hidden');
                        document.getElementById('user-id-display').textContent = `Usuário: Não autenticado`;
                        document.getElementById('auth-buttons').innerHTML = `<button onclick="window.fichasApp.signInWithGoogle()" class="btn btn-primary">Entrar com Google</button>`;
                        window.fichasApp.disableButtons();
                    }
                });
            } catch (error) {
                if(window.fichasApp) window.fichasApp.showMessage('Erro ao inicializar o sistema.', 'error');
            }
        }
        
        window.fichasApp = {
            fichas: [],
            confirmAction: null,
            
            init() {
                this.loadFichasFromFirestore();
                if(document.getElementById('services-container').children.length === 0) {
                    this.addServiceRow();
                }
                this.enableButtons();
            },

            enableButtons() {
                ['addFichaBtn', 'clearAllFichasBtn', 'exportWeeklyDataBtn', 'reloadFichasBtn'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.disabled = false;
                });
            },

            disableButtons() {
                 ['addFichaBtn', 'clearAllFichasBtn', 'exportWeeklyDataBtn', 'reloadFichasBtn'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.disabled = true;
                });
            },
            
            showMessage(message, type = 'info') {
                const msgDiv = document.getElementById('app-message');
                msgDiv.textContent = message;
                msgDiv.className = `message message-${type}`;
                msgDiv.style.display = 'block';
                setTimeout(() => { msgDiv.style.display = 'none'; }, 5000);
            },

            async signInWithGoogle() {
                const provider = new GoogleAuthProvider();
                try { await signInWithPopup(auth, provider); } 
                catch (error) { this.showMessage('Erro ao autenticar: ' + error.message, 'error'); }
            },

            async signOutUser() {
                try { await signOut(auth); window.location.reload(); } 
                catch (error) { this.showMessage('Erro ao sair: ' + error.message, 'error'); }
            },
            
            showClearAllFichasConfirm() {
                this.confirmAction = this.clearAllFichas.bind(this);
                document.getElementById('confirm-message').textContent = 'Tem certeza que deseja limpar TODAS as fichas? Esta ação não pode ser desfeita.';
                document.getElementById('custom-confirm-modal').style.display = 'flex';
            },

            handleConfirm(confirmed) {
                document.getElementById('custom-confirm-modal').style.display = 'none';
                if (confirmed && typeof this.confirmAction === 'function') {
                    this.confirmAction();
                }
                this.confirmAction = null;
            },

            async saveFichaToFirestore(ficha) {
                try {
                    const docRef = await addDoc(fichasCollectionRef, ficha);
                    return docRef.id;
                } catch (e) {
                    this.showMessage('Erro ao salvar ficha: ' + e.message, 'error');
                    return null;
                }
            },

            async loadFichasFromFirestore() {
                if (!fichasCollectionRef) return;
                this.showMessage('Carregando fichas...', 'info');
                try {
                    const querySnapshot = await getDocs(fichasCollectionRef);
                    this.fichas = [];
                    querySnapshot.forEach((doc) => this.fichas.push({ id: doc.id, ...doc.data() }));
                    this.renderFichasTable();
                } catch (e) { this.showMessage('Erro ao carregar fichas: ' + e.message, 'error'); }
            },

            async removeFichaFromFirestore(id) {
                try { await deleteDoc(doc(fichasCollectionRef, id)); return true; } 
                catch (e) { this.showMessage('Erro ao remover ficha: ' + e.message, 'error'); return false; }
            },
            
            addServiceRow() {
                const container = document.getElementById('services-container');
                const div = document.createElement('div');
                div.className = 'grid grid-cols-1 md:grid-cols-6 gap-2 items-center service-row border p-2 rounded-md';
                const today = new Date().toISOString().split('T')[0];
                div.innerHTML = `
                    <input type="date" value="${today}" class="service-date form-input md:col-span-1">
                    <input type="text" placeholder="Serviço" class="service-name form-input md:col-span-2">
                    <input type="number" step="0.01" min="0" placeholder="Valor" class="service-value form-input text-right">
                    <select class="payment-method form-select md:col-span-1">
                        <option value="pix">Pix</option> <option value="debito">Débito</option>
                        <option value="credito_1x">Crédito 1x</option> <option value="credito_2x">Crédito 2x</option>
                        <option value="credito_3x">Crédito 3x</option> <option value="dinheiro">Dinheiro</option>
                    </select>
                    <button onclick="this.parentElement.remove()" class="btn btn-danger p-2 col-span-1 md:col-auto justify-center">X</button>
                `;
                container.appendChild(div);
            },

            async addFicha() {
                const clientName = document.getElementById('clientName').value.trim();
                const professionalName = document.getElementById('professionalName').value.trim();
                if (!clientName || !professionalName) return this.showMessage('Preencha Cliente e Profissional.', 'error');
                
                const services = Array.from(document.querySelectorAll('.service-row')).map(row => {
                    const name = row.querySelector('.service-name').value.trim();
                    const value = parseFloat(row.querySelector('.service-value').value) || 0;
                    if (name && value > 0) {
                        return {
                            date: row.querySelector('.service-date').value,
                            name, value,
                            paymentMethod: row.querySelector('.payment-method').value
                        };
                    }
                    return null;
                }).filter(Boolean);

                if (services.length === 0) return this.showMessage('Adicione pelo menos um serviço válido.', 'error');
                
                for (const service of services) {
                    const ficha = {
                        date: service.date,
                        clientName, professionalName,
                        serviceName: service.name,
                        serviceValue: service.value,
                        paymentMethod: service.paymentMethod,
                        timestamp: new Date().toISOString()
                    };
                    const id = await this.saveFichaToFirestore(ficha);
                    if (id) this.fichas.push({ id, ...ficha });
                }
                this.renderFichasTable();
                this.clearInputFields();
                this.showMessage(`${services.length} serviço(s) registrado(s) com sucesso!`, 'success');
            },
            
            clearInputFields() {
                document.getElementById('clientName').value = '';
                document.getElementById('professionalName').value = '';
                document.getElementById('services-container').innerHTML = '';
                this.addServiceRow();
            },

            async removeFicha(index) {
                const ficha = this.fichas[index];
                if (await this.removeFichaFromFirestore(ficha.id)) {
                    this.fichas.splice(index, 1);
                    this.renderFichasTable();
                    this.showMessage('Ficha removida.', 'info');
                }
            },

            async clearAllFichas() {
                this.showMessage('Limpando todas as fichas...', 'info');
                for (const ficha of this.fichas) {
                    await this.removeFichaFromFirestore(ficha.id);
                }
                this.fichas = [];
                this.renderFichasTable();
                this.showMessage('Todas as fichas foram limpas.', 'success');
            },

            renderFichasTable() {
                const tableBody = document.getElementById('fichas-table-body');
                tableBody.innerHTML = ''; 
                this.fichas.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                if (this.fichas.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center">Nenhuma ficha registrada.</td></tr>`;
                    return;
                }
                
                this.fichas.forEach((ficha, index) => {
                    const row = tableBody.insertRow();
                    row.className = 'border-b hover:bg-gray-100';
                    row.innerHTML = `
                        <td class="px-6 py-4">${new Date(ficha.date + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                        <td class="px-6 py-4">${ficha.clientName}</td>
                        <td class="px-6 py-4">${ficha.professionalName}</td>
                        <td class="px-6 py-4">${ficha.serviceName}</td>
                        <td class="px-6 py-4 text-right">R$ ${ficha.serviceValue.toFixed(2).replace('.', ',')}</td>
                        <td class="px-6 py-4 text-center"><button onclick="window.fichasApp.removeFicha(${index})" class="text-red-600 font-medium">Remover</button></td>
                    `;
                });
            },
            
            async generateAndExportWeeklyData() {
                this.showMessage('Exportando dados...', 'info');
                const aggregated = { collaborators: {}, products: [] }; 

                this.fichas.forEach(f => {
                    if (!aggregated.collaborators[f.professionalName]) {
                        aggregated.collaborators[f.professionalName] = { name: f.professionalName, clients: [] };
                    }
                    aggregated.collaborators[f.professionalName].clients.push({
                        name: f.clientName,
                        service: f.serviceName,
                        date: f.date,
                        value: f.serviceValue,
                        paymentMethod: f.paymentMethod
                    });
                });
                
                const dataToExport = {
                    collaborators: Object.values(aggregated.collaborators),
                    products: aggregated.products, // Will be empty in this version
                    lastUpdated: new Date().toISOString() 
                };
                
                try {
                    const docRef = doc(db, `artifacts/${window.appId}/shared_data/weeklyReportsAggregated/currentWeek`);
                    await setDoc(docRef, dataToExport);
                    this.showMessage('Dados exportados com sucesso!', 'success');
                } catch (e) {
                    this.showMessage('Erro ao exportar: ' + e.message, 'error');
                }
            }
        };

        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>

