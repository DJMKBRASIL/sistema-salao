<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Fichas de Cliente</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut, 
            setPersistence, 
            browserLocalPersistence 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            deleteDoc, 
            collection, 
            getDocs, 
            addDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyD7FwQZspQNYZmNlQv8oNglccBXHmduW5w", 
            authDomain: "sistema-do-salao.firebaseapp.com", 
            projectId: "sistema-do-salao",   
            storageBucket: "sistema-do-salao.firebasestorage.app", 
            messagingSenderId: "395887083088", 
            appId: "1:395887083088:web:3a41fd836cc59a976ddb55"
        };
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        window.app = null;
        window.db = null;
        window.auth = null;
        window.userId = 'Carregando...'; 
        window.fichasCollectionRef = null; 

        async function initializeFirebase() {
            try {
                window.app = initializeApp(window.firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);
                
                await setPersistence(window.auth, browserLocalPersistence);
                console.log("Firebase inicializado com sucesso");

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        // --- LISTA DE ACESSO PARA COLABORADORES E ADMIN ---
                        const allowedEmails = [
                            'djmkbrasil@gmail.com', // Admin
                            'frankokott@gmail.com',
                            'djmkapple@gmail.com',
                            'gabrielastephane11@gmail.com',
                            'cibemarchi@gmail.com'
                        ];

                        if (allowedEmails.includes(user.email)) {
                            // Usuário autorizado
                            document.getElementById('main-content').style.display = 'block';
                            window.userId = user.uid;
                            const displayInfo = user.displayName || user.email;
                            
                            document.getElementById('user-id-display').textContent = `Usuário: ${displayInfo}`;
                            document.getElementById('auth-buttons').innerHTML = `
                                <button onclick="window.fichasApp.signOutUser()" class="btn btn-danger">Sair</button>
                            `;
                            
                            console.log("Usuário autorizado autenticado:", user.email);
                            // CAMINHO ATUALIZADO: usa um caminho público compartilhado
                            window.fichasCollectionRef = collection(window.db, `artifacts/${window.appId}/public/data/fichas`);
                            
                            if (window.db) {
                                window.fichasApp.init();
                            } else {
                                window.fichasApp.showMessage('Erro: Banco de dados não disponível.', 'error');
                            }
                        } else {
                            // Usuário não autorizado
                            document.getElementById('main-content').style.display = 'none';
                            window.fichasApp.showMessage('Acesso negado. Você não tem permissão.', 'error');
                            setTimeout(() => window.fichasApp.signOutUser(), 3000);
                        }
                    } else {
                        // Nenhum usuário logado
                        window.userId = 'Não autenticado';
                        document.getElementById('user-id-display').textContent = `Usuário: ${window.userId}`;
                        document.getElementById('auth-buttons').innerHTML = `
                            <button onclick="window.fichasApp.signInWithGoogle()" class="btn btn-primary">Entrar com Google</button>
                        `;
                        document.getElementById('main-content').style.display = 'none';
                        window.fichasApp.disableAuthRequiredButtons();
                    }
                });

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                window.fichasApp.showMessage('Erro ao inicializar o Firebase.', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', initializeFirebase);
        
        window.doc = doc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.collection = collection;
        window.getDocs = getDocs;
        window.addDoc = addDoc; 
    </script>

    <style>
        /* Estilos (CSS) permanecem os mesmos do seu arquivo original */
        :root {
            --primary-color: #6366f1; --primary-hover: #4f46e5; --secondary-color: #8b5cf6;
            --success-color: #10b981; --warning-color: #f59e0b; --danger-color: #ef4444;
            --info-color: #3b82f6; --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
            --gray-300: #d1d5db; --gray-400: #9ca3af; --gray-500: #6b7280; --gray-600: #4b5563;
            --gray-700: #374151; --gray-800: #1f2937; --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --border-radius: 0.75rem; --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0; padding: 1rem; }
        .main-container { max-width: 1200px; margin: 0 auto; background: white; border-radius: var(--border-radius); overflow: hidden; }
        .header { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; padding: 2rem; text-align: center; }
        .header h1 { margin: 0; font-size: 2.5rem; font-weight: 700; }
        .content { padding: 2rem; }
        .section { background: var(--gray-50); border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--gray-200); }
        .section-title { font-size: 1.5rem; font-weight: 600; color: var(--gray-800); margin-bottom: 1.5rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 500; border: none; cursor: pointer; transition: var(--transition); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-info { background-color: var(--info-color); color: white; }
        .form-input { width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.5rem; }
        .message { padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; font-weight: 500; }
        .message-success { background-color: #d1fae5; color: #065f46; }
        .message-error { background-color: #fee2e2; color: #991b1b; }
        .message-info { background-color: #dbeafe; color: #1e40af; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="main-container">
        <header class="header">
            <h1>Registro de Fichas de Cliente</h1>
        </header>

        <main class="content">
            <div class="section">
                <div class="flex items-center justify-between mb-4">
                    <p id="user-id-display" class="text-sm text-gray-500">Usuário: Carregando...</p>
                    <div id="auth-buttons" class="flex gap-2"></div>
                </div>
            </div>

            <div id="app-message" class="message hidden"></div>

            <!-- O conteúdo principal agora tem um ID para poder ser ocultado -->
            <div id="main-content" style="display: none;">
                <section class="section">
                    <h2 class="section-title">Nova Ficha de Atendimento</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input type="text" id="clientName" placeholder="Nome da Cliente" class="form-input">
                        <input type="text" id="professionalName" placeholder="Nome da Profissional" class="form-input">
                    </div>
                    <div id="services-container" class="space-y-2"></div>
                    <button onclick="window.fichasApp.addServiceRow()" class="btn btn-primary w-full mt-2">Adicionar Serviço</button>
                    <div id="products-sold-container" class="space-y-2 mt-4"></div>
                    <button onclick="window.fichasApp.addProductSoldRow()" class="btn btn-success w-full mt-2">Adicionar Produto</button>
                    <div class="mt-6 flex justify-end">
                        <button id="addFichaBtn" onclick="window.fichasApp.addFicha()" class="btn btn-primary text-lg" disabled>
                            <span id="add-ficha-spinner" class="loading-spinner mr-2 hidden"></span>
                            <span id="add-ficha-icon">Registrar Ficha</span>
                        </button>
                    </div>
                </section>

                <section class="section">
                    <h2 class="section-title">Fichas Registradas</h2>
                    <div id="fichas-list" class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-200 text-gray-600 uppercase text-sm">
                                <tr>
                                    <th class="py-3 px-6 text-left">Cliente</th>
                                    <th class="py-3 px-6 text-left">Profissional</th>
                                    <th class="py-3 px-6 text-left">Serviços</th>
                                    <th class="py-3 px-6 text-left">Produtos</th>
                                    <th class="py-3 px-6 text-center">Total</th>
                                    <th class="py-3 px-6 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="fichas-table-body" class="text-gray-600 text-sm"></tbody>
                        </table>
                    </div>
                    <div class="mt-6 flex flex-col sm:flex-row gap-3">
                        <button id="clearAllFichasBtn" onclick="window.fichasApp.showClearAllFichasConfirm()" class="btn btn-danger w-full" disabled>Limpar Todas as Fichas</button>
                        <button id="exportWeeklyDataBtn" onclick="window.fichasApp.generateAndExportWeeklyData()" class="btn btn-secondary w-full" disabled>Exportar para Fechamento</button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        window.fichasApp = {
            fichas: [],
            
            async signInWithGoogle() {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(window.auth, provider);
                } catch (error) {
                    this.showMessage('Erro ao autenticar: ' + error.message, 'error');
                }
            },

            async signOutUser() {
                try {
                    await signOut(window.auth);
                    this.showMessage('Sessão encerrada.', 'info');
                    window.location.reload();
                } catch (error) {
                    this.showMessage('Erro ao sair: ' + error.message, 'error');
                }
            },
            
            // --- ATUALIZAÇÃO NAS FUNÇÕES DO FIRESTORE ---

            async saveFichaToFirestore(fichaData) {
                // O caminho da coleção (window.fichasCollectionRef) já foi atualizado na inicialização
                // Nenhuma mudança é necessária aqui.
                this.toggleLoadingSpinner('add-ficha', true);
                try {
                    const docRef = await window.addDoc(window.fichasCollectionRef, fichaData);
                    return docRef.id;
                } catch (e) {
                    this.showMessage('Erro ao salvar ficha: ' + e.message, 'error');
                    return null;
                } finally {
                    this.toggleLoadingSpinner('add-ficha', false);
                }
            },
            
            async removeFichaFromFirestore(fichaId) {
                try {
                    // CAMINHO ATUALIZADO
                    await window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/public/data/fichas`, fichaId));
                    return true;
                } catch (e) {
                    this.showMessage('Erro ao remover ficha: ' + e.message, 'error');
                    return false;
                }
            },

            async saveWeeklyReportDataToFirestore(data) {
                this.toggleLoadingSpinner('export-weekly', true);
                try {
                    // CAMINHO ATUALIZADO
                    const docRef = window.doc(window.db, `artifacts/${window.appId}/public/data/weeklyReportsAggregated/currentWeek`);
                    await window.setDoc(docRef, data);
                    this.showMessage('Dados exportados para o fechamento!', 'success');
                } catch (e) {
                    this.showMessage('Erro ao exportar dados: ' + e.message, 'error');
                } finally {
                    this.toggleLoadingSpinner('export-weekly', false);
                }
            },
            
            // O resto do objeto fichasApp (lógica de UI, etc.) permanece o mesmo.
            // Para manter o código conciso, o restante do objeto JS não foi repetido aqui,
            // mas ele deve ser mantido no seu arquivo.
            init() { this.enableButtons(); this.loadFichasFromFirestore(); },
            enableButtons() {
                ['addFichaBtn', 'clearAllFichasBtn', 'exportWeeklyDataBtn'].forEach(id => document.getElementById(id).disabled = false);
            },
            disableAuthRequiredButtons() {
                ['addFichaBtn', 'clearAllFichasBtn', 'exportWeeklyDataBtn'].forEach(id => document.getElementById(id).disabled = true);
            },
            showMessage(message, type = 'success') {
                const msgDiv = document.getElementById('app-message');
                msgDiv.textContent = message;
                msgDiv.className = `message message-${type}`;
                setTimeout(() => { msgDiv.className = 'message hidden'; }, 5000);
            },
            toggleLoadingSpinner(type, show) {
                 const spinner = document.getElementById(`${type}-spinner`);
                 const icon = document.getElementById(`${type}-icon`);
                 if(spinner && icon){
                     spinner.classList.toggle('hidden', !show);
                     icon.classList.toggle('hidden', show);
                 }
            },
            async loadFichasFromFirestore() {
                if (!window.fichasCollectionRef) return;
                try {
                    this.fichas = []; 
                    const querySnapshot = await window.getDocs(window.fichasCollectionRef);
                    querySnapshot.forEach((doc) => {
                        this.fichas.push({ id: doc.id, ...doc.data() });
                    });
                    this.renderFichasTable();
                } catch (e) {
                    this.showMessage('Erro ao carregar fichas: ' + e.message, 'error');
                }
            }
            // ... Mantenha o resto do seu objeto 'fichasApp' aqui ...
        };
    </script>
</body>
</html>
