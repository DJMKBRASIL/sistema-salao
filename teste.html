<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Espa√ßo Fran Kokott - Sistema Integrado</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut,
            setPersistence, 
            browserLocalPersistence 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            deleteDoc, 
            collection, 
            query, 
            where, 
            getDocs, 
            addDoc,
            updateDoc, 
            setDoc,
            Timestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURA√á√ÉO ---
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyD7FwQZspQNYZmNlQv8oNglccBXHmduW5w", 
            authDomain: "sistema-do-salao.firebaseapp.com", 
            projectId: "sistema-do-salao",   
            storageBucket: "sistema-do-salao.firebasestorage.app", 
            messagingSenderId: "395887083088", 
            appId: "1:395887083088:web:3a41fd836cc59a976ddb55"
        };
        
        // -----------------------------------------------------------
        // üéöÔ∏è MASTER FADER (SEGURAN√áA)
        // -----------------------------------------------------------
        const ADMIN_EMAILS = [
            "djmkbrasil@gmail.com", 
            // Adicione outros se precisar
        ];
        window.ADMIN_EMAILS = ADMIN_EMAILS;
        // -----------------------------------------------------------

        // Globais
        window.app = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.userEmail = null;

        // Inicializa√ß√£o Firebase
        async function initializeFirebase() {
            try {
                window.app = initializeApp(window.firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);
                
                await setPersistence(window.auth, browserLocalPersistence);

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        window.userEmail = user.email;
                        updateAuthUI(user);
                        checkPermissions(user.email);
                        if(window.appLogic) {
                            window.appLogic.init();
                        } else {
                            setTimeout(() => window.appLogic && window.appLogic.init(), 500);
                        }
                    } else {
                        window.userId = null;
                        window.userEmail = null;
                        updateAuthUI(null);
                        const fechamentoTab = document.getElementById('nav-fechamento');
                        const fluxoTab = document.getElementById('nav-fluxo');
                        if(fechamentoTab) fechamentoTab.classList.add('hidden'); 
                        if(fluxoTab) fluxoTab.classList.add('hidden');
                        
                        if(window.appLogic) window.appLogic.switchTab('agenda'); 
                    }
                });
            } catch (error) {
                console.error("Erro Firebase:", error);
                if(window.appLogic && window.appLogic.showMessage) window.appLogic.showMessage('Erro de conex√£o.', 'error');
            }
        }

        function checkPermissions(email) {
            const isAdmin = ADMIN_EMAILS.includes(email);
            const adminTab = document.getElementById('nav-fechamento');
            const fluxoTab = document.getElementById('nav-fluxo');
            
            if (isAdmin) {
                if(adminTab) adminTab.classList.remove('hidden');
                if(fluxoTab) fluxoTab.classList.remove('hidden');
            } else {
                if(adminTab) adminTab.classList.add('hidden');
                if(fluxoTab) fluxoTab.classList.add('hidden');
                
                if(window.appLogic && (window.appLogic.currentTab === 'fechamento' || window.appLogic.currentTab === 'fluxo')) {
                    window.appLogic.switchTab('agenda');
                }
            }
        }

        function updateAuthUI(user) {
            const container = document.getElementById('auth-status');
            if(!container) return;
            
            if (user) {
                container.innerHTML = `
                    <div class="flex flex-col items-end mr-3">
                        <span class="text-xs font-bold text-gray-700 truncate max-w-[100px]">${user.displayName || 'Usu√°rio'}</span>
                        <span class="text-[10px] text-gray-500 truncate max-w-[100px]">${user.email}</span>
                    </div>
                    <button onclick="signOutUser()" class="text-xs bg-red-100 text-red-600 px-3 py-2 rounded hover:bg-red-200 font-medium transition-colors">Sair</button>
                `;
            } else {
                container.innerHTML = `
                    <button onclick="signInWithGoogle()" class="text-sm bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 font-medium flex items-center transition-colors">
                        <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/></svg>
                        Login
                    </button>
                `;
            }
        }

        window.signInWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try { 
                await signInWithPopup(window.auth, provider);
            } 
            catch (e) { 
                console.error(e);
                let msg = "Erro no login: " + e.message;
                if (e.code === 'auth/popup-blocked') {
                    msg = "O navegador bloqueou a janela de login. Por favor, permita pop-ups para este site.";
                    alert(msg);
                }
                if(window.appLogic && window.appLogic.showMessage) window.appLogic.showMessage(msg, 'error'); 
            }
        };

        window.signOutUser = async () => {
            await signOut(window.auth);
            window.location.reload();
        };

        document.addEventListener('DOMContentLoaded', initializeFirebase);

        window.collection = collection;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.setDoc = setDoc;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.Timestamp = Timestamp;
    </script>

    <style>
        :root { --primary: #6366f1; --secondary: #8b5cf6; --success: #10b981; --danger: #ef4444; }
        * { box-sizing: border-box; }
        
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; padding: 1rem; -webkit-tap-highlight-color: transparent; }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; min-height: 44px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(99, 102, 241, 0.4); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: #4b5563; color: white; }
        .btn-edit { background: #f59e0b; color: white; }
        
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid rgba(0,0,0,0.05); }
        
        .nav-pill { padding: 0.75rem 1.2rem; border-radius: 999px; cursor: pointer; font-weight: 600; color: #6b7280; transition: all 0.2s; border: 1px solid transparent; font-size: 0.9rem; }
        .nav-pill:hover { color: var(--primary); background: #eff6ff; }
        .nav-pill.active { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.4); border-color: transparent; }
        
        .hidden { display: none !important; }
        .loading-spinner { border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .input-field { 
            width: 100%; max-width: 100%; min-width: 0; box-sizing: border-box;
            border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.6rem 0.75rem; 
            transition: all 0.2s; font-size: 16px; -webkit-appearance: none;
        }
        .input-field:focus { outline: none; border-color: var(--primary); ring: 2px; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        input[type="date"], input[type="time"] { -webkit-appearance: none; display: block; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 50; justify-content: center; align-items: center; padding: 1rem; }
        .modal.open { display: flex; }

        .status-agendado { background-color: #fef3c7; color: #92400e; }
        .status-confirmado { background-color: #d1fae5; color: #065f46; }
        .status-concluido { background-color: #e0e7ff; color: #3730a3; }
        .status-cancelado { background-color: #fee2e2; color: #991b1b; opacity: 0.7; }

        @media (max-width: 640px) {
            .mobile-hide-header { display: none; }
            .mobile-card-row { display: block; border-bottom: 1px solid #e5e7eb; padding: 1rem; }
            .mobile-card-row td { display: block; padding: 2px 0; border: none; text-align: left; }
            .mobile-card-row td:last-child { margin-top: 0.5rem; }
        }
    </style>
</head>
<body>

    <div class="max-w-6xl mx-auto pb-20">
        
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 pt-2">
            <div class="text-center md:text-left">
                <h1 class="text-2xl font-bold text-gray-800 tracking-tight">Espa√ßo Fran Kokott</h1>
                <p class="text-xs text-gray-500 font-medium uppercase tracking-wide">Sistema de Gest√£o Integrado</p>
            </div>
            
            <div class="bg-white p-1 rounded-full shadow-sm border border-gray-100 flex overflow-x-auto max-w-full">
                <div onclick="window.appLogic.switchTab('agenda')" id="nav-agenda" class="nav-pill active flex items-center whitespace-nowrap">
                    <span class="mr-2">üìÖ</span> Agenda
                </div>
                <div onclick="window.appLogic.switchTab('fichas')" id="nav-fichas" class="nav-pill flex items-center whitespace-nowrap">
                    <span class="mr-2">üìù</span> Fichas
                </div>
                <div onclick="window.appLogic.switchTab('clientes')" id="nav-clientes" class="nav-pill flex items-center whitespace-nowrap">
                    <span class="mr-2">üë•</span> Clientes
                </div>
                <div onclick="window.appLogic.switchTab('estoque')" id="nav-estoque" class="nav-pill flex items-center whitespace-nowrap">
                    <span class="mr-2">üì¶</span> Estoque
                </div>
                <!-- Aba Restrita -->
                <div onclick="window.appLogic.switchTab('fluxo')" id="nav-fluxo" class="nav-pill hidden flex items-center whitespace-nowrap">
                    <span class="mr-2">üìä</span> Fluxo
                </div>
                <div onclick="window.appLogic.switchTab('fechamento')" id="nav-fechamento" class="nav-pill hidden flex items-center whitespace-nowrap">
                    <span class="mr-2">üí∞</span> Fechamento
                </div>
            </div>

            <div id="auth-status" class="bg-white px-3 py-2 rounded-xl shadow-sm border border-gray-100 flex items-center min-h-[50px]">
                <!-- Auth inject -->
            </div>
        </div>

        <!-- Toast -->
        <div id="toast" class="hidden fixed top-6 right-6 left-6 md:left-auto bg-gray-800 text-white px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center transform transition-all justify-center md:justify-start">
            <span id="toast-msg">Mensagem</span>
        </div>

        <!-- TAB 0: AGENDA -->
        <div id="tab-agenda" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Coluna Esquerda: Agendar + Aniversariantes -->
                <div class="lg:col-span-4 space-y-6">
                    <div id="birthdays-card" class="card border-t-4 border-purple-500 p-4 sm:p-6 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-gray-800">üéâ Aniversariantes</h2>
                            <div class="text-xs font-semibold bg-purple-50 text-purple-600 px-2 py-1 rounded">Hoje</div>
                        </div>
                        <ul id="birthdays-list" class="space-y-2"></ul>
                    </div>

                    <div class="card sticky top-6 border-t-4 border-yellow-500 p-4 sm:p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-lg font-bold text-gray-800">Novo Agendamento</h2>
                            <div class="text-xs font-semibold bg-yellow-50 text-yellow-600 px-2 py-1 rounded">Agenda</div>
                        </div>
                        <div class="space-y-4">
                            <div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Dia</label><input type="date" id="agenda-date-input" class="input-field bg-gray-50"></div>
                            <div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Hora</label><input type="time" id="agenda-time-input" class="input-field bg-gray-50"></div>
                            <div class="grid grid-cols-1 gap-4">
                                <div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Profissional</label><input type="text" id="agenda-profissional" list="profissionais-list" placeholder="Quem vai atender?" class="input-field" autocomplete="off"></div>
                                <div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Cliente</label><input type="text" id="agenda-cliente" list="clientes-list" placeholder="Nome da Cliente" class="input-field" autocomplete="off"></div>
                            </div>
                            <div class="border-t border-gray-100 my-4 pt-4">
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Servi√ßos</label>
                                <div id="agenda-items-container" class="space-y-2 mb-3"></div>
                                <div class="flex gap-3 text-sm"><button onclick="window.appLogic.addAgendaItem('servico')" class="flex-1 py-2 border border-dashed border-yellow-500 text-yellow-600 rounded hover:bg-yellow-50 font-medium transition-colors">+ Adicionar Servi√ßo</button></div>
                            </div>
                            <div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Observa√ß√µes</label><textarea id="agenda-obs" class="input-field bg-gray-50 text-sm h-20" placeholder="Ex: Cliente pediu pra confirmar antes..."></textarea></div>
                            <div class="flex gap-2">
                                <button onclick="window.appLogic.cancelAgendaEdit()" id="btn-cancel-agenda" class="btn bg-gray-200 text-gray-700 w-1/3 hidden">Cancelar</button>
                                <button onclick="window.appLogic.saveAgenda()" id="btn-save-agenda" class="btn btn-primary w-full py-4 shadow-lg active:scale-95 text-base bg-gradient-to-r from-yellow-500 to-orange-500 border-none">Agendar Hor√°rio</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Coluna Direita: Lista Agenda -->
                <div class="lg:col-span-8">
                    <div class="card h-full p-4 sm:p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                            <h2 class="text-lg font-bold text-gray-800">Agenda do Dia</h2>
                            <div class="flex gap-2 w-full sm:w-auto">
                                <input type="date" id="agenda-filter-date" class="input-field py-1 text-sm w-full sm:w-auto" onchange="window.appLogic.loadAgenda()">
                                <button onclick="window.appLogic.loadAgenda()" class="text-xs bg-gray-100 text-gray-600 px-3 py-2 rounded hover:bg-gray-200">‚Üª</button>
                            </div>
                        </div>
                        <div id="agenda-list" class="space-y-3"></div>
                        <div id="agenda-empty" class="text-center py-12 text-gray-400 hidden">Nenhum agendamento para este dia.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 1: FICHAS -->
        <div id="tab-fichas" class="tab-content">
             <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-4">
                    <div class="card sticky top-6 border-t-4 border-indigo-500 p-4 sm:p-6">
                        <div class="flex justify-between items-center mb-6"><h2 class="text-lg font-bold text-gray-800">Nova Ficha</h2><div class="text-xs font-semibold bg-indigo-50 text-indigo-600 px-2 py-1 rounded">Dia a Dia</div></div>
                        <div class="space-y-4">
                            <div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Data</label><input type="date" id="ficha-date" class="input-field bg-gray-50"></div>
                            <div class="grid grid-cols-1 gap-4">
                                <div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Profissional</label><input type="text" id="ficha-profissional" list="profissionais-list" placeholder="Quem atendeu?" class="input-field" autocomplete="off"></div>
                                <div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Cliente</label><input type="text" id="ficha-cliente" list="clientes-list" placeholder="Nome da Cliente" class="input-field" autocomplete="off"></div>
                            </div>
                            <div class="border-t border-gray-100 my-4 pt-4">
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Itens</label>
                                <div id="ficha-items-container" class="space-y-3 mb-4"></div>
                                <div class="flex gap-3 text-sm"><button onclick="window.appLogic.addFichaItem('servico')" class="flex-1 py-3 border border-dashed border-indigo-300 text-indigo-600 rounded hover:bg-indigo-50 font-medium">+ Servi√ßo</button><button onclick="window.appLogic.addFichaItem('produto')" class="flex-1 py-3 border border-dashed border-green-300 text-green-600 rounded hover:bg-green-50 font-medium">+ Produto</button></div>
                            </div>
                            <div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Observa√ß√µes da Ficha</label><textarea id="ficha-obs" class="input-field bg-gray-50 text-sm h-20" placeholder="Ex: Pagamento pendente, Vale, Pix direto..."></textarea></div>
                            <div class="bg-gray-50 p-4 rounded-lg flex justify-between items-center border border-gray-100 shadow-inner"><span class="text-sm font-medium text-gray-500">Total</span><div class="text-xl font-bold text-gray-800" id="ficha-total-display">R$ 0,00</div></div>
                            <div class="flex gap-2">
                                <button onclick="window.appLogic.cancelFichaEdit()" id="btn-cancel-ficha" class="btn bg-gray-200 text-gray-700 w-1/3 hidden">Cancelar</button>
                                <button onclick="window.appLogic.saveFicha()" id="btn-save-ficha" class="btn btn-primary flex-grow py-4 shadow-lg active:scale-95 text-base">Salvar Ficha</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-8">
                    <div class="card h-full p-4 sm:p-6">
                        <div class="flex justify-between items-center mb-6"><h2 class="text-lg font-bold text-gray-800">Meus Registros Recentes</h2><button onclick="window.appLogic.loadFichas()" class="text-xs bg-gray-100 text-gray-600 px-3 py-2 rounded hover:bg-gray-200">‚Üª Atualizar</button></div>
                        <div class="overflow-hidden rounded-lg border border-gray-100">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 text-gray-500 uppercase font-semibold text-xs mobile-hide-header"><tr><th class="p-4">Data</th><th class="p-4">Profissional</th><th class="p-4">Cliente/Obs</th><th class="p-4">Itens</th><th class="p-4 text-right">Valor</th><th class="p-4 text-center">A√ß√£o</th></tr></thead>
                                <tbody id="fichas-history-body" class="bg-white"></tbody>
                            </table>
                        </div>
                        <p class="text-xs text-gray-400 mt-4 text-center">Mostrando todo o hist√≥rico.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 3: CLIENTES -->
        <div id="tab-clientes" class="tab-content">
             <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-4">
                    <div class="card sticky top-6 border-t-4 border-pink-500 p-4 sm:p-6">
                        <div class="flex justify-between items-center mb-6"><h2 class="text-lg font-bold text-gray-800">Novo Cliente</h2><div class="text-xs font-semibold bg-pink-50 text-pink-600 px-2 py-1 rounded">Cadastro</div></div>
                        <div class="space-y-4">
                            <div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Nome Completo</label><input type="text" id="client-name" class="input-field" placeholder="Nome da cliente"></div>
                            <div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">WhatsApp</label><input type="tel" id="client-phone" class="input-field" placeholder="(41) 99999-9999"></div>
                            <div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Data Nascimento</label><input type="date" id="client-birth" class="input-field"></div>
                            <div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Observa√ß√µes T√©cnicas</label><textarea id="client-obs" class="input-field bg-gray-50 text-sm h-20" placeholder="Tintura, alergias, prefer√™ncias..."></textarea></div>
                            <div class="flex gap-2"><button onclick="window.appLogic.cancelClientEdit()" id="btn-cancel-client" class="btn bg-gray-200 text-gray-700 w-1/3 hidden">Cancelar</button><button onclick="window.appLogic.saveClient()" id="btn-save-client" class="btn btn-primary flex-grow py-3.5 shadow-lg bg-gradient-to-r from-pink-500 to-rose-500 border-none">Cadastrar Cliente</button></div>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-8">
                    <div class="card h-full p-4 sm:p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                            <h2 class="text-lg font-bold text-gray-800">Base de Clientes</h2>
                            <div class="relative w-full sm:w-64"><input type="text" id="client-search" class="input-field pl-8 py-2" placeholder="Buscar cliente..." oninput="window.appLogic.filterClients(this.value)"><svg class="w-4 h-4 absolute left-2.5 top-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div>
                        </div>
                        <div class="overflow-hidden rounded-lg border border-gray-100">
                            <table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-500 uppercase font-semibold text-xs"><tr><th class="p-4">Nome</th><th class="p-4 hidden sm:table-cell">Contato</th><th class="p-4 hidden sm:table-cell">Obs</th><th class="p-4 text-center">A√ß√µes</th></tr></thead><tbody id="clients-list-body" class="bg-white divide-y divide-gray-100"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: ESTOQUE -->
        <div id="tab-estoque" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-4">
                    <div class="card sticky top-6 border-t-4 border-blue-500 p-4 sm:p-6">
                        <div class="flex justify-between items-center mb-6"><h2 class="text-lg font-bold text-gray-800">Novo Produto</h2><div class="text-xs font-semibold bg-blue-50 text-blue-600 px-2 py-1 rounded">Estoque</div></div>
                        <div class="space-y-4">
                            <div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Nome do Produto</label><input type="text" id="stock-name" class="input-field" placeholder="Ex: Shampoo L'Or√©al"></div>
                            <div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Categoria</label><select id="stock-category" class="input-field"><option value="venda">Venda (Cliente)</option><option value="uso_interno">Uso Interno (Insumo)</option><option value="bebidas">Bebidas/Bar</option><option value="outros">Outros</option></select></div>
                            <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Qtd Atual</label><input type="number" id="stock-qty" class="input-field" placeholder="0"></div><div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">M√≠nimo</label><input type="number" id="stock-min" class="input-field" placeholder="2"></div></div>
                            <button onclick="window.appLogic.saveStockItem()" id="btn-save-stock" class="btn btn-primary w-full py-3.5 shadow-lg bg-gradient-to-r from-blue-500 to-cyan-500 border-none">Adicionar ao Estoque</button>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-8">
                    <div class="card h-full p-4 sm:p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                            <h2 class="text-lg font-bold text-gray-800">Controle de Estoque</h2>
                            <div class="flex gap-2"><select id="stock-filter-cat" class="input-field text-sm py-1" onchange="window.appLogic.loadStock()"><option value="all">Todas as Categorias</option><option value="venda">Venda</option><option value="uso_interno">Uso Interno</option><option value="bebidas">Bebidas</option></select><button onclick="window.appLogic.loadStock()" class="text-xs bg-gray-100 text-gray-600 px-3 py-2 rounded hover:bg-gray-200">‚Üª</button></div>
                        </div>
                        <div class="overflow-hidden rounded-lg border border-gray-100"><table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-500 uppercase font-semibold text-xs"><tr><th class="p-4">Produto</th><th class="p-4 text-center">Qtd</th><th class="p-4 text-center">A√ß√µes</th></tr></thead><tbody id="stock-list-body" class="bg-white divide-y divide-gray-100"></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 5: FLUXO DE CAIXA -->
        <div id="tab-fluxo" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Painel de Controle -->
                <div class="lg:col-span-12">
                    <div class="card border-t-4 border-gray-800 p-4 sm:p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-gray-800">Fluxo de Caixa</h2>
                            <input type="month" id="fluxo-month" class="input-field w-auto" onchange="window.appLogic.loadFluxo()">
                        </div>
                        
                        <!-- Cards Resumo -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                                <span class="text-xs font-bold text-green-600 uppercase tracking-wider">Entradas</span>
                                <div class="text-2xl font-bold text-green-700" id="fluxo-in">R$ 0,00</div>
                            </div>
                            <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                                <span class="text-xs font-bold text-red-600 uppercase tracking-wider">Sa√≠das</span>
                                <div class="text-2xl font-bold text-red-700" id="fluxo-out">R$ 0,00</div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Saldo</span>
                                <div class="text-2xl font-bold text-gray-800" id="fluxo-balance">R$ 0,00</div>
                            </div>
                        </div>

                        <!-- Bot√£o Adicionar Despesa -->
                        <div class="flex justify-end mb-4">
                            <button onclick="window.appLogic.openExpenseModal()" class="btn btn-primary bg-gray-800 text-sm shadow-sm">
                                ‚ûï Novo Lan√ßamento
                            </button>
                        </div>

                        <!-- Lista de Transa√ß√µes -->
                        <div class="overflow-hidden rounded-lg border border-gray-200">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                                    <tr>
                                        <th class="p-3">Data</th>
                                        <th class="p-3">Descri√ß√£o</th>
                                        <th class="p-3">Categoria</th>
                                        <th class="p-3 text-right">Valor</th>
                                        <th class="p-3 text-center">#</th>
                                    </tr>
                                </thead>
                                <tbody id="fluxo-list-body" class="bg-white divide-y divide-gray-100">
                                    <!-- Lista de fluxo -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: FECHAMENTO (Admin) -->
        <div id="tab-fechamento" class="tab-content">
             <div class="card border-t-4 border-green-500 p-4 sm:p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div><h2 class="text-lg font-bold text-gray-800 flex items-center">Fechamento Financeiro<span class="ml-2 px-2 py-0.5 rounded text-[10px] bg-red-100 text-red-600 uppercase tracking-wider font-bold">Admin</span></h2><p class="text-sm text-gray-500 mt-1">Busca dados de TODOS os usu√°rios.</p></div>
                </div>
                <div class="bg-gray-50 p-4 sm:p-6 rounded-xl border border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">In√≠cio</label><input type="date" id="closing-start-date" class="input-field bg-white"></div>
                        <div><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Fim</label><input type="date" id="closing-end-date" class="input-field bg-white"></div>
                        <div class="flex gap-2 lg:col-span-2"><button onclick="window.appLogic.generateClosingReport()" id="btn-generate-report" class="btn btn-success flex-1 h-[46px] shadow-sm text-xs sm:text-sm">Processar</button><button onclick="window.appLogic.openSavedClosingsModal()" id="btn-open-saved" class="btn btn-secondary flex-1 h-[46px] shadow-sm text-xs sm:text-sm">üìÇ Abrir Salvos</button><button onclick="window.appLogic.saveWeeklyClosing()" id="btn-save-cloud" class="btn btn-primary flex-1 h-[46px] shadow-sm text-xs sm:text-sm" disabled>‚òÅÔ∏è Salvar/Atualizar</button><button onclick="window.appLogic.exportLocalBackup()" id="btn-local-backup" class="btn bg-gray-300 text-gray-700 flex-none h-[46px] shadow-sm" title="Backup JSON Local" disabled>üíæ</button></div>
                    </div>
                </div>
            </div>
            <div id="closing-results" class="hidden animate-fade-in space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col"><span class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Total Bruto</span><span class="text-3xl font-bold text-gray-800" id="total-gross">R$ 0,00</span></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col"><span class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Taxas Cart√£o</span><span class="text-3xl font-bold text-red-500" id="total-fees">R$ 0,00</span></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col relative overflow-hidden"><span class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">L√≠quido Sal√£o</span><span class="text-3xl font-bold text-green-600" id="total-net">R$ 0,00</span></div>
                </div>
                <div class="flex justify-end"><button onclick="window.appLogic.exportClosingPDF()" id="btn-export-pdf" class="btn btn-primary bg-gray-800 border-gray-800 text-sm shadow-md" disabled>üìÑ Baixar PDF Geral da Semana</button></div>
                <div><h3 class="text-lg font-bold text-gray-800 mb-4 px-1">Comiss√µes & Observa√ß√µes</h3><div id="collaborators-report-container" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div></div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6"><h3 class="text-lg font-bold text-gray-800 mb-4">Produtos Vendidos</h3><div class="overflow-x-auto"><table class="w-full text-sm"><thead class="bg-gray-50 text-gray-500 text-xs uppercase"><tr><th class="p-3 text-left">Item</th><th class="p-3 text-left">Vend.</th><th class="p-3 text-right">Valor</th></tr></thead><tbody id="products-report-list" class="divide-y divide-gray-100"></tbody></table></div><div class="mt-4 pt-4 border-t border-gray-100 text-right font-bold text-gray-800" id="products-report-total">R$ 0,00</div></div>
            </div>
            <div id="closing-empty-state" class="text-center py-16"><div class="bg-gray-100 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4"><svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div><h3 class="text-lg font-medium text-gray-900">Nenhum dado processado</h3><p class="text-gray-500 mt-1">Selecione as datas para buscar fichas de toda a equipe.</p></div>
            <div class="mt-12 border-t pt-8"><h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">üìÇ Relat√≥rios Mensais (Contabilidade)</h2><div class="bg-white p-6 rounded-xl border border-gray-200 flex flex-col md:flex-row gap-4 items-end"><div class="flex-grow"><label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">M√™s de Refer√™ncia</label><input type="month" id="monthly-report-date" class="input-field bg-white"></div><button onclick="window.appLogic.generateMonthlyReport()" id="btn-monthly-report" class="btn btn-primary h-[46px] shadow-sm">Gerar Relat√≥rio Completo (PDF)</button></div><p class="text-xs text-gray-500 mt-2 ml-1">L√™ todos os fechamentos semanais salvos na nuvem do m√™s selecionado.</p></div>
        </div>
    </div>

    <!-- Datalist de Clientes -->
    <datalist id="clientes-list"></datalist>

    <!-- Modals -->
    <div id="confirm-modal" class="modal">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 shadow-2xl">
            <h3 class="text-lg font-bold text-gray-900 mb-2">Excluir?</h3>
            <p class="text-gray-600 mb-6 text-sm">Tem certeza que deseja apagar este registro?</p>
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('confirm-modal').classList.remove('open')" class="btn bg-gray-100 text-gray-700">Cancelar</button>
                <button id="confirm-modal-btn" class="btn btn-danger">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal Lan√ßar Despesa (Fluxo) -->
    <div id="expense-modal" class="modal">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 shadow-2xl">
            <h3 class="text-lg font-bold text-gray-900 mb-4" id="expense-modal-title">Novo Lan√ßamento</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 mb-1">Tipo</label>
                    <select id="expense-type" class="input-field font-bold">
                        <option value="out" selected>üî¥ Sa√≠da (Despesa)</option>
                        <option value="in">üü¢ Entrada (Receita)</option>
                    </select>
                </div>
                <div><label class="block text-xs font-semibold text-gray-500 mb-1">Data</label><input type="date" id="expense-date" class="input-field"></div>
                <div><label class="block text-xs font-semibold text-gray-500 mb-1">Descri√ß√£o</label><input type="text" id="expense-desc" class="input-field" placeholder="Ex: Conta de Luz / Venda Avulsa"></div>
                <div><label class="block text-xs font-semibold text-gray-500 mb-1">Categoria</label>
                    <select id="expense-cat" class="input-field">
                        <option value="insumos">Insumos/Produtos</option>
                        <option value="pessoal">Pessoal/Comiss√µes</option>
                        <option value="fixas">Contas Fixas</option>
                        <option value="marketing">Marketing</option>
                        <option value="venda_extra">Venda Extra</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div><label class="block text-xs font-semibold text-gray-500 mb-1">Valor (R$)</label><input type="number" id="expense-val" class="input-field" step="0.01"></div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="window.appLogic.cancelEditExpense()" class="btn bg-gray-100 text-gray-700">Cancelar</button>
                <button onclick="window.appLogic.saveExpense()" class="btn btn-primary bg-gray-800" id="btn-save-expense">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Anexar Comprovante -->
    <div id="receipt-modal" class="modal">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Gerar PDF Individual</h3>
            
            <div id="receipt-confirmation-content" class="hidden mb-4">
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 rounded text-sm text-yellow-700">
                    <p class="font-bold">Confirme os valores antes de gerar:</p>
                    <div class="mt-2 grid grid-cols-2 gap-2">
                        <span>Total Servi√ßos:</span> <span class="font-mono font-bold" id="confirm-total">R$ 0,00</span>
                        <span>Reten√ß√£o (30%):</span> <span class="font-mono text-red-600" id="confirm-share">- R$ 0,00</span>
                        <span>Sinais/Vales:</span> <span class="font-mono text-red-600" id="confirm-advances">- R$ 0,00</span>
                    </div>
                    <div class="mt-3 border-t border-yellow-200 pt-2">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-lg">A Pagar:</span>
                            <span class="font-bold text-xl text-green-700" id="confirm-pay">R$ 0,00</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">Ajuste Manual (Opcional)</label>
                    <div class="flex gap-2">
                        <input type="number" id="manual-adjustment" class="input-field text-sm w-1/2" placeholder="Ex: -50.00 ou 20.00">
                        <button onclick="window.appLogic.recalcConfirmation()" class="btn bg-gray-200 text-xs px-3">Aplicar</button>
                    </div>
                    <input type="text" id="manual-adjustment-note" class="input-field text-sm mt-2 w-full" placeholder="Motivo do ajuste (Ex: Vale transporte)">
                    <p class="text-[10px] text-gray-400 mt-1">Use valores negativos (-) para descontos extras.</p>
                </div>

                <div class="mt-4 flex items-center p-3 bg-gray-50 rounded border border-gray-200">
                    <input type="checkbox" id="register-expense-check" class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                    <label for="register-expense-check" class="ml-2 text-sm font-medium text-gray-700">‚úÖ Lan√ßar sa√≠da no Fluxo de Caixa</label>
                </div>
            </div>

            <p class="text-gray-600 mb-4 text-sm">Deseja anexar o comprovante de pagamento ao PDF da <span id="receipt-collab-name" class="font-bold"></span>?</p>
            
            <div class="flex flex-col gap-3">
                <button onclick="window.appLogic.generateCollaboratorPDF(true)" class="btn btn-primary w-full py-3 flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    Sim, anexar (Abrir Arquivos)
                </button>
                <button onclick="window.appLogic.generateCollaboratorPDF(false)" class="btn bg-gray-100 text-gray-700 w-full py-3 hover:bg-gray-200">
                    N√£o, gerar sem comprovante
                </button>
                <button onclick="document.getElementById('receipt-modal').classList.remove('open')" class="btn bg-white border border-gray-300 text-gray-500 w-full py-2 hover:bg-gray-50 text-xs mt-2">
                    Cancelar
                </button>
            </div>
            <button onclick="document.getElementById('receipt-modal').classList.remove('open')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
    </div>

    <!-- Modal Lista de Fechamentos Salvos -->
    <div id="saved-closings-modal" class="modal">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 shadow-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Fechamentos Salvos</h3>
                <button onclick="document.getElementById('saved-closings-modal').classList.remove('open')" class="text-gray-400 hover:text-gray-600 p-2">‚úï</button>
            </div>
            <div class="overflow-y-auto flex-grow">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase sticky top-0">
                        <tr>
                            <th class="p-3 text-left">Per√≠odo</th>
                            <th class="p-3 text-right">Total Bruto</th>
                            <th class="p-3 text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="saved-closings-list" class="divide-y divide-gray-100"></tbody>
                </table>
                <div id="saved-loading" class="text-center py-8 hidden"><span class="loading-spinner border-gray-400"></span></div>
                <div id="saved-empty" class="text-center py-8 text-gray-400 hidden">Nenhum fechamento salvo encontrado.</div>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        window.appLogic = {
            currentTab: 'agenda', 
            fichas: [],
            clients: [], 
            stock: [], 
            reportData: null,
            targetCollabForPDF: null, 
            editingClientId: null, 
            editingAgendaId: null, 
            editingExpenseId: null, // Nova vari√°vel para controle de edi√ß√£o do fluxo
            editingFichaId: null, // Nova vari√°vel para controle de edi√ß√£o de fichas
            cardRates: { 'pix': 0, 'dinheiro': 0, 'pendente': 0, 'debito': 0.0137, 'credito_1x': 0.0315, 'credito_2x': 0.0539, 'credito_3x': 0.0612 },

            init() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const today = `${year}-${month}-${day}`;

                const els = ['ficha-date', 'closing-end-date', 'agenda-date-input', 'agenda-filter-date', 'expense-date'];
                els.forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = today; });
                
                const d = new Date(); d.setDate(d.getDate() - d.getDay()); 
                const sYear = d.getFullYear();
                const sMonth = String(d.getMonth() + 1).padStart(2, '0');
                const sDay = String(d.getDate()).padStart(2, '0');
                const startOfWeek = `${sYear}-${sMonth}-${sDay}`;

                if(document.getElementById('closing-start-date')) document.getElementById('closing-start-date').value = startOfWeek;

                const m = new Date().toISOString().slice(0, 7);
                if(document.getElementById('monthly-report-date')) document.getElementById('monthly-report-date').value = m;
                if(document.getElementById('fluxo-month')) document.getElementById('fluxo-month').value = m;

                this.cleanupOldAgenda(today);
                this.checkBirthdays(); 
                this.addFichaItem('servico');
                this.addAgendaItem('servico'); 
                this.loadFichas();
                this.loadAgenda(); 
                this.loadClients();
                this.loadStock(); 
                this.loadFluxo();
                this.enableFeatures();
            },

            // --- FLUXO DE CAIXA ---
            openExpenseModal() {
                this.editingExpenseId = null;
                document.getElementById('expense-modal-title').textContent = "Novo Lan√ßamento";
                document.getElementById('btn-save-expense').textContent = "Salvar";
                document.getElementById('expense-desc').value = '';
                document.getElementById('expense-val').value = '';
                document.getElementById('expense-type').value = 'out'; // Default
                document.getElementById('expense-cat').value = 'insumos';
                
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                document.getElementById('expense-date').value = today;

                document.getElementById('expense-modal').classList.add('open');
            },

            cancelEditExpense() {
                this.editingExpenseId = null;
                document.getElementById('expense-modal').classList.remove('open');
            },

            async saveExpense() {
                if(!window.userId) return this.showMessage("Fa√ßa login", "error");
                const date = document.getElementById('expense-date').value;
                const desc = document.getElementById('expense-desc').value.trim();
                const category = document.getElementById('expense-cat').value;
                const type = document.getElementById('expense-type').value; // 'in' ou 'out'
                const value = parseFloat(document.getElementById('expense-val').value) || 0;

                if(!date || !desc || value <= 0) return this.showMessage("Preencha todos os campos", "error");

                try {
                    const collectionPath = `artifacts/${window.appId}/public/data/expenses`;
                    
                    if (this.editingExpenseId) {
                        // Edi√ß√£o
                        await window.updateDoc(window.doc(window.db, collectionPath, this.editingExpenseId), {
                            date, desc, category, value, type
                        });
                        this.showMessage("Lan√ßamento atualizado!", "success");
                    } else {
                        // Cria√ß√£o
                        await window.addDoc(window.collection(window.db, collectionPath), {
                            date, desc, category, value, type,
                            createdAt: window.Timestamp.now()
                        });
                        this.showMessage("Lan√ßamento salvo!", "success");
                    }
                    
                    this.cancelEditExpense();
                    this.loadFluxo();
                } catch(e) { this.showMessage("Erro ao salvar", "error"); }
            },

            startEditExpense(transaction) {
                if(transaction.isSystem) {
                    alert("Este item foi gerado automaticamente por uma Ficha. Edite a Ficha original para corrigir.");
                    return;
                }

                this.editingExpenseId = transaction.id;
                document.getElementById('expense-modal-title').textContent = "Editar Lan√ßamento";
                document.getElementById('btn-save-expense').textContent = "Atualizar";
                
                document.getElementById('expense-date').value = transaction.date;
                document.getElementById('expense-desc').value = transaction.desc;
                document.getElementById('expense-cat').value = transaction.category;
                document.getElementById('expense-val').value = transaction.value;
                document.getElementById('expense-type').value = transaction.type;

                document.getElementById('expense-modal').classList.add('open');
            },

            async deleteExpense(id) {
                if(!confirm("Excluir este lan√ßamento?")) return;
                try {
                    await window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/public/data/expenses`, id));
                    this.showMessage("Lan√ßamento removido.");
                    this.loadFluxo();
                } catch(e) { this.showMessage("Erro ao remover", "error"); }
            },

            async loadFluxo() {
                if(!window.userId || !window.db) return;
                const monthInput = document.getElementById('fluxo-month').value; 
                if(!monthInput) return;

                const list = document.getElementById('fluxo-list-body');
                list.innerHTML = '<tr><td colspan="5" class="text-center py-4"><span class="loading-spinner border-gray-400"></span></td></tr>';

                try {
                    const startOfMonth = `${monthInput}-01`;
                    const endOfMonth = `${monthInput}-31`;
                    
                    const qFichas = window.query(window.collection(window.db, `artifacts/${window.appId}/public/data/fichas`), 
                        window.where('date', '>=', startOfMonth), window.where('date', '<=', endOfMonth));
                    
                    const qExpenses = window.query(window.collection(window.db, `artifacts/${window.appId}/public/data/expenses`), 
                        window.where('date', '>=', startOfMonth), window.where('date', '<=', endOfMonth));

                    const [snapFichas, snapExpenses] = await Promise.all([window.getDocs(qFichas), window.getDocs(qExpenses)]);

                    let transactions = [];
                    let totalIn = 0;
                    let totalOut = 0;

                    // Processa Fichas e SEPARA Produtos de Servi√ßos
                    snapFichas.forEach(doc => {
                        const d = doc.data();
                        
                        let serviceTotal = 0;
                        
                        if(d.items && Array.isArray(d.items)) {
                            d.items.forEach(item => {
                                if(item.type === 'produto') {
                                    // Adiciona produto como linha individual de entrada
                                    totalIn += item.value;
                                    transactions.push({
                                        id: doc.id,
                                        date: d.date,
                                        desc: `Venda: ${item.name} (${d.clientName})`,
                                        category: 'venda_extra',
                                        value: item.value,
                                        type: 'in',
                                        isSystem: true // Veio de ficha
                                    });
                                } else {
                                    // Soma servi√ßos
                                    serviceTotal += item.value;
                                }
                            });
                        } else {
                            // Fallback para fichas antigas sem array de itens estruturado
                            serviceTotal = d.total;
                        }

                        if (serviceTotal > 0) {
                            totalIn += serviceTotal;
                            transactions.push({
                                id: doc.id,
                                date: d.date,
                                desc: `Atendimento: ${d.clientName}`,
                                category: 'Servi√ßos',
                                value: serviceTotal,
                                type: 'in',
                                isSystem: true
                            });
                        }
                    });

                    // Processa Lan√ßamentos Manuais
                    snapExpenses.forEach(doc => {
                        const d = doc.data();
                        // Verifica o tipo (se n√£o tiver 'type', assume 'out' por compatibilidade antiga)
                        const type = d.type || 'out';
                        
                        if (type === 'in') {
                            totalIn += d.value;
                        } else {
                            totalOut += d.value;
                        }

                        transactions.push({
                            id: doc.id,
                            date: d.date,
                            desc: d.desc,
                            category: d.category,
                            value: d.value,
                            type: type,
                            isSystem: false
                        });
                    });

                    transactions.sort((a,b) => new Date(b.date) - new Date(a.date));

                    document.getElementById('fluxo-in').textContent = `R$ ${totalIn.toFixed(2)}`;
                    document.getElementById('fluxo-out').textContent = `R$ ${totalOut.toFixed(2)}`;
                    const bal = totalIn - totalOut;
                    const balEl = document.getElementById('fluxo-balance');
                    balEl.textContent = `R$ ${bal.toFixed(2)}`;
                    balEl.className = `text-2xl font-bold ${bal >= 0 ? 'text-blue-600' : 'text-red-600'}`;

                    list.innerHTML = '';
                    const catMap = { 'insumos': 'Insumos', 'pessoal': 'Pessoal', 'fixas': 'Fixas', 'marketing': 'Mkt', 'venda_extra': 'Venda', 'outros': 'Outros' };

                    transactions.forEach(t => {
                        const colorClass = t.type === 'in' ? 'text-green-600' : 'text-red-600';
                        const sign = t.type === 'in' ? '+' : '-';
                        const dateFmt = t.date.split('-').reverse().slice(0,2).join('/');
                        
                        const transactionStr = encodeURIComponent(JSON.stringify(t));

                        // Bot√£o de deletar (apenas manuais)
                        const delBtn = t.isSystem ? '' : 
                            `<button onclick="window.appLogic.deleteExpense('${t.id}')" class="text-gray-400 hover:text-red-500 p-1" title="Excluir">‚úï</button>`;
                        
                        // Bot√£o de editar (apenas manuais, ou alerta para sistema)
                        const editBtn = t.isSystem ? '<span class="text-xs text-gray-300 mr-2">Auto</span>' : 
                            `<button onclick="window.appLogic.startEditExpense(JSON.parse(decodeURIComponent('${transactionStr}')))" class="text-gray-400 hover:text-blue-500 p-1 mr-1" title="Editar">‚úèÔ∏è</button>`;

                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-gray-50 border-b border-gray-100";
                        tr.innerHTML = `
                            <td class="p-3 font-mono text-gray-500">${dateFmt}</td>
                            <td class="p-3 font-medium text-gray-800">${t.desc}</td>
                            <td class="p-3 text-xs text-gray-500 uppercase">${catMap[t.category] || t.category}</td>
                            <td class="p-3 text-right font-bold ${colorClass}">${sign} R$ ${t.value.toFixed(2)}</td>
                            <td class="p-3 text-center flex justify-center items-center">
                                ${editBtn}
                                ${delBtn}
                            </td>
                        `;
                        list.appendChild(tr);
                    });

                } catch(e) { console.error(e); list.innerHTML = '<tr><td colspan="5" class="text-center text-red-500">Erro ao carregar.</td></tr>'; }
            },

            async cleanupOldAgenda(todayDate) {
                if(!window.db) return;
                try {
                    const q = window.query(window.collection(window.db, `artifacts/${window.appId}/public/data/agenda`), window.where('date', '<', todayDate));
                    const snapshot = await window.getDocs(q);
                    snapshot.forEach(async (doc) => { await window.deleteDoc(doc.ref); });
                } catch (e) { console.error(e); }
            },

            async checkBirthdays() {
                if(!window.db) return;
                const today = new Date();
                const currentMonth = today.getMonth() + 1;
                const currentDay = today.getDate();
                
                const q = window.query(window.collection(window.db, `artifacts/${window.appId}/public/data/clientes`));
                const snapshot = await window.getDocs(q);
                
                const birthdays = [];
                snapshot.forEach(doc => {
                    const c = doc.data();
                    if (c.birth) {
                        const [bYear, bMonth, bDay] = c.birth.split('-').map(Number);
                        if (bMonth === currentMonth && bDay === currentDay) {
                            birthdays.push({ name: c.name, phone: c.phone, date: `${bDay}/${bMonth}`, isToday: true });
                        } else if (bMonth === currentMonth && bDay > currentDay && bDay <= currentDay + 7) {
                            birthdays.push({ name: c.name, phone: c.phone, date: `${bDay}/${bMonth}`, isToday: false });
                        }
                    }
                });

                const listEl = document.getElementById('birthdays-list');
                const cardEl = document.getElementById('birthdays-card');
                listEl.innerHTML = '';

                if (birthdays.length > 0) {
                    cardEl.classList.remove('hidden');
                    birthdays.forEach(b => {
                        const icon = b.isToday ? 'üéÇ HOJE!' : 'üéà';
                        const style = b.isToday ? 'font-bold text-purple-700 bg-purple-50' : 'text-gray-600';
                        const wppLink = b.phone ? `https://wa.me/55${b.phone.replace(/\D/g,'')}` : '#';
                        
                        listEl.innerHTML += `
                            <li class="flex justify-between items-center p-2 rounded ${style}">
                                <span>${icon} ${b.name} (${b.date})</span>
                                ${b.phone ? `<a href="${wppLink}" target="_blank" class="text-green-600 hover:scale-110 transition-transform">üí¨</a>` : ''}
                            </li>
                        `;
                    });
                } else {
                    cardEl.classList.add('hidden');
                }
            },

            switchTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-pill').forEach(el => el.classList.remove('active'));
                
                const t = document.getElementById(`tab-${tab}`);
                const n = document.getElementById(`nav-${tab}`);
                if(t) t.classList.add('active');
                if(n) n.classList.add('active');

                if (tab === 'fluxo') this.loadFluxo();
            },

            showMessage(msg, type = 'info') {
                const toast = document.getElementById('toast');
                const msgEl = document.getElementById('toast-msg');
                msgEl.textContent = msg;
                toast.className = `fixed top-6 right-6 px-6 py-4 rounded-xl shadow-2xl z-50 transform transition-all duration-300 flex items-center gap-3 ${type==='error'?'bg-red-600':type==='success'?'bg-green-600':'bg-gray-800'} text-white`;
                toast.classList.remove('hidden', 'translate-y-[-20px]', 'opacity-0');
                setTimeout(() => { toast.classList.add('translate-y-[-20px]', 'opacity-0'); setTimeout(() => toast.classList.add('hidden'), 300); }, 3000);
            },

            toggleLoading(btnId, isLoading) {
                const btn = document.getElementById(btnId);
                if (!btn) return;
                if(isLoading) {
                    btn.setAttribute('data-original-text', btn.innerHTML);
                    btn.innerHTML = `<span class="loading-spinner"></span>`;
                    btn.disabled = true;
                } else {
                    btn.innerHTML = btn.getAttribute('data-original-text');
                    btn.disabled = false;
                }
            },

            enableFeatures() {
                document.querySelectorAll('button').forEach(b => b.disabled = false);
                document.getElementById('btn-export-pdf').disabled = true;
                document.getElementById('btn-save-cloud').disabled = true;
                document.getElementById('btn-local-backup').disabled = true;
            },
            
            // --- ESTOQUE ---
            async saveStockItem() {
                const name = document.getElementById('stock-name').value.trim();
                const category = document.getElementById('stock-category').value;
                const qty = parseInt(document.getElementById('stock-qty').value) || 0;
                const min = parseInt(document.getElementById('stock-min').value) || 0;

                if(!name) return this.showMessage("Nome do produto obrigat√≥rio", "error");

                this.toggleLoading('btn-save-stock', true);
                try {
                    await window.addDoc(window.collection(window.db, `artifacts/${window.appId}/public/data/estoque`), {
                        name, category, qty, min,
                        createdAt: window.Timestamp.now()
                    });
                    this.showMessage("Item adicionado ao estoque!", "success");
                    document.getElementById('stock-name').value = '';
                    document.getElementById('stock-qty').value = '';
                    this.loadStock();
                } catch(e) { this.showMessage("Erro: "+e.message, "error"); }
                finally { this.toggleLoading('btn-save-stock', false); }
            },

            async loadStock() {
                if(!window.userId || !window.db) return;
                const catFilter = document.getElementById('stock-filter-cat') ? document.getElementById('stock-filter-cat').value : 'all';
                
                let q;
                if(catFilter === 'all') {
                    q = window.query(window.collection(window.db, `artifacts/${window.appId}/public/data/estoque`));
                } else {
                    q = window.query(window.collection(window.db, `artifacts/${window.appId}/public/data/estoque`), window.where('category', '==', catFilter));
                }

                const snapshot = await window.getDocs(q);
                this.stock = [];
                snapshot.forEach(doc => this.stock.push({id: doc.id, ...doc.data()}));
                this.stock.sort((a,b) => a.name.localeCompare(b.name));

                const tbody = document.getElementById('stock-list-body');
                if(tbody) {
                    tbody.innerHTML = '';
                    this.stock.forEach(item => {
                        const isLow = item.qty <= item.min;
                        const rowClass = isLow ? 'bg-red-50' : 'hover:bg-gray-50';
                        const statusBadge = isLow ? `<span class="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold">‚ö†Ô∏è Repor</span>` : '';
                        const catMap = { 'venda': 'Venda', 'uso_interno': 'Uso Interno', 'bebidas': 'Bebidas', 'outros': 'Outros' };

                        tbody.innerHTML += `
                            <tr class="${rowClass} border-b border-gray-100 transition-colors">
                                <td class="p-3">
                                    <div class="font-medium text-gray-900">${item.name}</div>
                                    <div class="text-xs text-gray-500 flex items-center gap-2">
                                        ${catMap[item.category]} ${statusBadge}
                                    </div>
                                </td>
                                <td class="p-3 text-center">
                                    <div class="flex items-center justify-center gap-2">
                                        <button onclick="window.appLogic.updateStockQty('${item.id}', -1)" class="w-8 h-8 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 font-bold">-</button>
                                        <span class="w-8 text-center font-mono font-bold ${isLow ? 'text-red-600' : 'text-gray-800'}">${item.qty}</span>
                                        <button onclick="window.appLogic.updateStockQty('${item.id}', 1)" class="w-8 h-8 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 font-bold">+</button>
                                    </div>
                                </td>
                                <td class="p-3 text-center">
                                    <button onclick="window.appLogic.deleteStockItem('${item.id}')" class="text-gray-400 hover:text-red-500 p-2">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `;
                    });
                }
            },

            async updateStockQty(id, change) {
                const item = this.stock.find(i => i.id === id);
                if(!item) return;
                
                const newQty = Math.max(0, item.qty + change);
                try {
                    await window.updateDoc(window.doc(window.db, `artifacts/${window.appId}/public/data/estoque`, id), { qty: newQty });
                    item.qty = newQty; 
                    this.loadStock(); 
                } catch(e) { console.error(e); }
            },

            deleteStockItem(id) {
                if(!confirm("Remover item do estoque?")) return;
                window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/public/data/estoque`, id))
                .then(() => {
                    this.loadStock();
                    this.showMessage("Item removido.");
                });
            },

            // --- CLIENTES ---
            async saveClient() {
                const name = document.getElementById('client-name').value.trim();
                const phone = document.getElementById('client-phone').value.trim();
                const birth = document.getElementById('client-birth').value;
                const obs = document.getElementById('client-obs').value;

                if(!name) return this.showMessage("Nome √© obrigat√≥rio", "error");
                
                this.toggleLoading('btn-save-client', true);
                try {
                    const collectionRef = window.collection(window.db, `artifacts/${window.appId}/public/data/clientes`);
                    
                    if (this.editingClientId) {
                        await window.updateDoc(window.doc(window.db, `artifacts/${window.appId}/public/data/clientes`, this.editingClientId), {
                            name, phone, birth, obs
                        });
                        this.showMessage("Cliente atualizado!", "success");
                    } else {
                        await window.addDoc(collectionRef, {
                            name, phone, birth, obs,
                            createdAt: window.Timestamp.now()
                        });
                        this.showMessage("Cliente salvo!", "success");
                    }
                    
                    this.cancelClientEdit(); 
                    this.loadClients();
                    this.checkBirthdays(); 
                } catch(e) { this.showMessage("Erro: "+e.message, "error"); }
                finally { this.toggleLoading('btn-save-client', false); }
            },

            startEditClient(client) {
                this.editingClientId = client.id;
                document.getElementById('client-name').value = client.name || '';
                document.getElementById('client-phone').value = client.phone || '';
                document.getElementById('client-birth').value = client.birth || '';
                document.getElementById('client-obs').value = client.obs || '';

                const btn = document.getElementById('btn-save-client');
                btn.innerHTML = "Salvar Altera√ß√µes";
                btn.className = "btn btn-primary flex-grow py-3.5 shadow-lg bg-gradient-to-r from-blue-500 to-indigo-500 border-none text-white";
                
                document.getElementById('btn-cancel-client').classList.remove('hidden');
                document.getElementById('client-name').scrollIntoView({ behavior: 'smooth', block: 'center' });
            },

            cancelClientEdit() {
                this.editingClientId = null;
                document.getElementById('client-name').value = '';
                document.getElementById('client-phone').value = '';
                document.getElementById('client-birth').value = '';
                document.getElementById('client-obs').value = '';

                const btn = document.getElementById('btn-save-client');
                btn.innerHTML = "Cadastrar Cliente";
                btn.className = "btn btn-primary flex-grow py-3.5 shadow-lg bg-gradient-to-r from-pink-500 to-rose-500 border-none text-white";
                
                document.getElementById('btn-cancel-client').classList.add('hidden');
            },

            async loadClients() {
                if(!window.userId || !window.db) return;
                const q = window.query(window.collection(window.db, `artifacts/${window.appId}/public/data/clientes`));
                const snapshot = await window.getDocs(q);
                
                this.clients = [];
                snapshot.forEach(doc => this.clients.push({id: doc.id, ...doc.data()}));
                this.clients.sort((a,b) => a.name.localeCompare(b.name));

                this.updateClientDatalist(); 
                this.renderClientsList(this.clients);
            },

            updateClientDatalist() {
                const datalist = document.getElementById('clientes-list');
                datalist.innerHTML = '';
                this.clients.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.name;
                    datalist.appendChild(option);
                });
            },

            renderClientsList(listData) {
                const tbody = document.getElementById('clients-list-body');
                tbody.innerHTML = '';
                
                listData.forEach(c => {
                    const wppLink = c.phone ? `https://wa.me/55${c.phone.replace(/\D/g,'')}` : '#';
                    const wppDisplay = c.phone ? `<a href="${wppLink}" target="_blank" class="text-green-600 hover:underline flex items-center"><svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.506-.669-.516-.173-.009-.371-.009-.57-.009-.198 0-.52.074-.792.372-.272.297-1.04 1.017-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>${c.phone}</a>` : '-';

                    const clientStr = encodeURIComponent(JSON.stringify(c));

                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50 mobile-card-row">
                            <td class="p-4 font-medium text-gray-900">${c.name}</td>
                            <td class="p-4 text-gray-600">${wppDisplay}</td>
                            <td class="p-4 text-sm text-gray-500 max-w-xs truncate">${c.obs || '-'}</td>
                            <td class="p-4 text-center">
                                <button onclick="window.appLogic.startEditClient(JSON.parse(decodeURIComponent('${clientStr}')))" class="text-gray-400 hover:text-blue-500 p-2 mr-1">‚úèÔ∏è</button>
                                <button onclick="window.appLogic.deleteClient('${c.id}')" class="text-gray-400 hover:text-red-500 p-2">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            },

            filterClients(term) {
                const lower = term.toLowerCase();
                const filtered = this.clients.filter(c => c.name.toLowerCase().includes(lower));
                this.renderClientsList(filtered);
            },

            deleteClient(id) {
                if(!confirm("Excluir cliente?")) return;
                window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/public/data/clientes`, id))
                .then(() => {
                    this.loadClients();
                    this.showMessage("Cliente removido.");
                });
            },

            // --- AGENDA ---
            addAgendaItem(type, presetValue = '') {
                const container = document.getElementById('agenda-items-container');
                const div = document.createElement('div');
                div.className = "flex gap-2 items-center animate-fade-in item-row-agenda bg-yellow-50 p-2 rounded border border-yellow-200";
                
                div.innerHTML = `
                    <span class="text-sm w-6 text-center select-none text-yellow-600">‚úÇÔ∏è</span>
                    <input type="text" placeholder="Servi√ßo..." value="${presetValue}" class="agenda-item-name flex-grow input-field text-sm bg-white !py-1.5 border-yellow-200">
                    <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-red-500 p-1">‚úï</button>
                `;
                container.appendChild(div);
            },

            async saveAgenda() {
                if(!window.userId) return this.showMessage("Fa√ßa login", "error");
                
                const date = document.getElementById('agenda-date-input').value;
                const time = document.getElementById('agenda-time-input').value;
                const prof = document.getElementById('agenda-profissional').value;
                const client = document.getElementById('agenda-cliente').value;
                const obs = document.getElementById('agenda-obs').value;

                const services = [];
                document.querySelectorAll('.agenda-item-name').forEach(input => {
                    if(input.value.trim()) services.push(input.value.trim());
                });

                if(!date || !time || !prof || !client) return this.showMessage("Preencha Data, Hora, Profissional e Cliente", "error");
                if(services.length === 0) return this.showMessage("Adicione pelo menos um servi√ßo", "error");

                this.toggleLoading('btn-save-agenda', true);
                try {
                    if (this.editingAgendaId) {
                        await window.updateDoc(window.doc(window.db, `artifacts/${window.appId}/public/data/agenda`, this.editingAgendaId), {
                            date, time, prof, client, services, obs
                        });
                        this.showMessage("Agendamento atualizado!", "success");
                    } else {
                        await window.addDoc(window.collection(window.db, `artifacts/${window.appId}/public/data/agenda`), {
                            date, time, prof, client, services, obs, 
                            status: 'agendado', 
                            createdBy: window.userId,
                            createdAt: window.Timestamp.now()
                        });
                        this.showMessage("Agendado!", "success");
                    }
                    
                    this.cancelAgendaEdit(); 
                    this.loadAgenda();
                } catch(e) { this.showMessage("Erro: "+e.message, "error"); }
                finally { this.toggleLoading('btn-save-agenda', false); }
            },
            
            startEditAgenda(item) {
                this.editingAgendaId = item.id;
                document.getElementById('agenda-date-input').value = item.date;
                document.getElementById('agenda-time-input').value = item.time;
                document.getElementById('agenda-profissional').value = item.prof;
                document.getElementById('agenda-cliente').value = item.client;
                document.getElementById('agenda-obs').value = item.obs || '';
                
                const container = document.getElementById('agenda-items-container');
                container.innerHTML = '';
                
                if (Array.isArray(item.services) && item.services.length > 0) {
                    item.services.forEach(svc => this.addAgendaItem('servico', svc));
                } else {
                    this.addAgendaItem('servico', item.service || '');
                }

                const btn = document.getElementById('btn-save-agenda');
                btn.innerHTML = "Salvar Altera√ß√µes";
                btn.className = "btn btn-primary w-full py-4 shadow-lg active:scale-95 text-base bg-gradient-to-r from-blue-500 to-indigo-500 border-none text-white";
                
                let cancelBtn = document.getElementById('btn-cancel-agenda');
                if(!cancelBtn) {
                     cancelBtn = document.createElement('button');
                     cancelBtn.id = 'btn-cancel-agenda';
                     cancelBtn.className = 'btn bg-gray-200 text-gray-700 w-full mt-2 py-2';
                     cancelBtn.innerHTML = 'Cancelar Edi√ß√£o';
                     cancelBtn.onclick = () => window.appLogic.cancelAgendaEdit();
                     btn.parentNode.insertBefore(cancelBtn, btn.nextSibling);
                } else {
                    cancelBtn.classList.remove('hidden');
                }
                document.querySelector('#tab-agenda').scrollIntoView({ behavior: 'smooth' });
            },
            
            cancelAgendaEdit() {
                this.editingAgendaId = null;
                document.getElementById('agenda-cliente').value = '';
                document.getElementById('agenda-items-container').innerHTML = '';
                this.addAgendaItem('servico'); 
                document.getElementById('agenda-obs').value = '';
                
                const btn = document.getElementById('btn-save-agenda');
                btn.innerHTML = "Agendar Hor√°rio";
                btn.className = "btn btn-primary w-full py-4 shadow-lg active:scale-95 text-base bg-gradient-to-r from-yellow-500 to-orange-500 border-none text-white";
                
                const cancelBtn = document.getElementById('btn-cancel-agenda');
                if(cancelBtn) cancelBtn.classList.add('hidden');
            },

            async loadAgenda() {
                if(!window.userId || !window.db) return;
                const filterDate = document.getElementById('agenda-filter-date').value;
                const list = document.getElementById('agenda-list');
                const empty = document.getElementById('agenda-empty');
                
                list.innerHTML = '<div class="text-center py-4"><span class="loading-spinner border-gray-400"></span></div>';
                
                try {
                    const q = window.query(
                        window.collection(window.db, `artifacts/${window.appId}/public/data/agenda`),
                        window.where('date', '==', filterDate)
                    );
                    const snapshot = await window.getDocs(q);
                    
                    list.innerHTML = '';
                    if(snapshot.empty) {
                        empty.classList.remove('hidden');
                        return;
                    }
                    empty.classList.add('hidden');

                    const items = [];
                    snapshot.forEach(doc => items.push({id: doc.id, ...doc.data()}));
                    items.sort((a,b) => a.time.localeCompare(b.time));

                    items.forEach(item => {
                        const statusColors = {
                            'agendado': 'status-agendado',
                            'confirmado': 'status-confirmado',
                            'concluido': 'status-concluido',
                            'cancelado': 'status-cancelado'
                        };
                        const cls = statusColors[item.status] || '';
                        
                        const turnBtn = item.status === 'concluido' 
                            ? `<button onclick='window.appLogic.turnToFicha(${JSON.stringify(item)})' class="text-xs bg-indigo-600 text-white px-2 py-1 rounded shadow ml-2 hover:bg-indigo-700 transition-colors">Virar Ficha ‚û°Ô∏è</button>` 
                            : '';

                        const itemStr = encodeURIComponent(JSON.stringify(item));
                        
                        const editBtn = `<button onclick="window.appLogic.startEditAgenda(JSON.parse(decodeURIComponent('${itemStr}')))" class="text-gray-400 hover:text-blue-500 p-1 mr-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>`;
                        
                        const deleteBtn = `<button onclick="window.appLogic.deleteAgendaItem('${item.id}', '${item.createdBy}')" class="text-gray-400 hover:text-red-500 p-1 ml-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`;

                        const servicesDisplay = Array.isArray(item.services) ? item.services.join(', ') : (item.service || 'Servi√ßo n√£o especificado');

                        const div = document.createElement('div');
                        div.className = `p-4 rounded-lg border shadow-sm flex flex-col gap-2 ${cls} border-opacity-50 transition-all hover:shadow-md`;
                        div.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="flex gap-3">
                                    <div class="text-2xl font-bold opacity-80 font-mono">${item.time}</div>
                                    <div>
                                        <div class="font-bold text-lg leading-tight text-gray-900">${item.client}</div>
                                        <div class="text-sm opacity-90 mt-0.5">${servicesDisplay}</div>
                                        <div class="text-xs font-semibold uppercase tracking-wide mt-1 opacity-75 flex items-center gap-1">
                                            <span class="w-2 h-2 rounded-full bg-current opacity-50"></span> ${item.prof}
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                    <div class="flex items-center bg-white/50 rounded p-0.5">
                                        <select onchange="window.appLogic.updateAgendaStatus('${item.id}', this.value)" class="text-xs border-none bg-transparent font-medium focus:ring-0 cursor-pointer py-1 pl-1 pr-6">
                                            <option value="agendado" ${item.status==='agendado'?'selected':''}>üü° Agendado</option>
                                            <option value="confirmado" ${item.status==='confirmado'?'selected':''}>üü¢ Confirmado</option>
                                            <option value="concluido" ${item.status==='concluido'?'selected':''}>‚úÖ Conclu√≠do</option>
                                            <option value="cancelado" ${item.status==='cancelado'?'selected':''}>üî¥ Cancelado</option>
                                        </select>
                                        ${editBtn}
                                        ${deleteBtn}
                                    </div>
                                    ${turnBtn}
                                </div>
                            </div>
                            ${item.obs ? `<div class="text-xs mt-2 pt-2 border-t border-black/10 text-gray-600 italic">Obs: ${item.obs}</div>` : ''}
                        `;
                        list.appendChild(div);
                    });

                } catch(e) { console.error(e); list.innerHTML="Erro ao carregar"; }
            },
            
            deleteAgendaItem(id, creatorId) {
                const isAdmin = window.ADMIN_EMAILS.includes(window.userEmail);
                const isOwner = creatorId === window.userId;

                if (!isAdmin && !isOwner) {
                    return this.showMessage("Voc√™ s√≥ pode excluir seus agendamentos.", "error");
                }
                
                if(confirm("Excluir este agendamento?")) {
                     window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/public/data/agenda`, id))
                     .then(() => {
                         this.loadAgenda();
                         this.showMessage("Agendamento exclu√≠do.");
                     });
                }
            },

            async updateAgendaStatus(id, status) {
                try {
                    await window.updateDoc(window.doc(window.db, `artifacts/${window.appId}/public/data/agenda`, id), { status });
                    this.loadAgenda(); 
                } catch(e) { this.showMessage("Erro ao atualizar", "error"); }
            },

            turnToFicha(item) {
                this.switchTab('fichas');
                document.getElementById('ficha-date').value = item.date;
                document.getElementById('ficha-profissional').value = item.prof;
                document.getElementById('ficha-cliente').value = item.client;
                document.getElementById('ficha-obs').value = item.obs || '';
                
                document.getElementById('ficha-items-container').innerHTML = '';
                
                if (Array.isArray(item.services) && item.services.length > 0) {
                    item.services.forEach(svc => {
                        this.addFichaItem('servico', svc); 
                    });
                } else {
                    this.addFichaItem('servico', item.service || '');
                }

                this.showMessage("Dados copiados! Preencha os valores.", "success");
            },

            // --- FICHAS ---
            addFichaItem(type, presetValue = '') {
                const container = document.getElementById('ficha-items-container');
                const div = document.createElement('div');
                div.className = "flex flex-col gap-2 animate-fade-in item-row bg-gray-50 p-3 rounded-lg border border-gray-200 shadow-sm mb-3"; 
                div.dataset.type = type;
                
                const ph = type === 'servico' ? 'Ex: Corte' : 'Ex: Shampoo';
                const cl = type === 'servico' ? 'text-indigo-600' : 'text-green-600';
                const ico = type === 'servico' ? '‚úÇÔ∏è' : 'üõçÔ∏è';

                div.innerHTML = `
                    <div class="flex items-center gap-2 w-full">
                        <span class="text-lg w-6 text-center select-none ${cl}">${ico}</span>
                        <input type="text" placeholder="${ph}" value="${presetValue}" class="item-name w-full input-field text-sm bg-white !py-2.5 font-medium border-gray-200 focus:border-indigo-500">
                    </div>
                    <div class="flex items-center gap-2 w-full pl-8"> 
                        <div class="relative flex-grow">
                             <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs">R$</span>
                             <input type="number" step="0.01" placeholder="0,00" class="item-value w-full input-field text-sm text-right bg-white !py-2.5 pl-8 font-bold text-gray-700" oninput="window.appLogic.calcFichaTotal()">
                        </div>
                        <select class="item-method w-[40%] input-field text-sm text-xs bg-white !py-2.5 text-gray-600">
                            <option value="pix">Pix</option>
                            <option value="credito_1x">Cr√©d. 1x</option>
                            <option value="credito_2x">Cr√©d. 2x</option>
                            <option value="credito_3x">Cr√©d. 3x</option>
                            <option value="debito">D√©bito</option>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="pendente">Pendente</option>
                        </select>
                        <button onclick="this.closest('.item-row').remove(); window.appLogic.calcFichaTotal()" class="text-gray-400 hover:text-red-500 p-2 bg-white rounded border border-gray-200 shadow-sm h-[42px] w-[42px] flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            },

            calcFichaTotal() {
                let total = 0;
                document.querySelectorAll('.item-value').forEach(input => total += parseFloat(input.value) || 0);
                document.getElementById('ficha-total-display').textContent = total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                return total;
            },

            async saveFicha() {
                if(!window.userId) return this.showMessage("Fa√ßa login primeiro", "error");
                const date = document.getElementById('ficha-date').value;
                const client = document.getElementById('ficha-cliente').value.trim();
                const professional = document.getElementById('ficha-profissional').value.trim();
                const obs = document.getElementById('ficha-obs').value.trim(); 

                if(!date || !client || !professional) return this.showMessage("Preencha todos os campos", "error");

                const items = [];
                document.querySelectorAll('.item-row').forEach(row => {
                    const name = row.querySelector('.item-name').value.trim();
                    const value = parseFloat(row.querySelector('.item-value').value) || 0;
                    if(name && value > 0) items.push({ name, value, method: row.querySelector('.item-method').value, type: row.dataset.type });
                });
                if(items.length === 0) return this.showMessage("Adicione itens com valor", "error");

                this.toggleLoading('btn-save-ficha', true);
                try {
                    const path = `artifacts/${window.appId}/public/data/fichas`;
                    const total = this.calcFichaTotal();
                    
                    if (this.editingFichaId) {
                        // Modo de edi√ß√£o
                        await window.updateDoc(window.doc(window.db, path, this.editingFichaId), {
                            date, 
                            clientName: client, 
                            professionalName: professional, 
                            items, 
                            obs,
                            total,
                            updatedAt: window.Timestamp.now()
                        });
                        this.showMessage("Ficha atualizada!", "success");
                        this.editingFichaId = null;
                    } else {
                        // Modo de cria√ß√£o
                        await window.addDoc(window.collection(window.db, path), {
                            createdBy: window.userId,
                            creatorEmail: window.auth.currentUser.email,
                            date, 
                            clientName: client, 
                            professionalName: professional, 
                            items, 
                            obs,
                            total,
                            createdAt: window.Timestamp.now()
                        });
                        this.showMessage("Ficha salva!", "success");
                    }
                    
                    this.resetFichaForm();
                    this.loadFichas();
                } catch (e) { console.error(e); this.showMessage("Erro: " + e.message, "error"); } 
                finally { this.toggleLoading('btn-save-ficha', false); }
            },

            resetFichaForm() {
                document.getElementById('ficha-cliente').value = '';
                document.getElementById('ficha-profissional').value = '';
                document.getElementById('ficha-obs').value = '';
                document.getElementById('ficha-items-container').innerHTML = '';
                this.addFichaItem('servico');
                this.calcFichaTotal();
                
                // Resetar o bot√£o para o estado original
                const submitBtn = document.getElementById('btn-save-ficha');
                if(submitBtn) {
                    submitBtn.textContent = 'Salvar Ficha';
                    submitBtn.classList.remove('bg-amber-600', 'hover:bg-amber-700');
                    submitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                }
                
                // Esconder bot√£o de cancelar
                const cancelBtn = document.getElementById('btn-cancel-ficha');
                if(cancelBtn) {
                    cancelBtn.classList.add('hidden');
                }
                
                // Limpar o ID de edi√ß√£o
                this.editingFichaId = null;
            },

            async loadFichas() {
                if(!window.userId || !window.db) return;
                const path = `artifacts/${window.appId}/public/data/fichas`;
                
                try {
                    let q;
                    if (window.ADMIN_EMAILS && window.ADMIN_EMAILS.includes(window.userEmail)) {
                        q = window.query(window.collection(window.db, path));
                    } else {
                        q = window.query(window.collection(window.db, path), window.where('createdBy', '==', window.userId));
                    }
                    
                    const snapshot = await window.getDocs(q);
                    let data = [];
                    snapshot.forEach(doc => data.push({id: doc.id, ...doc.data()}));
                    data.sort((a,b) => b.createdAt - a.createdAt);
                    
                    const tbody = document.getElementById('fichas-history-body');
                    tbody.innerHTML = '';
                    data.slice(0, 20).forEach(f => {
                        const date = new Date(f.date + 'T12:00').toLocaleDateString('pt-BR');
                        const clientDisplay = f.obs ? `${f.clientName} <br><span class="text-[10px] text-amber-600 bg-amber-50 px-1 rounded">Obs: ${f.obs}</span>` : f.clientName;
                        const fichaStr = encodeURIComponent(JSON.stringify(f));
                        
                        tbody.innerHTML += `
                            <tr class="hover:bg-gray-50 border-b border-gray-100 mobile-card-row">
                                <td class="p-4 text-gray-500 font-medium">${date}</td>
                                <td class="p-4 font-bold text-indigo-900">${f.professionalName}</td>
                                <td class="p-4 text-gray-800">${clientDisplay}</td>
                                <td class="p-4 text-xs text-gray-400">${f.items.length} itens</td>
                                <td class="p-4 text-right font-bold text-gray-700">R$ ${f.total.toFixed(2)}</td>
                                <td class="p-4 text-center">
                                    <button onclick="window.appLogic.startEditFicha(JSON.parse(decodeURIComponent('${fichaStr}')))" class="text-gray-400 hover:text-blue-500 p-2 mr-1" title="Editar">‚úèÔ∏è</button>
                                    <button onclick="window.appLogic.deleteFicha('${f.id}')" class="text-gray-300 hover:text-red-500 p-2" title="Excluir">‚úï</button>
                                </td>
                            </tr>
                        `;
                    });
                } catch (e) {
                    console.error("Erro ao carregar fichas:", e);
                }
            },

            deleteFicha(id) {
                if (!window.ADMIN_EMAILS || !window.ADMIN_EMAILS.includes(window.userEmail)) {
                    return this.showMessage("Apenas administradores podem excluir registros salvos.", "error");
                }

                const m = document.getElementById('confirm-modal');
                m.classList.add('open');
                document.getElementById('confirm-modal-btn').onclick = async () => {
                    try {
                        await window.deleteDoc(window.doc(window.db, `artifacts/${window.appId}/public/data/fichas`, id));
                        this.showMessage("Exclu√≠do.", "success");
                        this.loadFichas();
                        m.classList.remove('open');
                    } catch(e) { this.showMessage("Erro ao excluir", "error"); }
                };
            },

            startEditFicha(ficha) {
                if (!window.ADMIN_EMAILS || !window.ADMIN_EMAILS.includes(window.userEmail)) {
                    return this.showMessage("Apenas administradores podem editar registros salvos.", "error");
                }

                this.editingFichaId = ficha.id;
                
                // Preencher os campos do formul√°rio
                document.getElementById('ficha-date').value = ficha.date;
                document.getElementById('ficha-profissional').value = ficha.professionalName;
                document.getElementById('ficha-cliente').value = ficha.clientName;
                document.getElementById('ficha-obs').value = ficha.obs || '';
                
                // Limpar itens existentes
                const container = document.getElementById('ficha-items-container');
                container.innerHTML = '';
                
                // Adicionar os itens da ficha
                ficha.items.forEach(item => {
                    this.addFichaItem(item.type, item.name);
                    const lastRow = container.lastElementChild;
                    const valueInput = lastRow.querySelector('.item-value');
                    const methodSelect = lastRow.querySelector('.item-method');
                    
                    if(valueInput) valueInput.value = item.value;
                    if(methodSelect) methodSelect.value = item.method;
                });
                
                this.calcFichaTotal();
                
                // Mudar o texto do bot√£o para "Atualizar Ficha"
                const submitBtn = document.getElementById('btn-save-ficha');
                if(submitBtn) {
                    submitBtn.textContent = 'üíæ Atualizar Ficha';
                    submitBtn.classList.add('bg-amber-600', 'hover:bg-amber-700');
                    submitBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                }
                
                // Mostrar bot√£o de cancelar
                const cancelBtn = document.getElementById('btn-cancel-ficha');
                if(cancelBtn) {
                    cancelBtn.classList.remove('hidden');
                }
                
                // Scroll para o topo
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                this.showMessage("Editando ficha. Modifique os campos e clique em 'Atualizar Ficha'.", "info");
            },

            cancelFichaEdit() {
                this.editingFichaId = null;
                this.resetFichaForm();
                
                // Esconder bot√£o de cancelar
                const cancelBtn = document.getElementById('btn-cancel-ficha');
                if(cancelBtn) {
                    cancelBtn.classList.add('hidden');
                }
                
                this.showMessage("Edi√ß√£o cancelada.", "info");
            },

            // --- FECHAMENTO (Admin) ---
            async generateClosingReport() {
                if(!window.userId) return this.showMessage("Fa√ßa login", "error");
                const start = document.getElementById('closing-start-date').value;
                const end = document.getElementById('closing-end-date').value;
                if(!start || !end) return this.showMessage("Selecione datas", "error");

                this.toggleLoading('btn-generate-report', true);
                try {
                    const path = `artifacts/${window.appId}/public/data/fichas`;
                    const q = window.query(window.collection(window.db, path), window.where('date', '>=', start), window.where('date', '<=', end));
                    
                    const snapshot = await window.getDocs(q);
                    const fichas = [];
                    snapshot.forEach(d => fichas.push(d.data()));

                    if(fichas.length === 0) {
                        this.showMessage("Nada encontrado", "info");
                        document.getElementById('closing-results').classList.add('hidden');
                        document.getElementById('closing-empty-state').classList.remove('hidden');
                        return;
                    }

                    const report = this.calculateReportData(fichas, start, end);
                    
                    this.reportData = report;
                    this.renderClosingUI();
                    
                    document.getElementById('closing-empty-state').classList.add('hidden');
                    document.getElementById('closing-results').classList.remove('hidden');
                    document.getElementById('btn-export-pdf').disabled = false;
                    document.getElementById('btn-save-cloud').disabled = false;
                    document.getElementById('btn-local-backup').disabled = false;
                } catch(e) { console.error(e); this.showMessage("Erro: " + e.message, "error"); }
                finally { this.toggleLoading('btn-generate-report', false); }
            },

            calculateReportData(fichas, start, end) {
                const collabs = {}; const products = [];
                let gross = 0; let fees = 0;

                // regex atualizado para incluir "vale"
                const signalRegex = /(?:sinal|adiantamento|vale)[^\d]*[-]?\s*(?:R\$)?\s*(\d+(?:[.,]\d{2})?)/i;
                const signalRegexReverse = /[-]?\s*(?:R\$)?\s*(\d+(?:[.,]\d{2})?)\s*(?:sinal|adiantamento|vale)/i;

                fichas.forEach(f => {
                    const prof = f.professionalName || 'Desconhecido';
                    if(!collabs[prof]) collabs[prof] = { name: prof, total: 0, items: [], obsList: [], adminNote: '', advances: 0 };

                    if(f.obs) {
                        collabs[prof].obsList.push(`${f.date.split('-').reverse().slice(0,2).join('/')} (${f.clientName}): ${f.obs}`);
                        
                        let match = f.obs.match(signalRegex) || f.obs.match(signalRegexReverse);
                        if(match) {
                            let val = parseFloat(match[1].replace(',', '.'));
                            if(!isNaN(val)) {
                                collabs[prof].advances += val;
                            }
                        }
                    }

                    f.items.forEach(i => {
                        const fee = i.value * (this.cardRates[i.method] || 0);
                        fees += fee; gross += i.value;

                        if(i.type === 'servico') {
                            collabs[prof].total += i.value;
                            collabs[prof].items.push({ c: f.clientName, s: i.name, v: i.value, m: i.method });
                        } else {
                            products.push({ p: i.name, s: prof, c: f.clientName, v: i.value });
                        }
                    });
                });
                
                let paidToStaff = 0;
                Object.values(collabs).forEach(c => {
                    const share = c.total * 0.30;
                    const pay = c.total - share - c.advances; 
                    paidToStaff += pay;
                });
                
                const net = gross - paidToStaff - fees;

                return { start, end, gross, fees, net, collabs, products, paidToStaff };
            },

            recalcConfirmation() {
                const collabName = this.targetCollabForPDF;
                const cData = Object.values(this.reportData.collabs).find(c => c.name === collabName);
                if(!cData) return;

                const adjustment = parseFloat(document.getElementById('manual-adjustment').value) || 0;
                const note = document.getElementById('manual-adjustment-note').value;
                
                const share = cData.total * 0.30;
                const totalPay = cData.total - share - cData.advances + adjustment;

                document.getElementById('confirm-pay').textContent = `R$ ${totalPay.toFixed(2)}`;
                
                cData.manualAdjustment = adjustment;
                cData.manualAdjustmentNote = note;
            },

            renderClosingUI() {
                const d = this.reportData;
                if(!d) return;

                document.getElementById('total-gross').textContent = `R$ ${d.gross.toFixed(2)}`;
                document.getElementById('total-fees').textContent = `- R$ ${d.fees.toFixed(2)}`;
                document.getElementById('total-net').textContent = `R$ ${d.net.toFixed(2)}`;

                const cContainer = document.getElementById('collaborators-report-container');
                cContainer.innerHTML = '';

                Object.values(d.collabs).forEach(c => {
                    const share = c.total * 0.30;
                    const pay = c.total - share - c.advances;

                    const obsHtml = c.obsList.length > 0 ? 
                        `<div class="mt-3 bg-amber-50 p-2 rounded text-[10px] text-amber-800 border border-amber-100"><strong>Obs Fichas:</strong><br>${c.obsList.join('<br>')}</div>` : '';

                    const advanceHtml = c.advances > 0 ? 
                        `<div class="text-red-600 font-bold mt-1">(-) Adiantamentos/Sinais/Vales: R$ ${c.advances.toFixed(2)}</div>` : '';

                    cContainer.innerHTML += `
                        <div class="bg-white border border-gray-100 rounded-xl p-6 shadow-sm relative">
                            <div class="flex justify-between items-start mb-4 border-b pb-4">
                                <div><h4 class="font-bold text-lg text-gray-800">${c.name}</h4><span class="text-xs bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded">${c.items.length} servi√ßos</span></div>
                                <div class="text-right"><span class="text-xs font-semibold text-gray-400 uppercase">A Pagar</span><div class="font-bold text-2xl text-green-600">R$ ${pay.toFixed(2)}</div></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm mb-4 bg-gray-50 p-3 rounded-lg">
                                <div><span class="text-xs text-gray-400 uppercase block">Bruto</span><span class="font-bold text-gray-700">R$ ${c.total.toFixed(2)}</span></div>
                                <div><span class="text-xs text-gray-400 uppercase block">Reten√ß√£o (30%)</span><span class="font-bold text-red-500">- R$ ${share.toFixed(2)}</span></div>
                            </div>
                            ${advanceHtml}
                            ${obsHtml}
                            <div class="mt-4">
                                <label class="block text-xs font-bold text-gray-500 mb-1">Obs. Admin (Individual)</label>
                                <textarea class="w-full border border-gray-200 rounded p-2 text-sm h-16 admin-collab-note" data-collab="${c.name}" placeholder="Ex: Cobran√ßa extra, ajuste...">${c.adminNote || ''}</textarea>
                            </div>
                            <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-100">
                                <details><summary class="text-xs font-bold text-indigo-500 cursor-pointer">Ver Detalhes</summary><ul class="mt-2 text-xs text-gray-600 space-y-1 max-h-40 overflow-y-auto">${c.items.map(i=>`<li>${i.c} - ${i.s}: R$${i.v.toFixed(0)} (${i.m})</li>`).join('')}</ul></details>
                                <button onclick="window.appLogic.promptCollaboratorPDF('${c.name}')" class="text-xs bg-gray-800 text-white px-3 py-2 rounded hover:bg-gray-700">üìÑ PDF Individual</button>
                            </div>
                        </div>
                    `;
                });

                const pList = document.getElementById('products-report-list');
                pList.innerHTML = d.products.map(p => `<tr><td class="p-3 font-medium">${p.p}</td><td class="p-3 text-gray-500">${p.s}</td><td class="p-3 text-right font-mono">R$ ${p.v.toFixed(2)}</td></tr>`).join('');
                document.getElementById('products-report-total').textContent = `Total: R$ ${d.products.reduce((a,b)=>a+b.v,0).toFixed(2)}`;
            },

            updateReportNotes() {
                if(!this.reportData) return;
                document.querySelectorAll('.admin-collab-note').forEach(el => {
                    const name = el.dataset.collab;
                    if(this.reportData.collabs[name]) {
                        this.reportData.collabs[name].adminNote = el.value;
                    }
                });
            },

            // --- COMPLETANDO AS FUN√á√ïES FALTANTES ---

            async saveWeeklyClosing() {
                if(!this.reportData) return;
                this.updateReportNotes(); 

                this.toggleLoading('btn-save-cloud', true);
                try {
                    const path = `artifacts/${window.appId}/public/data/fechamentos_semanais`;
                    const dateObj = new Date(this.reportData.start);
                    const y = dateObj.getFullYear();
                    const m = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const d = String(dateObj.getDate()).padStart(2, '0');
                    const docId = `${y}-${m}-${d}_sem`;

                    await window.setDoc(window.doc(window.db, path, docId), {
                        ...this.reportData,
                        updatedAt: window.Timestamp.now()
                    });

                    this.showMessage("Fechamento salvo na nuvem!", "success");
                } catch(e) { console.error(e); this.showMessage("Erro ao salvar: " + e.message, "error"); }
                finally { this.toggleLoading('btn-save-cloud', false); }
            },
            
            exportLocalBackup() {
                if(!this.reportData) return;
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.reportData));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href",     dataStr);
                downloadAnchorNode.setAttribute("download", `fechamento_${this.reportData.start}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            },

            promptCollaboratorPDF(collabName) {
                this.targetCollabForPDF = collabName;
                const cData = Object.values(this.reportData.collabs).find(c => c.name === collabName);
                if(!cData) return;
                
                document.getElementById('receipt-collab-name').textContent = collabName;
                document.getElementById('confirm-total').textContent = `R$ ${cData.total.toFixed(2)}`;
                document.getElementById('confirm-share').textContent = `- R$ ${(cData.total * 0.3).toFixed(2)}`;
                document.getElementById('confirm-advances').textContent = `- R$ ${(cData.advances || 0).toFixed(2)}`;
                
                document.getElementById('manual-adjustment').value = '';
                document.getElementById('manual-adjustment-note').value = '';
                this.recalcConfirmation();
                
                document.getElementById('receipt-confirmation-content').classList.remove('hidden');
                document.getElementById('receipt-modal').classList.add('open');
            },

            generateCollaboratorPDF(attachReceipt) {
                const collabName = this.targetCollabForPDF;
                if(!collabName || !this.reportData) return;
                
                const cData = Object.values(this.reportData.collabs).find(c => c.name === collabName);
                if(!cData) return;

                const doc = new window.jspdf.jsPDF();
                
                doc.setFontSize(18);
                doc.text("Espa√ßo Fran Kokott", 10, 20);
                doc.setFontSize(12);
                doc.text(`Recibo de Pagamento - ${collabName}`, 10, 30);
                doc.text(`Per√≠odo: ${this.reportData.start.split('-').reverse().join('/')} a ${this.reportData.end.split('-').reverse().join('/')}`, 10, 36);
                
                doc.line(10, 40, 200, 40);
                
                let y = 50;
                doc.setFontSize(11);
                doc.text(`Total Bruto de Servi√ßos:`, 10, y);
                doc.text(`R$ ${cData.total.toFixed(2)}`, 150, y, {align: 'right'});
                y += 8;
                
                doc.text(`Reten√ß√£o Sal√£o (30%):`, 10, y);
                doc.setTextColor(200, 0, 0);
                doc.text(`- R$ ${(cData.total * 0.3).toFixed(2)}`, 150, y, {align: 'right'});
                doc.setTextColor(0, 0, 0);
                y += 8;

                if(cData.advances > 0) {
                    doc.text(`Adiantamentos/Vales:`, 10, y);
                    doc.setTextColor(200, 0, 0);
                    doc.text(`- R$ ${cData.advances.toFixed(2)}`, 150, y, {align: 'right'});
                    doc.setTextColor(0, 0, 0);
                    y += 8;
                }

                if(cData.manualAdjustment && cData.manualAdjustment !== 0) {
                     doc.text(`Ajustes Extras (${cData.manualAdjustmentNote || 'Diversos'}):`, 10, y);
                     const color = cData.manualAdjustment > 0 ? [0,128,0] : [200,0,0];
                     doc.setTextColor(...color);
                     doc.text(`R$ ${cData.manualAdjustment.toFixed(2)}`, 150, y, {align: 'right'});
                     doc.setTextColor(0,0,0);
                     y += 8;
                }

                doc.line(10, y, 160, y);
                y += 8;
                
                const share = cData.total * 0.30;
                const adjustment = cData.manualAdjustment || 0;
                const finalPay = cData.total - share - cData.advances + adjustment;

                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`L√≠quido a Receber:`, 10, y);
                doc.text(`R$ ${finalPay.toFixed(2)}`, 150, y, {align: 'right'});
                
                y += 20;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text("Detalhamento dos Servi√ßos:", 10, y);
                y += 6;
                
                cData.items.forEach(item => {
                    if (y > 280) { doc.addPage(); y = 20; }
                    doc.text(`${item.c} - ${item.s}`, 10, y);
                    doc.text(`R$ ${item.v.toFixed(2)}`, 150, y, {align: 'right'});
                    y += 5;
                });

                if(cData.adminNote) {
                     y += 10;
                     doc.setFont(undefined, 'italic');
                     doc.text(`Nota Admin: ${cData.adminNote}`, 10, y);
                }

                // Salvar
                doc.save(`recibo_${collabName.replace(/\s+/g, '_')}_${this.reportData.end}.pdf`);
                
                document.getElementById('receipt-modal').classList.remove('open');
                this.showMessage("PDF Gerado!", "success");
            },

            exportClosingPDF() {
                if(!this.reportData) return;
                const doc = new window.jspdf.jsPDF();
                const d = this.reportData;

                doc.setFontSize(20);
                doc.text("Relat√≥rio Semanal Geral", 10, 20);
                doc.setFontSize(12);
                doc.text(`Per√≠odo: ${d.start.split('-').reverse().join('/')} a ${d.end.split('-').reverse().join('/')}`, 10, 30);
                
                doc.setFillColor(240, 240, 240);
                doc.rect(10, 40, 190, 30, 'F');
                doc.setFontSize(14);
                doc.text(`Bruto Total: R$ ${d.gross.toFixed(2)}`, 15, 50);
                doc.text(`Taxas Cart√£o: R$ ${d.fees.toFixed(2)}`, 15, 60);
                doc.text(`L√≠quido Sal√£o: R$ ${d.net.toFixed(2)}`, 15, 70); // Aproximado

                let y = 85;
                doc.setFontSize(14);
                doc.text("Resumo por Profissional", 10, y);
                y += 10;

                doc.setFontSize(10);
                Object.values(d.collabs).forEach(c => {
                    const share = c.total * 0.30;
                    const pay = c.total - share - c.advances + (c.manualAdjustment || 0);
                    doc.text(`${c.name}: Produziu R$ ${c.total.toFixed(2)} | Recebe R$ ${pay.toFixed(2)}`, 10, y);
                    y += 6;
                });

                y += 10;
                doc.setFontSize(14);
                doc.text("Produtos Vendidos", 10, y);
                y += 8;
                doc.setFontSize(10);
                d.products.forEach(p => {
                    doc.text(`${p.p} (${p.s}) - R$ ${p.v.toFixed(2)}`, 10, y);
                    y += 5;
                });

                doc.save(`relatorio_geral_${d.end}.pdf`);
            },
            
            async openSavedClosingsModal() {
                 document.getElementById('saved-closings-modal').classList.add('open');
                 const list = document.getElementById('saved-closings-list');
                 list.innerHTML = '';
                 document.getElementById('saved-loading').classList.remove('hidden');

                 try {
                     const q = window.query(window.collection(window.db, `artifacts/${window.appId}/public/data/fechamentos_semanais`));
                     const snap = await window.getDocs(q);
                     
                     document.getElementById('saved-loading').classList.add('hidden');
                     
                     if(snap.empty) {
                         document.getElementById('saved-empty').classList.remove('hidden');
                         return;
                     }
                     
                     snap.forEach(doc => {
                         const d = doc.data();
                         const start = d.start ? d.start.split('-').reverse().slice(0,2).join('/') : '??';
                         const end = d.end ? d.end.split('-').reverse().slice(0,2).join('/') : '??';
                         
                         list.innerHTML += `
                            <tr>
                                <td class="p-3">${start} a ${end}</td>
                                <td class="p-3 text-right">R$ ${d.gross?.toFixed(2)}</td>
                                <td class="p-3 text-center">
                                    <button onclick='window.appLogic.reportData = ${JSON.stringify(d)}; window.appLogic.renderClosingUI(); document.getElementById("saved-closings-modal").classList.remove("open"); document.getElementById("closing-results").classList.remove("hidden");' class="text-blue-600 hover:underline text-xs">Carregar</button>
                                </td>
                            </tr>
                         `;
                     });
                 } catch(e) { console.error(e); }
            },

            async generateMonthlyReport() {
                // Simplificado: Apenas placeholder para l√≥gica futura
                this.showMessage("Funcionalidade em desenvolvimento (Requer queries complexas).", "info");
            }
        };
    </script>
</body>
</html>
