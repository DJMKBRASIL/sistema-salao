<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão | Espaço Fran Kokott</title>
    
    <!-- Fontes e Estilos -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: 'Lato', sans-serif; background-color: #f8fafc; }
        .serif-font { font-family: 'Cormorant Garamond', serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
        
        /* Estilo dos Inputs */
        .input-padrao {
            width: 100%; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.625rem; 
            outline: none; transition: border-color 0.2s;
        }
        .input-padrao:focus { border-color: #4f46e5; ring: 2px solid #e0e7ff; }
    </style>
</head>
<body class="text-slate-700 h-screen flex flex-col overflow-hidden">

    <!-- LOGIN -->
    <div id="auth-container" class="flex-grow flex items-center justify-center p-4 bg-slate-50">
        <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-md fade-in border border-slate-100">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-semibold text-indigo-900 mb-2 serif-font">Fran Kokott</h1>
                <p class="text-xs uppercase tracking-widest text-slate-400">Sistema de Gestão</p>
            </div>
            <button id="btn-login" class="w-full bg-indigo-900 hover:bg-indigo-800 text-white font-bold py-3 px-4 rounded-lg transition shadow-md flex justify-center gap-2">
                <i class="fas fa-lock"></i> Acessar Sistema
            </button>
            <p id="auth-status" class="text-center text-sm text-red-500 mt-4 min-h-[20px]"></p>
        </div>
    </div>

    <!-- SISTEMA -->
    <div id="app-container" class="hidden h-full flex flex-col md:flex-row overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="md:w-64 bg-white border-r border-slate-200 shadow-sm z-10 flex flex-col">
            <div class="p-6 border-b border-slate-100 hidden md:block">
                <h2 class="text-2xl font-bold text-indigo-900 serif-font">Gestão</h2>
                <p class="text-xs text-slate-400" id="user-display">Carregando...</p>
            </div>
            
            <nav class="flex-grow p-2 space-y-1 overflow-y-auto flex md:flex-col flex-row justify-around md:justify-start">
                <button onclick="switchTab('fichas')" class="nav-item w-full text-left px-4 py-3 rounded-lg flex flex-col md:flex-row items-center gap-3 text-slate-600 hover:bg-slate-50 transition-all" data-target="fichas">
                    <i class="fas fa-clipboard-list text-lg"></i> <span class="text-xs md:text-base font-bold">Fichas</span>
                </button>
                <button onclick="switchTab('fechamento')" class="nav-item w-full text-left px-4 py-3 rounded-lg flex flex-col md:flex-row items-center gap-3 text-slate-600 hover:bg-slate-50 transition-all" data-target="fechamento">
                    <i class="fas fa-hand-holding-usd text-lg"></i> <span class="text-xs md:text-base font-bold">Fechamento</span>
                </button>
                <button onclick="switchTab('fluxo')" class="nav-item w-full text-left px-4 py-3 rounded-lg flex flex-col md:flex-row items-center gap-3 text-slate-600 hover:bg-slate-50 transition-all" data-target="fluxo">
                    <i class="fas fa-chart-line text-lg"></i> <span class="text-xs md:text-base font-bold">Fluxo</span>
                </button>
                <button onclick="logout()" class="nav-item w-full text-left px-4 py-3 rounded-lg flex flex-col md:flex-row items-center gap-3 text-red-500 hover:bg-red-50 transition-all md:mt-auto">
                    <i class="fas fa-sign-out-alt text-lg"></i> <span class="text-xs md:text-base font-bold">Sair</span>
                </button>
            </nav>
        </aside>

        <!-- Conteúdo -->
        <main class="flex-grow bg-slate-50 relative overflow-hidden flex flex-col">
            
            <!-- Header Mobile -->
            <header class="md:hidden bg-white p-4 border-b border-slate-200 flex justify-between items-center">
                <span class="font-serif text-xl font-bold text-indigo-900">Fran Kokott</span>
                <span id="mobile-user" class="text-xs text-slate-400">Admin</span>
            </header>

            <div class="flex-grow overflow-y-auto p-4 md:p-8">

                <!-- ABA FICHAS -->
                <section id="tab-fichas" class="tab-content fade-in max-w-6xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl text-indigo-900 font-bold serif-font">Fichas de Atendimento</h2>
                        <button onclick="openModalFicha()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow-md flex items-center gap-2 text-sm font-bold">
                            <i class="fas fa-plus"></i> Nova Ficha
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 text-slate-500 uppercase font-bold border-b border-slate-100">
                                    <tr>
                                        <th class="p-4">Data</th>
                                        <th class="p-4">Cliente</th>
                                        <th class="p-4">Profissional</th>
                                        <th class="p-4">Serviços/Produtos</th>
                                        <th class="p-4 text-right">Total</th>
                                        <th class="p-4 text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-fichas" class="divide-y divide-slate-100">
                                    <!-- JS Render -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- ABA FECHAMENTO -->
                <section id="tab-fechamento" class="tab-content hidden fade-in max-w-6xl mx-auto">
                    <h2 class="text-3xl text-indigo-900 font-bold serif-font mb-6">Relatório de Profissionais</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="painel-fechamento">
                        <!-- JS Render: Cards por profissional -->
                        <div class="text-center col-span-full py-10 text-slate-400">Carregando dados...</div>
                    </div>
                </section>

                <!-- ABA FLUXO -->
                <section id="tab-fluxo" class="tab-content hidden fade-in max-w-4xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-3xl text-indigo-900 font-bold serif-font">Fluxo de Caixa</h2>
                            <p class="text-sm text-slate-500">Movimentações manuais e produtos vendidos</p>
                        </div>
                        <button onclick="openModalFluxo()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg shadow-md flex items-center gap-2 text-sm font-bold">
                            <i class="fas fa-exchange-alt"></i> Novo Lançamento
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between font-bold text-sm">
                            <span>Descrição</span>
                            <div class="flex gap-8">
                                <span>Tipo</span>
                                <span class="w-24 text-right">Valor</span>
                                <span class="w-16 text-center">Ações</span>
                            </div>
                        </div>
                        <div id="lista-fluxo" class="divide-y divide-slate-100">
                            <!-- JS Render -->
                        </div>
                        <div class="p-4 bg-indigo-50 flex justify-between items-center font-bold text-indigo-900 text-lg">
                            <span>Saldo Total</span>
                            <span id="fluxo-total">R$ 0,00</span>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <!-- MODAL FICHA -->
    <div id="modal-ficha" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl my-8 overflow-hidden animate-fade-in">
            <div class="bg-indigo-900 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold font-serif text-lg" id="modal-ficha-title">Nova Ficha</h3>
                <button onclick="closeModal('modal-ficha')" class="hover:text-indigo-200"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="ficha-id"> <!-- ID para edição -->
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Data</label>
                        <input type="date" id="ficha-data" class="input-padrao">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Profissional</label>
                        <select id="ficha-profissional" class="input-padrao bg-white">
                            <option value="Fran">Fran</option>
                            <option value="Gabi">Gabi</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Cliente</label>
                    <input type="text" id="ficha-cliente" class="input-padrao" placeholder="Nome do cliente">
                </div>

                <!-- Itens da Ficha -->
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Itens (Serviços e Produtos)</label>
                    <div id="container-itens-ficha" class="space-y-2 mb-3">
                        <!-- Linhas de itens injetadas via JS -->
                    </div>
                    <button onclick="adicionarLinhaItem()" class="text-xs font-bold text-indigo-600 hover:text-indigo-800 flex items-center gap-1">
                        <i class="fas fa-plus-circle"></i> Adicionar Item
                    </button>
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Observações (Vales/Sinais)</label>
                    <textarea id="ficha-obs" class="input-padrao h-20" placeholder="Ex: Deu um vale de 50 reais..."></textarea>
                    <p class="text-[10px] text-slate-400 mt-1">Dica: Use as palavras "vale", "sinal" ou "adiantamento" e o valor numérico para desconto automático.</p>
                </div>

                <div class="flex justify-between items-center pt-4 border-t border-slate-100">
                    <div>
                        <span class="text-xs text-slate-500 uppercase font-bold">Total da Ficha</span>
                        <p class="text-2xl font-bold text-indigo-900" id="ficha-total-display">R$ 0,00</p>
                    </div>
                    <button onclick="salvarFicha()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform active:scale-95">
                        Salvar Ficha
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL FLUXO -->
    <div id="modal-fluxo" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in">
            <div class="bg-emerald-700 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold font-serif text-lg" id="modal-fluxo-title">Lançamento</h3>
                <button onclick="closeModal('modal-fluxo')" class="hover:text-emerald-200"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="fluxo-id">

                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Tipo</label>
                    <div class="flex gap-2 mt-1">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="fluxo-tipo" value="entrada" class="peer hidden" checked>
                            <div class="text-center py-2 rounded border border-slate-300 peer-checked:bg-green-100 peer-checked:text-green-800 peer-checked:border-green-500 font-bold transition-all">
                                Entrada
                            </div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="fluxo-tipo" value="saida" class="peer hidden">
                            <div class="text-center py-2 rounded border border-slate-300 peer-checked:bg-red-100 peer-checked:text-red-800 peer-checked:border-red-500 font-bold transition-all">
                                Saída
                            </div>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Descrição</label>
                    <input type="text" id="fluxo-desc" class="input-padrao" placeholder="Ex: Conta de Luz, Venda de Shampoo...">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Valor (R$)</label>
                        <input type="number" id="fluxo-valor" step="0.01" class="input-padrao">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Data</label>
                        <input type="date" id="fluxo-data" class="input-padrao">
                    </div>
                </div>

                <button onclick="salvarFluxo()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg mt-2 shadow-md">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, doc, updateDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fran-financeiro';

        // Estado Global
        let currentUser = null;
        let fichasCache = []; // Para relatório e fluxo
        let fluxoCache = [];  // Para movimentações manuais
        let unsubFichas = null;
        let unsubFluxo = null;

        // ========================
        // FUNÇÕES GLOBAIS (UI)
        // ========================
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(btn => {
                if(btn.dataset.target === tab) {
                    btn.classList.add('bg-indigo-50', 'text-indigo-900');
                    btn.classList.remove('text-slate-600');
                } else {
                    btn.classList.remove('bg-indigo-50', 'text-indigo-900');
                    btn.classList.add('text-slate-600');
                }
            });
        };

        window.openModalFicha = (editingId = null) => {
            const modal = document.getElementById('modal-ficha');
            const title = document.getElementById('modal-ficha-title');
            const container = document.getElementById('container-itens-ficha');
            
            // Reset
            document.getElementById('ficha-id').value = '';
            document.getElementById('ficha-cliente').value = '';
            document.getElementById('ficha-obs').value = '';
            document.getElementById('ficha-data').value = new Date().toISOString().split('T')[0];
            container.innerHTML = '';
            
            if (editingId) {
                // MODO EDIÇÃO
                title.textContent = "Editar Ficha";
                const ficha = fichasCache.find(f => f.id === editingId);
                if(ficha) {
                    document.getElementById('ficha-id').value = ficha.id;
                    document.getElementById('ficha-data').value = ficha.data;
                    document.getElementById('ficha-profissional').value = ficha.profissional;
                    document.getElementById('ficha-cliente').value = ficha.cliente;
                    document.getElementById('ficha-obs').value = ficha.obs || '';
                    
                    ficha.itens.forEach(item => {
                        adicionarLinhaItem(item.descricao, item.valor, item.tipo);
                    });
                }
            } else {
                // MODO CRIAÇÃO
                title.textContent = "Nova Ficha";
                adicionarLinhaItem(); // Começa com uma linha vazia
            }

            atualizarTotalFicha();
            modal.classList.remove('hidden');
        };

        window.adicionarLinhaItem = (desc = '', valor = '', tipo = 'servico') => {
            const container = document.getElementById('container-itens-ficha');
            const div = document.createElement('div');
            div.className = 'grid grid-cols-[2fr_1fr_1fr_auto] gap-2 items-center linha-item';
            div.innerHTML = `
                <input type="text" placeholder="Descrição" class="input-padrao text-sm item-desc" value="${desc}">
                <input type="number" placeholder="Valor" class="input-padrao text-sm item-valor" value="${valor}" oninput="atualizarTotalFicha()">
                <select class="input-padrao text-sm item-tipo">
                    <option value="servico" ${tipo === 'servico' ? 'selected' : ''}>Serviço</option>
                    <option value="produto" ${tipo === 'produto' ? 'selected' : ''}>Produto</option>
                </select>
                <button onclick="this.parentElement.remove(); atualizarTotalFicha()" class="text-red-400 hover:text-red-600 px-2"><i class="fas fa-trash"></i></button>
            `;
            container.appendChild(div);
        };

        window.atualizarTotalFicha = () => {
            const inputs = document.querySelectorAll('.item-valor');
            let total = 0;
            inputs.forEach(inp => total += Number(inp.value) || 0);
            document.getElementById('ficha-total-display').textContent = total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        window.openModalFluxo = (editingId = null) => {
            const modal = document.getElementById('modal-fluxo');
            document.getElementById('fluxo-id').value = '';
            document.getElementById('fluxo-desc').value = '';
            document.getElementById('fluxo-valor').value = '';
            document.getElementById('fluxo-data').value = new Date().toISOString().split('T')[0];
            
            if(editingId) {
                const item = fluxoCache.find(f => f.id === editingId);
                if(item) {
                    document.getElementById('fluxo-id').value = item.id;
                    document.getElementById('fluxo-desc').value = item.descricao;
                    document.getElementById('fluxo-valor').value = item.valor;
                    document.getElementById('fluxo-data').value = item.data;
                    const radios = document.getElementsByName('fluxo-tipo');
                    radios.forEach(r => { if(r.value === item.tipo) r.checked = true; });
                }
            }
            
            modal.classList.remove('hidden');
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        // ========================
        // LOGICA DE DADOS
        // ========================

        // 1. SALVAR FICHA (Create & Update)
        window.salvarFicha = async () => {
            if(!currentUser) return;
            const id = document.getElementById('ficha-id').value;
            const cliente = document.getElementById('ficha-cliente').value;
            const profissional = document.getElementById('ficha-profissional').value;
            const data = document.getElementById('ficha-data').value;
            const obs = document.getElementById('ficha-obs').value;

            // Coleta Itens
            const itens = [];
            let total = 0;
            document.querySelectorAll('.linha-item').forEach(row => {
                const desc = row.querySelector('.item-desc').value;
                const valor = Number(row.querySelector('.item-valor').value);
                const tipo = row.querySelector('.item-tipo').value;
                if(desc && valor) {
                    itens.push({ descricao: desc, valor, tipo });
                    total += valor;
                }
            });

            if(!cliente || itens.length === 0) {
                alert("Preencha o cliente e pelo menos um item.");
                return;
            }

            const payload = {
                cliente, profissional, data, obs, itens, total,
                updatedAt: serverTimestamp()
            };

            const btn = document.querySelector('#modal-ficha button:last-child');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            
            try {
                if (id) {
                    // Update
                    await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'fichas', id), payload);
                } else {
                    // Create
                    payload.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'fichas'), payload);
                }
                window.closeModal('modal-ficha');
            } catch(e) {
                console.error(e);
                alert("Erro ao salvar.");
            } finally {
                btn.innerHTML = 'Salvar Ficha';
            }
        };

        // 2. SALVAR FLUXO (Create & Update)
        window.salvarFluxo = async () => {
            if(!currentUser) return;
            const id = document.getElementById('fluxo-id').value;
            const desc = document.getElementById('fluxo-desc').value;
            const valor = Number(document.getElementById('fluxo-valor').value);
            const data = document.getElementById('fluxo-data').value;
            const tipo = document.querySelector('input[name="fluxo-tipo"]:checked').value;

            if(!desc || !valor) return;

            const payload = { descricao: desc, valor, data, tipo, origem: 'manual', updatedAt: serverTimestamp() };
            
            try {
                if(id) {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'fluxo', id), payload);
                } else {
                    payload.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'fluxo'), payload);
                }
                window.closeModal('modal-fluxo');
            } catch(e) {
                console.error(e);
            }
        };

        // 3. LISTENERS & RENDER
        const setupListeners = (uid) => {
            // FICHAS
            const qFichas = query(collection(db, 'artifacts', appId, 'users', uid, 'fichas'));
            unsubFichas = onSnapshot(qFichas, (snap) => {
                fichasCache = [];
                snap.forEach(d => fichasCache.push({ id: d.id, ...d.data() }));
                // Ordenar por data decrescente
                fichasCache.sort((a,b) => new Date(b.data) - new Date(a.data));
                
                renderFichas();
                renderFechamento(); // Recalcula fechamento
                renderFluxo();      // Recalcula fluxo (produtos)
            });

            // FLUXO MANUAL
            const qFluxo = query(collection(db, 'artifacts', appId, 'users', uid, 'fluxo'));
            unsubFluxo = onSnapshot(qFluxo, (snap) => {
                fluxoCache = [];
                snap.forEach(d => fluxoCache.push({ id: d.id, ...d.data() }));
                renderFluxo();
            });
        };

        const renderFichas = () => {
            const tbody = document.getElementById('lista-fichas');
            tbody.innerHTML = fichasCache.map(f => {
                const itensTxt = f.itens.map(i => `${i.descricao} (${i.tipo[0].toUpperCase()})`).join(', ');
                return `
                <tr class="hover:bg-slate-50 border-b border-slate-50 transition-colors">
                    <td class="p-4 text-slate-500">${new Date(f.data).toLocaleDateString('pt-BR')}</td>
                    <td class="p-4 font-bold text-slate-700">${f.cliente}</td>
                    <td class="p-4"><span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs font-bold uppercase">${f.profissional}</span></td>
                    <td class="p-4 text-slate-500 max-w-xs truncate" title="${itensTxt}">${itensTxt}</td>
                    <td class="p-4 text-right font-bold font-mono text-slate-800">R$ ${f.total.toFixed(2)}</td>
                    <td class="p-4 text-center space-x-2">
                        <button onclick="openModalFicha('${f.id}')" class="text-blue-500 hover:text-blue-700 p-2 rounded hover:bg-blue-50 transition" title="Editar">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button onclick="deleteItem('fichas', '${f.id}')" class="text-red-400 hover:text-red-600 p-2 rounded hover:bg-red-50 transition" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
        };

        const renderFechamento = () => {
            const container = document.getElementById('painel-fechamento');
            const profissionais = {};

            fichasCache.forEach(f => {
                if(!profissionais[f.profissional]) profissionais[f.profissional] = { total: 0, servicos: 0, produtos: 0, descontos: 0, fichasCount: 0 };
                
                const prof = profissionais[f.profissional];
                prof.fichasCount++;
                
                // Soma itens
                f.itens.forEach(i => {
                    if(i.tipo === 'servico') prof.servicos += i.valor;
                    if(i.tipo === 'produto') prof.produtos += i.valor;
                });
                prof.total += f.total;

                // Lógica de Vales/Sinais (Regex)
                if(f.obs && /vale|sinal|adiantamento/i.test(f.obs)) {
                    // Tenta extrair número
                    const match = f.obs.match(/(\d+([.,]\d{1,2})?)/); 
                    if(match) {
                        const val = parseFloat(match[0].replace(',', '.'));
                        if(!isNaN(val)) prof.descontos += val;
                    }
                }
            });

            container.innerHTML = Object.keys(profissionais).map(nome => {
                const p = profissionais[nome];
                // Regra de comissão (exemplo: 50% serviço, 10% produto) - Ajuste conforme necessário
                const comissaoServ = p.servicos * 0.50;
                const comissaoProd = p.produtos * 0.10; // Exemplo
                const totalComissao = comissaoServ + comissaoProd;
                const aPagar = totalComissao - p.descontos;

                return `
                <div class="bg-white rounded-xl shadow border border-slate-200 p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fas fa-user-tie text-6xl text-indigo-900"></i></div>
                    <h3 class="text-xl font-bold text-indigo-900 mb-4 border-b border-slate-100 pb-2">${nome}</h3>
                    
                    <div class="space-y-2 text-sm text-slate-600 mb-4">
                        <div class="flex justify-between"><span>Faturamento Total:</span> <span class="font-mono font-bold">R$ ${p.total.toFixed(2)}</span></div>
                        <div class="flex justify-between"><span>Serviços Realizados:</span> <span class="font-mono">R$ ${p.servicos.toFixed(2)}</span></div>
                        <div class="flex justify-between"><span>Produtos Vendidos:</span> <span class="font-mono">R$ ${p.produtos.toFixed(2)}</span></div>
                    </div>

                    <div class="bg-slate-50 p-3 rounded text-sm space-y-1 mb-4">
                        <div class="flex justify-between text-green-700"><span>(+) Comissão (Est. 50%):</span> <span>R$ ${totalComissao.toFixed(2)}</span></div>
                        <div class="flex justify-between text-red-600 font-bold"><span>(-) Vales/Adiantamentos:</span> <span>R$ ${p.descontos.toFixed(2)}</span></div>
                    </div>

                    <div class="flex justify-between items-center pt-2 border-t border-slate-100">
                        <span class="font-bold text-slate-500 uppercase text-xs">A Pagar</span>
                        <span class="text-2xl font-bold text-indigo-900 font-serif">R$ ${aPagar.toFixed(2)}</span>
                    </div>
                </div>
            `}).join('');
        };

        const renderFluxo = () => {
            // 1. Pega itens manuais
            let itensFluxo = [...fluxoCache];

            // 2. Extrai produtos das fichas
            fichasCache.forEach(f => {
                f.itens.forEach(i => {
                    if(i.tipo === 'produto') {
                        itensFluxo.push({
                            id: f.id, // Usa ID da ficha (tratamento especial no edit)
                            descricao: `(Ficha) ${i.descricao} - ${f.cliente}`,
                            valor: i.valor,
                            tipo: 'entrada',
                            data: f.data,
                            origem: 'ficha'
                        });
                    }
                });
            });

            // Ordena
            itensFluxo.sort((a,b) => new Date(b.data) - new Date(a.data));

            const container = document.getElementById('lista-fluxo');
            let saldo = 0;

            container.innerHTML = itensFluxo.map(item => {
                // Calculo saldo
                if(item.tipo === 'entrada') saldo += item.valor;
                else saldo -= item.valor;

                const isFicha = item.origem === 'ficha';
                const icon = item.tipo === 'entrada' ? 'fa-arrow-up text-green-500' : 'fa-arrow-down text-red-500';
                
                return `
                <div class="p-4 flex justify-between items-center hover:bg-slate-50 transition border-b border-slate-50 group">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-xs">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div>
                            <p class="font-bold text-slate-700">${item.descricao}</p>
                            <p class="text-xs text-slate-400">${new Date(item.data).toLocaleDateString('pt-BR')}</p>
                        </div>
                    </div>
                    <div class="flex gap-8 items-center">
                        <span class="text-xs uppercase font-bold ${item.tipo === 'entrada' ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50'} px-2 py-1 rounded">
                            ${item.tipo}
                        </span>
                        <span class="w-24 text-right font-mono font-bold text-slate-800">R$ ${item.valor.toFixed(2)}</span>
                        <div class="w-16 flex justify-end gap-2">
                            ${isFicha 
                                ? `<button onclick="openModalFicha('${item.id}')" title="Editar na Ficha" class="text-indigo-400 hover:text-indigo-600"><i class="fas fa-external-link-alt"></i></button>`
                                : `<button onclick="openModalFluxo('${item.id}')" title="Editar" class="text-blue-400 hover:text-blue-600"><i class="fas fa-pencil-alt"></i></button>
                                   <button onclick="deleteItem('fluxo', '${item.id}')" title="Excluir" class="text-red-300 hover:text-red-500"><i class="fas fa-trash"></i></button>`
                            }
                        </div>
                    </div>
                </div>
            `}).join('');

            const elTotal = document.getElementById('fluxo-total');
            elTotal.textContent = saldo.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            elTotal.className = saldo >= 0 ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
        };

        window.deleteItem = async (col, id) => {
            if(confirm("Deseja realmente excluir?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, col, id));
            }
        };

        window.logout = () => signOut(auth);

        // Inicialização Auth
        onAuthStateChanged(auth, (user) => {
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            if(user) {
                currentUser = user;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.getElementById('user-display').textContent = 'Admin Logado';
                setupListeners(user.uid);
                window.switchTab('fichas');
            } else {
                currentUser = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });

        // Login Click
        document.getElementById('btn-login').addEventListener('click', async () => {
             const status = document.getElementById('auth-status');
             status.textContent = "Entrando...";
             try {
                 if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                 } else {
                    await signInAnonymously(auth);
                 }
             } catch(e) {
                 status.textContent = "Erro no login.";
             }
        });

    </script>
</body>
</html>
